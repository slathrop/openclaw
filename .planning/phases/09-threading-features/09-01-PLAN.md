---
phase: 09-threading-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infra/outbound/message-action-runner.js
  - src/infra/outbound/message-action-runner.threading.test.js
  - src/agents/tools/sessions-spawn-tool.js
  - src/agents/tools/sessions-spawn-threadid.test.js
  - src/agents/subagent-announce.format.test.js
  - src/commands/agent/run-context.js
  - CHANGELOG.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Telegram topic threadId auto-injection has test coverage"
    - "Subagent gateway calls forward threadId/to/accountId from parent"
    - "parseTelegramTarget is used for canonical chatId comparison"
    - "Test file is renamed to sessions-spawn-threadid.test.js"
  artifacts:
    - path: "src/agents/tools/sessions-spawn-threadid.test.js"
      provides: "ThreadId forwarding test coverage"
      contains: "threadId|sessions-spawn"
    - path: "src/infra/outbound/message-action-runner.threading.test.js"
      provides: "Telegram-specific auto-threading tests"
      contains: "telegram|threadId|parseTelegramTarget"
    - path: "src/agents/tools/sessions-spawn-tool.js"
      provides: "ThreadId/to/accountId forwarded to subagent"
      contains: "threadId.*requesterOrigin|accountId.*requesterOrigin"
    - path: "src/commands/agent/run-context.js"
      provides: "currentChannelId fallback from opts.to"
      contains: "currentChannelId.*opts.to"
  key_links:
    - from: "src/infra/outbound/message-action-runner.js"
      to: "src/telegram/targets.js"
      via: "parseTelegramTarget import for canonical chatId comparison"
      pattern: "import.*parseTelegramTarget.*targets"
    - from: "src/agents/tools/sessions-spawn-tool.js"
      to: "gateway call"
      via: "threadId/to/accountId forwarded in callGateway params"
      pattern: "threadId.*requesterOrigin"
---

<objective>
Port Telegram threading completion: test coverage, subagent forwarding, and parseTelegramTarget auto-threading (SYNC-043 to SYNC-045)

Purpose: Complete the Telegram auto-threading feature started in Phase 8, ensuring threadId flows from parent to subagent and topic matching uses canonical parseTelegramTarget
Output: Three commits matching upstream (SYNC-043, SYNC-044, SYNC-045)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-threading-features/09-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run targeted tests: `pnpm vitest run <relevant-test-file>`
5. Commit with --no-verify (wave-level test gate handles full suite): `scripts/committer --no-verify "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-043 - Test coverage for telegram topic threadId auto-injection</name>
  <files>src/infra/outbound/message-action-runner.js, src/infra/outbound/message-action-runner.threading.test.js, src/agents/subagent-announce.format.test.js, src/agents/tools/sessions-spawn-threadid.test.js (NEW, long filename initially)</files>
  <action>
Port commit 6ac5dd2c0 (test: cover telegram topic threadId auto-injection)

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show 6ac5dd2c0 --stat
   git show 6ac5dd2c0
   ```

2. Understand the change:
   - Creates a NEW test file for sessions-spawn threadId forwarding (initially with a long name -- SYNC-045 renames it later)
   - Expands `subagent-announce.format.test.js` with threadId-specific test cases
   - Extends `message-action-runner.threading.test.js` with Telegram-specific auto-threading tests
   - **IMPORTANT**: This commit REMOVES parseTelegramTarget usage from message-action-runner.js and replaces it with string matching. SYNC-045 will restore it. Apply exactly as upstream shows.
   - Modifies `message-action-runner.js` to simplify the auto-threading logic (uses string matching instead of parseTelegramTarget)

3. Apply the equivalent JavaScript changes:
   - Create the new test file (convert from TypeScript: strip type annotations, keep all test logic)
   - Update existing test files with new test cases
   - Modify message-action-runner.js per upstream diff (remove parseTelegramTarget import, use string matching)
   - Ensure all vitest imports and assertions are correct

4. Run targeted tests:
   ```bash
   pnpm vitest run src/infra/outbound/message-action-runner.threading.test.js
   pnpm vitest run src/agents/subagent-announce.format.test.js
   ```

5. Commit with matching message:
   ```bash
   scripts/committer --no-verify "test: cover telegram topic threadId auto-injection" <affected files>
   ```
  </action>
  <verify>`pnpm vitest run src/infra/outbound/message-action-runner.threading.test.js` passes, `git log -1` shows correct message</verify>
  <done>Commit 6ac5dd2c0 ported as SYNC-043, threading test coverage added, parseTelegramTarget temporarily removed</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-044 - Pass threadId/to/accountId from parent to subagent</name>
  <files>src/agents/tools/sessions-spawn-tool.js, src/commands/agent/run-context.js</files>
  <action>
Port commit a13efbe2b (fix: pass threadId/to/accountId from parent to subagent)

1. Read the upstream diff:
   ```bash
   git show a13efbe2b --stat
   git show a13efbe2b
   ```

2. Understand the change (small, ~13 lines total):
   - In `sessions-spawn-tool.js`: Add `to`, `accountId`, and `threadId` from `requesterOrigin` to the callGateway params
   - In `run-context.js`: If `merged.currentChannelId` is empty and `opts.to` is set, populate `currentChannelId` from `opts.to.trim()`
   - These changes ensure subagent gateway calls carry the parent's threading context

3. Apply the equivalent JavaScript changes:
   - In sessions-spawn-tool.js, add to the gateway call params:
     ```javascript
     to: requesterOrigin?.to ?? undefined,
     accountId: requesterOrigin?.accountId ?? undefined,
     threadId: requesterOrigin?.threadId != null
       ? String(requesterOrigin.threadId)
       : undefined,
     ```
   - In run-context.js, add the currentChannelId fallback:
     ```javascript
     if (!merged.currentChannelId && opts.to) {
       const trimmedTo = opts.to.trim()
       if (trimmedTo) {
         merged.currentChannelId = trimmedTo
       }
     }
     ```

4. Run targeted tests:
   ```bash
   pnpm vitest run src/agents/tools/sessions-spawn-threadid.test.js
   ```

5. Commit with matching message:
   ```bash
   scripts/committer --no-verify "fix: pass threadId/to/accountId from parent to subagent" src/agents/tools/sessions-spawn-tool.js src/commands/agent/run-context.js
   ```
  </action>
  <verify>`pnpm vitest run src/agents/tools/sessions-spawn-threadid.test.js` passes (if test file exists from SYNC-043), `git log -1` shows correct message</verify>
  <done>Commit a13efbe2b ported as SYNC-044, subagent gateway calls now forward threadId/to/accountId</done>
</task>

<task type="auto">
  <name>Task 3: SYNC-045 - Telegram topic auto-threading PR merge</name>
  <files>src/infra/outbound/message-action-runner.js, src/infra/outbound/message-action-runner.threading.test.js, src/agents/tools/sessions-spawn-threadid.test.js (renamed), CHANGELOG.md</files>
  <action>
Port commit 01db1dde1 (fix: telegram topic auto-threading (#7235))

1. Read the upstream diff:
   ```bash
   git show 01db1dde1 --stat
   git show 01db1dde1
   ```

2. Understand the change (PR merge commit):
   - **RESTORES parseTelegramTarget** usage in message-action-runner.js (was removed in SYNC-043)
   - The resolveTelegramAutoThreadId function now uses parseTelegramTarget for canonical chatId comparison
   - Renames the test file to the shorter `sessions-spawn-threadid.test.js` name
   - Adds additional test cases: chat mismatch, prefix variations, edge cases
   - Updates CHANGELOG.md with the fix entry
   - Refines variable naming in the threading functions

3. Apply the equivalent JavaScript changes:
   - Restore `parseTelegramTarget` import in message-action-runner.js
   - Update `resolveTelegramAutoThreadId` to use `parseTelegramTarget` for both `to` and `currentChannelId`
   - Rename test file if needed (use `git mv` for the rename)
   - Add new test cases from upstream
   - Update CHANGELOG.md

4. Run targeted tests:
   ```bash
   pnpm vitest run src/infra/outbound/message-action-runner.threading.test.js
   pnpm vitest run src/agents/tools/sessions-spawn-threadid.test.js
   pnpm vitest run src/agents/subagent-announce.format.test.js
   ```

5. Commit with matching message:
   ```bash
   scripts/committer --no-verify "fix: telegram topic auto-threading (#7235)" <affected files>
   ```

**Important:** This commit MUST restore parseTelegramTarget. If the SYNC-043 change was to remove it, this commit adds it back with the improved implementation. Verify parseTelegramTarget is imported and used after this commit.
  </action>
  <verify>`pnpm vitest run src/infra/outbound/message-action-runner.threading.test.js` passes, `grep -q parseTelegramTarget src/infra/outbound/message-action-runner.js` confirms import restored</verify>
  <done>Commit 01db1dde1 ported as SYNC-045, parseTelegramTarget restored for canonical chatId comparison, test file renamed</done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm vitest run src/infra/outbound/message-action-runner.threading.test.js` passes
3. `pnpm vitest run src/agents/tools/sessions-spawn-threadid.test.js` passes
4. `pnpm vitest run src/agents/subagent-announce.format.test.js` passes
5. `grep parseTelegramTarget src/infra/outbound/message-action-runner.js` shows the import is present
6. Commits match upstream messages:
   - test: cover telegram topic threadId auto-injection
   - fix: pass threadId/to/accountId from parent to subagent
   - fix: telegram topic auto-threading (#7235)
</verification>

<success_criteria>
- 3 commits created matching SYNC-043, SYNC-044, SYNC-045
- Telegram auto-threading uses parseTelegramTarget (final state after all 3)
- Subagent gateway calls forward threadId/to/accountId
- currentChannelId populated from opts.to as fallback
- All threading-related tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-threading-features/09-01-SUMMARY.md`
</output>
