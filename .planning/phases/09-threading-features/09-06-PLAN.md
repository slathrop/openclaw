---
phase: 09-threading-features
plan: 06
type: execute
wave: 3
depends_on: ["09-04"]
files_modified:
  - src/agents/pi-embedded-runner/run.js
  - src/agents/pi-embedded-runner/run.overflow-compaction.test.js
  - src/agents/pi-embedded-helpers/errors.js
  - src/agents/pi-embedded-helpers/helpers.js
  - src/agents/pi-embedded-helpers.formatassistanterrortext.test.js
  - skills/qr-code/SKILL.md
  - skills/qr-code/qr_generate.py
  - skills/qr-code/qr_read.py
  - CHANGELOG.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Compaction allows up to 3 retry attempts on context overflow"
    - "Billing errors show user-friendly message"
    - "isBillingErrorMessage detects billing-related API errors"
    - "QR code skill is reverted (directory removed)"
  artifacts:
    - path: "src/agents/pi-embedded-runner/run.js"
      provides: "Multiple compaction retry attempts (max 3)"
      contains: "overflowCompaction.*3|compaction.*attempt|compaction.*count"
    - path: "src/agents/pi-embedded-helpers/errors.js"
      provides: "Billing error detection and user-friendly message"
      contains: "BILLING_ERROR_USER_MESSAGE|isBillingErrorMessage|isBillingAssistantError"
    - path: "src/agents/pi-embedded-runner/run.overflow-compaction.test.js"
      provides: "Overflow compaction retry test coverage"
      contains: "retry|attempt|overflow"
    - path: "src/agents/pi-embedded-helpers.formatassistanterrortext.test.js"
      provides: "Billing error format test coverage"
      contains: "billing|BILLING"
  key_links:
    - from: "src/agents/pi-embedded-runner/run.js"
      to: "src/agents/pi-embedded-helpers/errors.js"
      via: "isBillingAssistantError import for error handling"
      pattern: "import.*isBilling.*errors"
    - from: "src/agents/pi-embedded-helpers/helpers.js"
      to: "src/agents/pi-embedded-helpers/errors.js"
      via: "formatAssistantErrorText calls isBillingErrorMessage"
      pattern: "isBillingErrorMessage"
---

<objective>
Port compaction multiple retries, billing error detection, and QR code skill revert (SYNC-061 to SYNC-063)

Purpose: Allow multiple compaction retries on context overflow, add clear billing error messages, and revert the QR code skill
Output: Three commits matching upstream (SYNC-061, SYNC-062, SYNC-063)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-threading-features/09-RESEARCH.md
@.planning/phases/09-threading-features/09-04-SUMMARY.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run targeted tests: `pnpm vitest run <relevant-test-file>`
5. Commit with --no-verify (wave-level test gate handles full suite): `scripts/committer --no-verify "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-061 - Allow multiple compaction retries on context overflow</name>
  <files>src/agents/pi-embedded-runner/run.js, src/agents/pi-embedded-runner/run.overflow-compaction.test.js</files>
  <action>
Port commit 4e1a7cd60 (fix: allow multiple compaction retries on context overflow (#8928))

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show 4e1a7cd60 --stat
   git show 4e1a7cd60
   ```

2. Understand the change (MEDIUM complexity):
   - Changes `overflowCompactionAttempted` from a boolean to a numeric counter
   - Instead of one-and-done compaction, allows up to 3 attempts before giving up
   - Updates the overflow handler logic: increment counter instead of setting to true, check counter < 3
   - Adds diagnostic logging for each compaction attempt
   - Updates test file with new test cases for multiple retries
   - **NOTE**: The test diff adds `isBillingAssistantError: vi.fn(() => false)` to the mock. This is for SYNC-062 which comes next. The mock works fine even though the source function doesn't exist yet.

3. Apply the equivalent JavaScript changes to run.js:
   - Find `overflowCompactionAttempted` (boolean) and change to a counter (number, starts at 0)
   - Update condition: `if (counter < 3)` instead of `if (!attempted)`
   - Increment: `counter++` after each attempt
   - Add diagnostic logging

4. Update test file:
   - Convert new test cases from TypeScript
   - Add the `isBillingAssistantError: vi.fn(() => false)` to the mock (preemptive for SYNC-062)

5. Run tests and commit:
   ```bash
   pnpm vitest run src/agents/pi-embedded-runner/run.overflow-compaction.test.js
   scripts/committer --no-verify "fix: allow multiple compaction retries on context overflow (#8928)" src/agents/pi-embedded-runner/run.js src/agents/pi-embedded-runner/run.overflow-compaction.test.js
   ```
  </action>
  <verify>`pnpm vitest run src/agents/pi-embedded-runner/run.overflow-compaction.test.js` passes, `git log -1` shows correct message</verify>
  <done>Commit 4e1a7cd60 ported as SYNC-061, compaction allows up to 3 retry attempts</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-062 and SYNC-063 - Billing error detection + QR revert</name>
  <files>src/agents/pi-embedded-helpers/errors.js, src/agents/pi-embedded-runner/run.js, src/agents/pi-embedded-helpers/helpers.js, src/agents/pi-embedded-helpers.formatassistanterrortext.test.js, CHANGELOG.md, skills/qr-code/ (DELETE)</files>
  <action>
Port two commits:
- SYNC-062: d4c560853 (fix(errors): show clear billing error (#8391))
- SYNC-063: 6b7d3c306 (Revert "feat(skills): add QR code skill (#8817)")

**SYNC-062 (MEDIUM complexity, 4 files):**

1. Read the upstream diff:
   ```bash
   git show d4c560853 --stat
   git show d4c560853
   ```

2. Understand the change:
   - Adds `BILLING_ERROR_USER_MESSAGE` constant to `errors.js` (user-friendly billing error text)
   - Adds `isBillingErrorMessage(raw)` function to detect billing-related error strings
   - Adds `isBillingAssistantError(error)` function that checks both raw message and error metadata
   - In `helpers.js` (`formatAssistantErrorText`): adds early return using `isBillingErrorMessage` check before the generic error fallthrough
   - In `run.js`: imports `isBillingAssistantError` and uses it in the error handling path
   - Adds 3 test cases to the formatAssistantErrorText test file

3. Apply changes:
   - Add constants and functions to errors.js (convert from TypeScript)
   - Update helpers.js with the billing error check
   - Update run.js with the isBillingAssistantError import and usage
   - Add test cases
   - Update CHANGELOG

4. Run tests and commit:
   ```bash
   pnpm vitest run src/agents/pi-embedded-helpers.formatassistanterrortext.test.js
   pnpm vitest run src/agents/pi-embedded-runner/run.overflow-compaction.test.js
   scripts/committer --no-verify "fix(errors): show clear billing error (#8391)" src/agents/pi-embedded-helpers/errors.js src/agents/pi-embedded-runner/run.js src/agents/pi-embedded-helpers/helpers.js src/agents/pi-embedded-helpers.formatassistanterrortext.test.js CHANGELOG.md
   ```

**SYNC-063 (LOW complexity, exact revert of SYNC-056):**

1. Read the upstream diff:
   ```bash
   git show 6b7d3c306 --stat
   git show 6b7d3c306
   ```

2. This is a mechanical revert of SYNC-056 (QR code skill):
   - Remove `skills/qr-code/` directory entirely (SKILL.md, qr_generate.py, qr_read.py)
   - Revert any CLAUDE.md changes from SYNC-056 (trailing newline)

3. Apply:
   ```bash
   rm -rf skills/qr-code
   ```
   Also revert CLAUDE.md if it was changed in SYNC-056.

4. Commit:
   ```bash
   scripts/committer --no-verify 'Revert "feat(skills): add QR code skill (#8817)"' skills/qr-code CLAUDE.md
   ```
   (Only include CLAUDE.md if it was changed)

   Note: For the revert commit message with quotes, you may need to use the committer script carefully. Check that `scripts/committer` handles embedded quotes, or use single-quote wrapping.
  </action>
  <verify>`pnpm vitest run src/agents/pi-embedded-helpers.formatassistanterrortext.test.js` passes, `! test -d skills/qr-code` confirms QR skill directory removed, `grep -c BILLING_ERROR_USER_MESSAGE src/agents/pi-embedded-helpers/errors.js` shows the constant exists</verify>
  <done>SYNC-062 ported (billing error detection), SYNC-063 ported (QR skill reverted)</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm vitest run src/agents/pi-embedded-runner/run.overflow-compaction.test.js` passes
3. `pnpm vitest run src/agents/pi-embedded-helpers.formatassistanterrortext.test.js` passes
4. Compaction retries up to 3 times (counter-based, not boolean)
5. Billing errors produce user-friendly message
6. QR code skill directory does NOT exist
7. Commits match upstream messages:
   - fix: allow multiple compaction retries on context overflow (#8928)
   - fix(errors): show clear billing error (#8391)
   - Revert "feat(skills): add QR code skill (#8817)"
</verification>

<success_criteria>
- 3 commits created matching SYNC-061, SYNC-062, SYNC-063
- Compaction allows multiple retries (up to 3)
- Billing errors show clear user-friendly message
- QR code skill cleanly reverted
- All compaction and error handling tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-threading-features/09-06-SUMMARY.md`
</output>
