---
phase: 09-threading-features
plan: 05
type: execute
wave: 3
depends_on: ["09-03"]
files_modified:
  - src/infra/runtime-guard.js
  - src/infra/runtime-guard.test.js
  - src/daemon/runtime-paths.test.js
  - src/auto-reply/reply/session.js
  - src/commands/model-allowlist.js
  - src/commands/model-allowlist.test.js
  - src/commands/openai-model-default.js
  - src/commands/openai-model-default.test.js
  - src/commands/auth-choice.default-model.test.js
  - src/commands/onboard-non-interactive.openai-api-key.test.js
  - src/agents/defaults.js
  - src/agents/model-selection.js
  - src/agents/tools/image-tool.js
  - src/agents/tools/image-tool.test.js
  - src/config/defaults.js
  - src/config/model-alias-defaults.test.js
  - docs/**
  - package.json
  - pnpm-lock.yaml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Minimum Node.js version is 22.12.0"
    - "Stale token metrics cleared on /new and /reset"
    - "Model allowlist normalization works correctly"
    - "OpenAI model defaults are configurable"
    - "Docs reference claude-opus-4-6 (not claude-opus-4-5)"
  artifacts:
    - path: "src/infra/runtime-guard.js"
      provides: "Node.js 22.12.0 minimum version check"
      contains: "22\\.12\\.0|MIN_NODE"
    - path: "src/infra/runtime-guard.test.js"
      provides: "Runtime guard test coverage for 22.12.0"
      contains: "22\\.12\\.0"
    - path: "src/auto-reply/reply/session.js"
      provides: "Stale token metrics clearing"
      contains: "token.*metrics|clear.*stale"
    - path: "src/commands/model-allowlist.js"
      provides: "Model allowlist normalization"
      contains: "allowlist|normalize"
    - path: "src/commands/openai-model-default.js"
      provides: "OpenAI model default configuration"
      contains: "openai|model.*default"
  key_links:
    - from: "src/commands/model-allowlist.js"
      to: "src/agents/model-selection.js"
      via: "model allowlist used in selection"
      pattern: "allowlist|normalize"
    - from: "src/commands/openai-model-default.js"
      to: "src/config/defaults.js"
      via: "OpenAI model default integrated with config"
      pattern: "openai.*default|model.*default"
---

<objective>
Port runtime guard bump, session token clearing, and large workspace update (SYNC-058 to SYNC-060)

Purpose: Bump Node.js minimum to 22.12.0, clear stale token metrics, and apply workspace-wide model allowlist normalization + OpenAI defaults + docs updates
Output: Three commits matching upstream (SYNC-058, SYNC-059, SYNC-060)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-threading-features/09-RESEARCH.md
@.planning/phases/09-threading-features/09-03-SUMMARY.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run targeted tests: `pnpm vitest run <relevant-test-file>`
5. Commit with --no-verify (wave-level test gate handles full suite): `scripts/committer --no-verify "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-058 and SYNC-059 - Runtime guard bump + stale token metrics</name>
  <files>src/infra/runtime-guard.js, src/infra/runtime-guard.test.js, src/daemon/runtime-paths.test.js, src/auto-reply/reply/session.js</files>
  <action>
Port two commits:
- SYNC-058: 2ca78a8ae (fix(runtime): bump minimum Node.js version to 22.12.0 (#5370))
- SYNC-059: 93b450349 (fix: clear stale token metrics on /new and /reset (#8929))

**SYNC-058 (LOW complexity, 3 files):**

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show 2ca78a8ae --stat
   git show 2ca78a8ae
   ```

2. Understand the change:
   - Updates `MIN_NODE_VERSION` from `22.0.0` to `22.12.0` in runtime-guard.js
   - Updates test expectations in runtime-guard.test.js and runtime-paths.test.js
   - The bump aligns with Matrix plugin requirements

3. Apply changes:
   - Update the version constant in runtime-guard.js
   - Update test expectations to use 22.12.0
   - This is a straightforward version number change

4. Run tests and commit:
   ```bash
   pnpm vitest run src/infra/runtime-guard.test.js
   pnpm vitest run src/daemon/runtime-paths.test.js
   scripts/committer --no-verify "fix(runtime): bump minimum Node.js version to 22.12.0 (#5370)" src/infra/runtime-guard.js src/infra/runtime-guard.test.js src/daemon/runtime-paths.test.js
   ```

**SYNC-059 (LOW complexity, 1 file):**

1. Read the upstream diff:
   ```bash
   git show 93b450349 --stat
   git show 93b450349
   ```

2. Understand the change:
   - Clears stale token metrics when user starts a new session (/new) or resets (/reset)
   - Adds diagnostic logging for token metric clearing
   - The change is in `src/auto-reply/reply/session.js`

3. Apply changes:
   - Add token metrics clearing logic where /new and /reset are handled
   - Add diagnostic log statement

4. Commit:
   ```bash
   scripts/committer --no-verify "fix: clear stale token metrics on /new and /reset (#8929)" src/auto-reply/reply/session.js
   ```
  </action>
  <verify>`pnpm vitest run src/infra/runtime-guard.test.js` passes, `pnpm vitest run src/daemon/runtime-paths.test.js` passes, `grep -c '22.12.0' src/infra/runtime-guard.js` shows the bump</verify>
  <done>SYNC-058 and SYNC-059 ported: Node.js minimum at 22.12.0, stale token metrics cleared on /new and /reset</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-060 - Apply local workspace updates</name>
  <files>src/commands/model-allowlist.js (NEW), src/commands/model-allowlist.test.js (NEW), src/commands/openai-model-default.js (NEW), src/commands/openai-model-default.test.js (NEW), src/commands/auth-choice.default-model.test.js (NEW), src/commands/onboard-non-interactive.openai-api-key.test.js (NEW), plus ~40 existing source files, ~20 docs files, package.json, pnpm-lock.yaml</files>
  <action>
Port commit 462905440 (chore: apply local workspace updates (#9911))

**This is the HIGHEST complexity commit in Phase 9 (72 files changed).**

1. Read the upstream diff:
   ```bash
   git show 462905440 --stat
   git show 462905440
   ```

2. Understand the change:
   - Creates 5-6 NEW TypeScript files that need JavaScript conversion:
     - `src/commands/model-allowlist.ts` -> `.js` (model allowlist normalization logic)
     - `src/commands/openai-model-default.ts` -> `.js` (OpenAI model default configuration)
     - `src/commands/openai-model-default.test.ts` -> `.js`
     - `src/commands/auth-choice.default-model.test.ts` -> `.js`
     - `src/commands/onboard-non-interactive.openai-api-key.test.ts` -> `.js`
     - Possibly `src/commands/model-allowlist.test.ts` -> `.js`
   - Modifies ~40 existing source files with model reference updates (claude-opus-4-5 -> claude-opus-4-6)
   - Updates ~20 docs files with model name changes
   - May bump package.json dependencies (check overlap with SYNC-049)
   - Updates Swift/macOS files (copy as-is, no JS conversion)

3. **Approach for this large commit:**
   a. First get the full file list: `git show 462905440 --stat`
   b. Group changes by type:
      - NEW files: convert .ts to .js using esbuild pattern
      - Model rename changes: find-and-replace claude-opus-4-5 with claude-opus-4-6
      - Docs changes: apply directly
      - Swift/macOS: copy as-is
      - package.json/lockfile: apply deps changes, run `pnpm install`
   c. For files ALREADY modified by SYNC-049, verify the final state matches upstream after this commit
   d. For extensions (copilot-proxy, tlon): check if they exist in JS repo; if not, skip those hunks

4. Convert each new .ts file to JavaScript:
   - Strip type annotations
   - Add JSDoc where helpful
   - Keep import paths with .js extension
   - Ensure exports match upstream

5. After all changes, run `pnpm install` if package.json changed, then:
   ```bash
   pnpm vitest run src/config/model-alias-defaults.test.js
   pnpm vitest run src/agents/model-selection.test.js
   pnpm vitest run src/agents/tools/image-tool.test.js
   pnpm vitest run src/commands/openai-model-default.test.js
   pnpm vitest run src/commands/auth-choice.default-model.test.js
   ```

6. Commit:
   ```bash
   scripts/committer --no-verify "chore: apply local workspace updates (#9911)" <all affected files>
   ```

**Pitfall warnings:**
- Some files were already modified by SYNC-049. Check that you're applying only the DELTA from SYNC-060, not re-applying SYNC-049 changes.
- Extensions may not exist in the JS repo. Skip those hunks.
- The docs model name updates are numerous but mechanical (find-replace).
- Run `pnpm install` after package.json changes to regenerate lockfile.
  </action>
  <verify>`pnpm vitest run src/config/model-alias-defaults.test.js` passes, `pnpm vitest run src/commands/openai-model-default.test.js` passes, `ls src/commands/model-allowlist.js src/commands/openai-model-default.js` confirms new files exist, `grep -c claude-opus-4-6 src/config/defaults.js` shows updated references</verify>
  <done>Commit 462905440 ported as SYNC-060: model allowlist normalization, OpenAI defaults, docs model name updates, workspace deps sync</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm vitest run src/infra/runtime-guard.test.js` passes
3. `pnpm vitest run src/config/model-alias-defaults.test.js` passes
4. `pnpm vitest run src/commands/openai-model-default.test.js` passes
5. Runtime guard checks for Node.js >= 22.12.0
6. New model allowlist and OpenAI default files exist
7. Docs reference claude-opus-4-6
8. Commits match upstream messages:
   - fix(runtime): bump minimum Node.js version to 22.12.0 (#5370)
   - fix: clear stale token metrics on /new and /reset (#8929)
   - chore: apply local workspace updates (#9911)
</verification>

<success_criteria>
- 3 commits created matching SYNC-058, SYNC-059, SYNC-060
- Node.js minimum at 22.12.0
- Token metrics cleared on /new and /reset
- Model allowlist and OpenAI defaults infrastructure added
- All model-related tests pass
- Docs updated with correct model names
</success_criteria>

<output>
After completion, create `.planning/phases/09-threading-features/09-05-SUMMARY.md`
</output>
