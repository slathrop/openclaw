---
phase: 09-threading-features
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - src/agents/compaction.js
  - src/agents/compaction.test.js
  - src/agents/tools/cron-tool.js
  - src/agents/tools/cron-tool.test.js
  - src/cron/service/timer.js
  - .gitignore
  - .github/ISSUE_TEMPLATE/config.yml
  - skills/qr-code/SKILL.md
  - skills/qr-code/qr_generate.py
  - skills/qr-code/qr_read.py
  - AGENTS.md
  - CHANGELOG.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Orphaned tool_results are removed during compaction"
    - "Cron delivery inference works from session key"
    - "Cron timer does not use .unref()"
    - "Agent credentials patterns in .gitignore"
    - "QR code skill directory exists (will be reverted in Plan 06)"
  artifacts:
    - path: "src/agents/compaction.js"
      provides: "Orphaned tool_result repair during compaction"
      contains: "repairToolUseResultPairing"
    - path: "src/agents/tools/cron-tool.js"
      provides: "Cron delivery inference from session key"
      contains: "inferDeliveryFromSessionKey|parseAgentSessionKey"
    - path: "src/agents/tools/cron-tool.test.js"
      provides: "Cron delivery inference test coverage"
      contains: "inferDelivery|delivery"
    - path: "src/cron/service/timer.js"
      provides: "Timer without .unref()"
  key_links:
    - from: "src/agents/compaction.js"
      to: "src/agents/session-transcript-repair.js"
      via: "repairToolUseResultPairing import"
      pattern: "import.*repairToolUseResultPairing.*session-transcript-repair"
    - from: "src/agents/tools/cron-tool.js"
      to: "src/agents/sessions/session-key-utils.js"
      via: "parseAgentSessionKey import for delivery inference"
      pattern: "import.*parseAgentSessionKey"
---

<objective>
Port compaction orphan repair, cron scheduling fixes, and trivial chores (SYNC-052 to SYNC-057)

Purpose: Fix compaction handling of orphaned tool_results, fix cron delivery inference and timer behavior, apply trivial chores (gitignore, issue template, QR skill, AGENTS.md)
Output: Six commits matching upstream (SYNC-052 through SYNC-057)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-threading-features/09-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run targeted tests: `pnpm vitest run <relevant-test-file>`
5. Commit with --no-verify (wave-level test gate handles full suite): `scripts/committer --no-verify "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-052 and SYNC-053 - Compaction orphan repair + cron fixes</name>
  <files>src/agents/compaction.js, src/agents/compaction.test.js, src/agents/tools/cron-tool.js, src/agents/tools/cron-tool.test.js, src/cron/service/timer.js, CHANGELOG.md</files>
  <action>
Port two commits:
- SYNC-052: f32eeae3b (fix: remove orphaned tool_results during compaction)
- SYNC-053: 821520a05 (fix cron scheduling and reminder delivery regressions (#9733))

**SYNC-052 (MEDIUM complexity, 3 files):**

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show f32eeae3b --stat
   git show f32eeae3b
   ```

2. Understand the change:
   - Imports `repairToolUseResultPairing` from `session-transcript-repair.js` into `compaction.js`
   - After chunk drops during compaction, calls `repairToolUseResultPairing(flatRest)` to remove orphaned tool_results
   - Adds 3 test cases to compaction.test.js
   - Updates CHANGELOG

3. Apply changes:
   - Add the import of `repairToolUseResultPairing` to compaction.js
   - Add the repair call after chunk drops: uses `repairReport.messages` and `repairReport.droppedOrphanCount`
   - Convert test TypeScript to JavaScript (strip types)
   - Update CHANGELOG

4. Run tests and commit:
   ```bash
   pnpm vitest run src/agents/compaction.test.js
   scripts/committer --no-verify "fix: remove orphaned tool_results during compaction" src/agents/compaction.js src/agents/compaction.test.js CHANGELOG.md
   ```

**SYNC-053 (HIGH complexity, 4 files, 191 additions):**

1. Read the upstream diff:
   ```bash
   git show 821520a05 --stat
   git show 821520a05
   ```

2. Understand the change:
   - Adds `inferDeliveryFromSessionKey` function (~66 lines) to `cron-tool.js`
   - This function parses the agent session key to determine delivery target (channel, to address, mode)
   - Uses `parseAgentSessionKey` from `sessions/session-key-utils.js` and `stripThreadSuffixFromSessionKey`
   - Adds ~93 lines of tests to cron-tool.test.js
   - Removes `state.timer.unref?.()` from `src/cron/service/timer.js` (single line removal -- critical fix)
   - Updates CHANGELOG

3. Apply changes:
   - Convert inferDeliveryFromSessionKey to JavaScript (strip types, add JSDoc for the return shape)
   - Verify `parseAgentSessionKey` exists in local JS codebase: `grep -r parseAgentSessionKey src/agents/sessions/`
   - Verify `stripThreadSuffixFromSessionKey` exists: `grep -r stripThreadSuffix src/`
   - Add test cases (convert from TypeScript)
   - **CRITICAL**: Remove `state.timer.unref?.()` from timer.js
   - Update CHANGELOG

4. Run tests and commit:
   ```bash
   pnpm vitest run src/agents/tools/cron-tool.test.js
   scripts/committer --no-verify "fix cron scheduling and reminder delivery regressions (#9733)" src/agents/tools/cron-tool.js src/agents/tools/cron-tool.test.js src/cron/service/timer.js CHANGELOG.md
   ```
  </action>
  <verify>`pnpm vitest run src/agents/compaction.test.js` passes, `pnpm vitest run src/agents/tools/cron-tool.test.js` passes, `grep -c repairToolUseResultPairing src/agents/compaction.js` shows import exists, `grep -c unref src/cron/service/timer.js` shows 0 (removed)</verify>
  <done>SYNC-052 and SYNC-053 ported: compaction handles orphaned tool_results, cron delivery inference works, timer .unref() removed</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-054 to SYNC-057 - Trivial chores (gitignore, docs, QR skill, AGENTS.md)</name>
  <files>.gitignore, .github/ISSUE_TEMPLATE/config.yml, skills/qr-code/SKILL.md (NEW), skills/qr-code/qr_generate.py (NEW), skills/qr-code/qr_read.py (NEW), CLAUDE.md, AGENTS.md</files>
  <action>
Port four trivial commits:
- SYNC-054: d6c088910 (chore: add agent credentials to gitignore (#9874))
- SYNC-055: 7159d3b25 (Docs: escape hash symbol in help channel names (#9695))
- SYNC-056: ad13c265b (feat(skills): add QR code skill (#8817))
- SYNC-057: db8e9b37c (chore(agentsmd): add tsgo command to AGENTS.md (#9894))

**SYNC-054 (LOW, 1 file):**
1. `git show d6c088910 --stat && git show d6c088910`
2. Add agent credential patterns to .gitignore (e.g., `agents/*/credentials*` or similar)
3. Commit:
   ```bash
   scripts/committer --no-verify "chore: add agent credentials to gitignore (#9874)" .gitignore
   ```

**SYNC-055 (LOW, 1 file):**
1. `git show 7159d3b25 --stat && git show 7159d3b25`
2. Escape hash symbols in `.github/ISSUE_TEMPLATE/config.yml` help channel names
3. Commit:
   ```bash
   scripts/committer --no-verify "Docs: escape hash symbol in help channel names (#9695)" .github/ISSUE_TEMPLATE/config.yml
   ```

**SYNC-056 (LOW, 4 files -- will be REVERTED by SYNC-063 in Plan 06):**
1. `git show ad13c265b --stat && git show ad13c265b`
2. Create `skills/qr-code/` directory with SKILL.md, qr_generate.py, qr_read.py
3. Also check for CLAUDE.md changes (trailing newline fix on symlink)
4. No JS conversion needed (Python scripts + Markdown)
5. Commit:
   ```bash
   scripts/committer --no-verify "feat(skills): add QR code skill (#8817)" skills/qr-code/ CLAUDE.md
   ```
   (Only include CLAUDE.md if upstream diff shows changes to it)

**SYNC-057 (LOW, 1 file):**
1. `git show db8e9b37c --stat && git show db8e9b37c`
2. Add tsgo command entry to AGENTS.md
3. Commit:
   ```bash
   scripts/committer --no-verify "chore(agentsmd): add tsgo command to AGENTS.md (#9894)" AGENTS.md
   ```
  </action>
  <verify>`git log -4 --oneline` shows four commits in correct order, `ls skills/qr-code/` shows QR skill files exist, `grep -c tsgo AGENTS.md` shows entry added</verify>
  <done>SYNC-054 through SYNC-057 ported: gitignore updated, issue template fixed, QR skill added, AGENTS.md updated</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `git log -6 --oneline` shows six commits in correct order
2. `pnpm vitest run src/agents/compaction.test.js` passes
3. `pnpm vitest run src/agents/tools/cron-tool.test.js` passes
4. Compaction imports repairToolUseResultPairing
5. Cron tool has inferDeliveryFromSessionKey function
6. Timer.js no longer has .unref() call
7. QR skill directory exists (temporary -- reverted in Plan 06)
8. Commits match upstream messages:
   - fix: remove orphaned tool_results during compaction
   - fix cron scheduling and reminder delivery regressions (#9733)
   - chore: add agent credentials to gitignore (#9874)
   - Docs: escape hash symbol in help channel names (#9695)
   - feat(skills): add QR code skill (#8817)
   - chore(agentsmd): add tsgo command to AGENTS.md (#9894)
</verification>

<success_criteria>
- 6 commits created matching SYNC-052 through SYNC-057
- Compaction handles orphaned tool_results
- Cron delivery inference works from session key
- Cron timer does not use .unref()
- All trivial chores applied correctly
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-threading-features/09-04-SUMMARY.md`
</output>
