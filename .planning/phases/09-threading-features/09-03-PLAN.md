---
phase: 09-threading-features
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - src/agents/defaults.js
  - src/agents/cli-backends.js
  - src/agents/live-model-filter.js
  - src/agents/model-selection.js
  - src/agents/model-selection.test.js
  - src/agents/tools/image-tool.test.js
  - src/config/defaults.js
  - src/config/model-alias-defaults.test.js
  - src/commands/configure.gateway-auth.js
  - src/commands/model-picker.js
  - src/commands/onboard-auth.js
  - package.json
  - pnpm-lock.yaml
  - CHANGELOG.md
  - src/feishu/docs.js
  - src/feishu/docs.test.js
  - src/feishu/reactions.js
  - src/feishu/typing.js
  - src/feishu/user.js
  - src/feishu/message.js
  - src/feishu/download.js
  - src/feishu/send.js
  - src/feishu/monitor.js
  - src/feishu/probe.js
  - docs/channels/feishu.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Claude Opus 4.6 is available in model selection and defaults"
    - "pi-ai dependencies bumped to 0.52.0"
    - "Feishu channel supports docs, reactions, typing, and user lookup"
    - "Feishu mention gating is tightened"
    - "Model alias tests reference claude-opus-4-6"
  artifacts:
    - path: "src/agents/defaults.js"
      provides: "Claude Opus 4.6 as default model"
      contains: "claude-opus-4-6|opus-4.6"
    - path: "src/config/defaults.js"
      provides: "Updated model defaults"
      contains: "claude-opus-4-6"
    - path: "src/feishu/docs.js"
      provides: "Feishu document support"
      contains: "docs|feishu"
    - path: "src/feishu/docs.test.js"
      provides: "Feishu docs test coverage"
      contains: "describe.*feishu|docs"
    - path: "src/feishu/reactions.js"
      provides: "Feishu reaction support"
    - path: "src/feishu/typing.js"
      provides: "Feishu typing indicator support"
    - path: "src/feishu/user.js"
      provides: "Feishu user lookup support"
  key_links:
    - from: "src/agents/model-selection.js"
      to: "src/config/defaults.js"
      via: "model ID references"
      pattern: "claude-opus-4-6"
    - from: "src/feishu/message.js"
      to: "src/feishu/docs.js"
      via: "import for document handling"
      pattern: "import.*docs"
---

<objective>
Port Claude Opus 4.6 model catalog update and Feishu channel expansion (SYNC-049 to SYNC-051)

Purpose: Add Claude Opus 4.6 to all model selection surfaces with pi-ai dep bump, and expand Feishu with docs/reactions/typing/user support
Output: Three commits matching upstream (SYNC-049, SYNC-050, SYNC-051)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-threading-features/09-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run targeted tests: `pnpm vitest run <relevant-test-file>`
5. Commit with --no-verify (wave-level test gate handles full suite): `scripts/committer --no-verify "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-049 - Add Claude Opus 4.6 to built-in model catalog</name>
  <files>src/agents/defaults.js, src/agents/cli-backends.js, src/agents/live-model-filter.js, src/agents/model-selection.js, src/agents/model-selection.test.js, src/agents/tools/image-tool.test.js, src/config/defaults.js, src/config/model-alias-defaults.test.js, src/commands/configure.gateway-auth.js, src/commands/model-picker.js, src/commands/onboard-auth.js, package.json, pnpm-lock.yaml, CHANGELOG.md</files>
  <action>
Port commit eb80b9acb (feat: add Claude Opus 4.6 to built-in model catalog (#9853))

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show eb80b9acb --stat
   git show eb80b9acb
   ```

2. Understand the change (HIGH complexity, ~16 files):
   - Adds `claude-opus-4-6` as the new default Anthropic model across all selection surfaces
   - Updates model aliases (opus-4.5 -> opus-4.6 or adds opus-4.6 as new entry)
   - Bumps pi-ai dependencies from 0.51.6 to 0.52.0 in package.json:
     - @mariozechner/pi-tokenizer, @mariozechner/pi-mono, @mariozechner/pi-ai, @mariozechner/pi-conversation
   - Updates test expectations to reference claude-opus-4-6
   - Changes model picker, onboarding auth, gateway auth to show/use the new model
   - May update image tool test expectations for default model references

3. Apply the equivalent JavaScript changes:
   - Update all model ID references: `claude-opus-4-5` -> `claude-opus-4-6` where appropriate
   - Some files may ADD claude-opus-4-6 alongside opus-4-5 (not replace)
   - Update package.json dependency versions (the 4 pi-ai packages)
   - Run `pnpm install` to regenerate pnpm-lock.yaml
   - Update test expectations for new model IDs
   - Add CHANGELOG entry

4. **IMPORTANT**: After updating package.json, run:
   ```bash
   pnpm install
   ```
   This regenerates pnpm-lock.yaml. Do NOT try to manually patch the lockfile.

5. Run targeted tests:
   ```bash
   pnpm vitest run src/config/model-alias-defaults.test.js
   pnpm vitest run src/agents/model-selection.test.js
   pnpm vitest run src/agents/tools/image-tool.test.js
   ```

6. Commit:
   ```bash
   scripts/committer --no-verify "feat: add Claude Opus 4.6 to built-in model catalog (#9853)" <all affected files including pnpm-lock.yaml>
   ```

**Pitfall warning**: SYNC-060 later modifies several of these same files. Apply SYNC-049 exactly as upstream shows. Don't try to merge 049+060 changes.
  </action>
  <verify>`pnpm vitest run src/config/model-alias-defaults.test.js` passes, `pnpm vitest run src/agents/model-selection.test.js` passes, `grep -c 'claude-opus-4-6' src/config/defaults.js` shows the new model</verify>
  <done>Commit eb80b9acb ported as SYNC-049, Claude Opus 4.6 available in model catalog with pi-ai 0.52.0</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-050 - Feishu: expand channel support</name>
  <files>src/feishu/docs.js (NEW), src/feishu/docs.test.js (NEW), src/feishu/reactions.js (NEW), src/feishu/typing.js (NEW), src/feishu/user.js (NEW), src/feishu/message.js, src/feishu/download.js, src/feishu/send.js, src/feishu/monitor.js, src/feishu/probe.js, docs/channels/feishu.md, CHANGELOG.md</files>
  <action>
Port commit 4fc4c5256 (Feishu: expand channel support)

1. Read the upstream diff:
   ```bash
   git show 4fc4c5256 --stat
   git show 4fc4c5256
   ```

2. Understand the change (HIGH complexity, ~17 files, 5 new):
   - Creates 5 NEW TypeScript files that need JavaScript conversion:
     - `src/feishu/docs.ts` -> `src/feishu/docs.js` (document handling)
     - `src/feishu/docs.test.ts` -> `src/feishu/docs.test.js` (tests)
     - `src/feishu/reactions.ts` -> `src/feishu/reactions.js` (reaction support)
     - `src/feishu/typing.ts` -> `src/feishu/typing.js` (typing indicators)
     - `src/feishu/user.ts` -> `src/feishu/user.js` (user lookup)
   - Modifies existing Feishu files: message.js, download.js, send.js, monitor.js, probe.js
   - Updates docs/channels/feishu.md with new capability documentation
   - May update README with contributor info and CHANGELOG

3. For each NEW .ts file, convert to JavaScript:
   - Use the established v1 pattern: strip type annotations, add JSDoc where helpful
   - Keep import paths with `.js` extension (upstream already uses .js in imports)
   - Convert TypeScript interfaces/types to JSDoc @typedef if they aid comprehension
   - Ensure exports match upstream

4. For existing files, apply the upstream diff changes:
   - message.js likely gets significant overhaul (new message type handling)
   - download.js, send.js, monitor.js, probe.js get incremental updates

5. Run targeted tests:
   ```bash
   pnpm vitest run src/feishu/docs.test.js
   pnpm vitest run src/feishu/
   ```

6. Commit:
   ```bash
   scripts/committer --no-verify "Feishu: expand channel support" <all affected files>
   ```

**Pitfall warning**: Verify all 5 new files are created and all ~12 existing files are modified. Use `git show 4fc4c5256 --stat` to get the full file list.
  </action>
  <verify>`pnpm vitest run src/feishu/docs.test.js` passes, `ls src/feishu/{docs,reactions,typing,user}.js` confirms all 4 new source files exist</verify>
  <done>Commit 4fc4c5256 ported as SYNC-050, Feishu channel expanded with docs/reactions/typing/user support</done>
</task>

<task type="auto">
  <name>Task 3: SYNC-051 - Feishu: tighten mention gating</name>
  <files>src/feishu/message.js</files>
  <action>
Port commit 7c951b01a (Feishu: tighten mention gating)

1. Read the upstream diff:
   ```bash
   git show 7c951b01a --stat
   git show 7c951b01a
   ```

2. Understand the change (LOW complexity, 1 file):
   - A single-line or small change to `src/feishu/message.js`
   - Tightens the logic for when the bot responds to mentions
   - Likely adds a stricter check on the mention format or context

3. Apply the equivalent JavaScript change:
   - Follow the upstream diff exactly
   - This builds directly on the SYNC-050 changes to message.js

4. Run targeted tests:
   ```bash
   pnpm vitest run src/feishu/
   ```

5. Commit:
   ```bash
   scripts/committer --no-verify "Feishu: tighten mention gating" src/feishu/message.js
   ```
  </action>
  <verify>`pnpm vitest run src/feishu/` passes, `git log -1` shows correct message</verify>
  <done>Commit 7c951b01a ported as SYNC-051, Feishu mention gating tightened</done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm vitest run src/config/model-alias-defaults.test.js` passes
3. `pnpm vitest run src/agents/model-selection.test.js` passes
4. `pnpm vitest run src/feishu/` passes
5. `grep claude-opus-4-6 src/config/defaults.js` shows the new model
6. `ls src/feishu/{docs,reactions,typing,user}.js` confirms new Feishu files exist
7. Commits match upstream messages:
   - feat: add Claude Opus 4.6 to built-in model catalog (#9853)
   - Feishu: expand channel support
   - Feishu: tighten mention gating
</verification>

<success_criteria>
- 3 commits created matching SYNC-049, SYNC-050, SYNC-051
- Claude Opus 4.6 available in all model selection surfaces
- pi-ai deps at 0.52.0
- 5 new Feishu files created (docs, docs.test, reactions, typing, user)
- Existing Feishu files updated
- Feishu mention gating tightened
- All model and Feishu tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-threading-features/09-03-SUMMARY.md`
</output>
