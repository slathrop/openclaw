---
phase: 01-build-tooling
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - package.json
  - vitest.config.js
  - vitest.unit.config.js
  - vitest.gateway.config.js
  - vitest.extensions.config.js
  - vitest.e2e.config.js
  - vitest.live.config.js
  - scripts/test-parallel.mjs
  - scripts/run-node.mjs
  - scripts/watch-node.mjs
  - scripts/canvas-a2ui-copy.js
  - scripts/copy-hook-metadata.js
  - scripts/write-build-info.js
  - scripts/write-cli-compat.js
autonomous: true

must_haves:
  truths:
    - "lodash-es is in dependencies (not devDependencies) and importable via ESM"
    - "pnpm build script references rolldown (not tsdown)"
    - "pnpm check script references eslint (not tsgo, oxlint, or oxfmt)"
    - "pnpm test script works with .js vitest config files"
    - "All vitest config files are .js (no .ts vitest configs remain)"
    - "pnpm lint and pnpm format scripts reference eslint"
    - "No package.json scripts reference tsx, tsgo, tsdown, oxlint, or oxfmt"
    - "scripts/run-node.mjs uses rolldown instead of tsdown"
    - "scripts/test-parallel.mjs references .js vitest config files"
  artifacts:
    - path: "vitest.config.js"
      provides: "Base vitest configuration (keeps .ts patterns for current source files)"
      contains: "defineConfig"
    - path: "vitest.unit.config.js"
      provides: "Unit test vitest configuration"
      contains: "vitest.config.js"
    - path: "vitest.gateway.config.js"
      provides: "Gateway test vitest configuration"
      contains: "vitest.config.js"
    - path: "vitest.extensions.config.js"
      provides: "Extensions test vitest configuration"
      contains: "vitest.config.js"
    - path: "vitest.e2e.config.js"
      provides: "E2E test vitest configuration"
      contains: "defineConfig"
    - path: "vitest.live.config.js"
      provides: "Live test vitest configuration"
      contains: "defineConfig"
    - path: "scripts/canvas-a2ui-copy.js"
      provides: "Build helper script converted from .ts"
    - path: "scripts/copy-hook-metadata.js"
      provides: "Build helper script converted from .ts"
    - path: "scripts/write-build-info.js"
      provides: "Build helper script converted from .ts"
    - path: "scripts/write-cli-compat.js"
      provides: "Build helper script converted from .ts"
  key_links:
    - from: "package.json"
      to: "rolldown.config.js"
      via: "build script"
      pattern: "rolldown"
    - from: "package.json"
      to: "eslint.config.js"
      via: "check/lint scripts"
      pattern: "eslint"
    - from: "vitest.unit.config.js"
      to: "vitest.config.js"
      via: "import base config"
      pattern: "import.*vitest\\.config\\.js"
    - from: "scripts/test-parallel.mjs"
      to: "vitest.unit.config.js"
      via: "config reference"
      pattern: "vitest\\.unit\\.config\\.js"
---

<objective>
Update all package.json scripts to reference JavaScript tools, rename vitest config files from .ts to .js, update helper scripts, and add lodash-es as a dependency.

Purpose: Wire everything together so that `pnpm build`, `pnpm check`, `pnpm test`, and `pnpm dev` all use the new JavaScript-only toolchain. This is the integration plan that makes the individual pieces from Plans 01 and 02 work as a cohesive build system.

Output: All critical-path scripts functional with JS-only tools; vitest configs renamed; lodash-es available.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-build-tooling/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename vitest config files from .ts to .js and update their contents</name>
  <files>vitest.config.js, vitest.unit.config.js, vitest.gateway.config.js, vitest.extensions.config.js, vitest.e2e.config.js, vitest.live.config.js</files>
  <action>
CRITICAL: ALL six vitest config files must be renamed together because they form an import chain (unit/gateway/extensions all import from base vitest.config.ts).

For each file, rename .ts to .js AND update the content to remove TypeScript syntax:

IMPORTANT: The vitest config FILES become .js (valid ESM JavaScript, no TypeScript syntax). However, the glob patterns INSIDE the configs must STILL reference `.ts` patterns because the source and test files are still .ts during Phase 1. Vitest processes .ts files natively (it strips types without invoking tsc). The patterns will be updated to .js when source files are actually converted in Phase 2+.

1. **vitest.config.ts -> vitest.config.js**
   - Remove TypeScript syntax: no `as` type assertions, no type annotations
   - Keep ALL the logic, timeouts, coverage config exactly as-is
   - Keep `.ts` patterns in include/exclude/coverage (source files are still .ts)
   - Keep `test/setup.ts` in setupFiles (still .ts)
   - Keep `index.ts` in plugin-sdk alias (still .ts)
   - Use regular JavaScript (no type annotations)

2. **vitest.unit.config.ts -> vitest.unit.config.js**
   - Change import path: `import baseConfig from './vitest.config.js'` (was .ts)
   - Remove the TypeScript `as` type assertion on baseConfig
   - Use plain JavaScript property access: `const baseTest = baseConfig?.test ?? {};`

3. **vitest.gateway.config.ts -> vitest.gateway.config.js**
   - Change import path: `import baseConfig from './vitest.config.js'`
   - Remove the TypeScript `as` type assertion
   - Use plain JavaScript property access

4. **vitest.extensions.config.ts -> vitest.extensions.config.js**
   - Change import path: `import baseConfig from './vitest.config.js'`
   - Remove the TypeScript `as` type assertion
   - Use plain JavaScript property access

5. **vitest.e2e.config.ts -> vitest.e2e.config.js**
   - No import chain dependency; just remove any TS syntax
   - Keep `.ts` patterns in include/setupFiles

6. **vitest.live.config.ts -> vitest.live.config.js**
   - No import chain dependency; just remove any TS syntax
   - Keep `.ts` patterns in include/setupFiles

After creating all .js files, delete all .ts vitest config files:
```bash
rm vitest.config.ts vitest.unit.config.ts vitest.gateway.config.ts vitest.extensions.config.ts vitest.e2e.config.ts vitest.live.config.ts
```

Leave `ui/vitest.config.ts` untouched (UI converts in Phase 5).

Style: single quotes, 2-space indent, no trailing commas, always semicolons.
  </action>
  <verify>
- `ls vitest.*.config.ts 2>&1` reports "No such file" (all .ts configs gone from root)
- `ls vitest.config.js vitest.unit.config.js vitest.gateway.config.js vitest.extensions.config.js vitest.e2e.config.js vitest.live.config.js` all exist
- `node -e "import('./vitest.config.js').then(() => console.log('ok'))"` prints "ok"
- `node -e "import('./vitest.unit.config.js').then(() => console.log('ok'))"` prints "ok"
- `grep -c 'as {' vitest.*.config.js` returns 0 for all files (no TypeScript syntax)
- `grep 'vitest.config.js' vitest.unit.config.js` shows the updated import path
  </verify>
  <done>All 6 root vitest config files renamed from .ts to .js. TypeScript syntax removed. Import chain updated. All configs are valid ESM JavaScript with .ts glob patterns preserved for current source files. ui/vitest.config.ts left untouched.</done>
</task>

<task type="auto">
  <name>Task 2: Add lodash-es and update package.json scripts</name>
  <files>package.json</files>
  <action>
**Part A: Add lodash-es dependency**

```bash
pnpm add lodash-es
```

This adds lodash-es to `dependencies` (not devDependencies) since it will be used in production source code.

**Part B: Update package.json scripts**

Update these critical-path scripts (the ones that must work for the JS-only workflow):

| Script | Old | New |
|--------|-----|-----|
| `build` | `pnpm canvas:a2ui:bundle && tsdown && node --import tsx scripts/canvas-a2ui-copy.ts && ...` | `pnpm canvas:a2ui:bundle && pnpm exec rolldown -c rolldown.config.js && node scripts/canvas-a2ui-copy.js && node scripts/copy-hook-metadata.js && node scripts/write-build-info.js && node scripts/write-cli-compat.js` |
| `check` | `pnpm tsgo && pnpm lint && pnpm format` | `pnpm lint` |
| `lint` | `oxlint --type-aware` | `eslint .` |
| `lint:fix` | `oxlint --type-aware --fix && pnpm format:fix` | `eslint --fix .` |
| `format` | `oxfmt --check` | `eslint .` |
| `format:fix` | `oxfmt --write` | `eslint --fix .` |
| `test:e2e` | `vitest run --config vitest.e2e.config.ts` | `vitest run --config vitest.e2e.config.js` |
| `test:live` | `OPENCLAW_LIVE_TEST=1 CLAWDBOT_LIVE_TEST=1 vitest run --config vitest.live.config.ts` | `OPENCLAW_LIVE_TEST=1 CLAWDBOT_LIVE_TEST=1 vitest run --config vitest.live.config.js` |

Remove `check:loc` entirely (TS-specific, uses tsx).

For non-critical scripts that reference `node --import tsx scripts/foo.ts`, update package.json to reference .js versions (the actual .ts script files will be converted in later phases -- these will fail if invoked but are not critical path):
- `plugins:sync`: `node --import tsx scripts/sync-plugin-versions.ts` -> `node scripts/sync-plugin-versions.js`
- `protocol:gen`: `node --import tsx scripts/protocol-gen.ts` -> `node scripts/protocol-gen.js`
- `protocol:gen:swift`: `node --import tsx scripts/protocol-gen-swift.ts` -> `node scripts/protocol-gen-swift.js`
- `release:check`: `node --import tsx scripts/release-check.ts` -> `node scripts/release-check.js`
- `test:force`: `node --import tsx scripts/test-force.ts` -> `node scripts/test-force.js`

**Part C: Remove vitest top-level key from package.json**

The `"vitest"` top-level key in package.json duplicates what's in vitest.config.js and references `.ts` patterns. Remove it entirely -- the vitest.config.js file is the single source of truth.

IMPORTANT notes:
- For `check`: Simplify to just `pnpm lint` since ESLint now handles both linting and formatting.
- For `format` and `format:fix`: Since ESLint Stylistic handles formatting, these map to `eslint .` and `eslint --fix .` respectively.
  </action>
  <verify>
- `grep -c 'tsdown' package.json` returns 0
- `grep -c 'oxlint' package.json` returns 0
- `grep -c 'oxfmt' package.json` returns 0
- `grep -c 'tsgo' package.json` returns 0
- `grep -c 'tsx' package.json` returns 0
- `grep 'lodash-es' package.json` shows it in dependencies
- `grep 'rolldown' package.json` shows it referenced in scripts
- `grep 'eslint' package.json` shows it referenced in lint/format scripts
- `node -e "import('lodash-es').then(m => console.log(typeof m.groupBy))"` prints "function"
- The `"vitest"` top-level key no longer exists in package.json
  </verify>
  <done>lodash-es is a production dependency. All package.json scripts reference JS-only tools. No scripts reference tsx, tsgo, tsdown, oxlint, or oxfmt. Vitest top-level config removed from package.json.</done>
</task>

<task type="auto">
  <name>Task 3: Convert build helper scripts and update run/watch/test-parallel scripts</name>
  <files>scripts/canvas-a2ui-copy.js, scripts/copy-hook-metadata.js, scripts/write-build-info.js, scripts/write-cli-compat.js, scripts/test-parallel.mjs, scripts/run-node.mjs, scripts/watch-node.mjs</files>
  <action>
**Part A: Convert 4 build helper scripts from .ts to .js**

These scripts are in the critical build path (referenced by the `build` script in package.json). They use minimal TypeScript syntax. Convert each one:

1. `scripts/canvas-a2ui-copy.ts` -> `scripts/canvas-a2ui-copy.js`
   - Remove type annotations from function params
   - Remove `as` type casts
   - Delete the .ts file after creating the .js version

2. `scripts/copy-hook-metadata.ts` -> `scripts/copy-hook-metadata.js`
   - Change shebang from `#!/usr/bin/env tsx` to `#!/usr/bin/env node`
   - Remove any TS syntax
   - Delete the .ts file after creating the .js version

3. `scripts/write-build-info.ts` -> `scripts/write-build-info.js`
   - Remove `as { version?: string }` cast (use plain property access)
   - Remove any other TS syntax
   - Delete the .ts file after creating the .js version

4. `scripts/write-cli-compat.ts` -> `scripts/write-cli-compat.js`
   - Remove any TS syntax if present
   - Delete the .ts file after creating the .js version

**Part B: Update scripts/test-parallel.mjs**

Update the vitest config references from `.ts` to `.js`:
- `vitest.unit.config.ts` -> `vitest.unit.config.js`
- `vitest.extensions.config.ts` -> `vitest.extensions.config.js`
- `vitest.gateway.config.ts` -> `vitest.gateway.config.js`

**Part C: Update scripts/run-node.mjs**

Change the compiler reference from `tsdown` to `rolldown`:
- Line 10: `const compiler = "tsdown";` -> `const compiler = "rolldown";`
- Line 16: Remove `path.join(cwd, "tsconfig.json")` from configFiles array (file no longer exists). Replace with `path.join(cwd, "rolldown.config.js")`.
- The spawn command needs `-c rolldown.config.js` args. Update `pnpmArgs` to: `["exec", compiler, "-c", "rolldown.config.js"]`
- Update log message from "Building TypeScript" to "Building JavaScript"

**Part D: Update scripts/watch-node.mjs**

Change the compiler reference from `tsdown` to `rolldown`:
- Line 8: `const compiler = "tsdown";` -> `const compiler = "rolldown";`
- Update spawn commands to include `-c rolldown.config.js` args:
  - `spawnSync("pnpm", ["exec", compiler, "-c", "rolldown.config.js"], ...)`
  - `spawn("pnpm", ["exec", compiler, "--watch", "-c", "rolldown.config.js"], ...)`

Note: rolldown's `--watch` flag may not work identically to tsdown's. Update the reference and document the potential difference in a code comment.
  </action>
  <verify>
- `ls scripts/canvas-a2ui-copy.js scripts/copy-hook-metadata.js scripts/write-build-info.js scripts/write-cli-compat.js` all exist
- `ls scripts/canvas-a2ui-copy.ts scripts/copy-hook-metadata.ts scripts/write-build-info.ts scripts/write-cli-compat.ts 2>&1` reports "No such file" for all four
- `grep 'vitest.unit.config.js' scripts/test-parallel.mjs` matches
- `grep 'rolldown' scripts/run-node.mjs` matches
- `grep 'rolldown' scripts/watch-node.mjs` matches
- `grep -c 'tsdown' scripts/run-node.mjs` returns 0
- `grep -c 'tsdown' scripts/watch-node.mjs` returns 0
  </verify>
  <done>Four build helper scripts converted from .ts to .js. test-parallel.mjs references .js vitest configs. run-node.mjs and watch-node.mjs use rolldown instead of tsdown.</done>
</task>

</tasks>

<verification>
1. No TS-specific tool references in package.json: `grep -cE '(tsdown|oxlint|oxfmt|tsgo|tsx)' package.json` returns 0
2. lodash-es importable: `node -e "import('lodash-es').then(m => console.log(typeof m.groupBy))"` prints "function"
3. All vitest configs are .js: `ls vitest.*.config.ts 2>&1` shows "No such file"
4. test-parallel references .js configs: `grep '\.config\.ts' scripts/test-parallel.mjs` returns nothing
5. run-node uses rolldown: `grep 'rolldown' scripts/run-node.mjs` matches
6. Build scripts are .js: `ls scripts/canvas-a2ui-copy.js scripts/copy-hook-metadata.js scripts/write-build-info.js scripts/write-cli-compat.js` all exist
7. Old .ts build scripts removed: `ls scripts/canvas-a2ui-copy.ts scripts/copy-hook-metadata.ts scripts/write-build-info.ts scripts/write-cli-compat.ts 2>&1` all report "No such file"
</verification>

<success_criteria>
- lodash-es is in dependencies and importable via ESM
- All critical-path package.json scripts (build, check, test, dev, lint, format) reference JS-only tools
- No package.json script references tsx, tsgo, tsdown, oxlint, or oxfmt
- All 6 root vitest config files are .js with valid ESM JavaScript (keeping .ts patterns for current source files)
- scripts/test-parallel.mjs references .js vitest config files
- scripts/run-node.mjs uses rolldown instead of tsdown
- scripts/watch-node.mjs uses rolldown instead of tsdown
- 4 build helper scripts converted from .ts to .js and old .ts versions removed
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-tooling/01-03-SUMMARY.md`
</output>
