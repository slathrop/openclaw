---
phase: 05-ui-and-extensions
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/auto-reply/**/*.ts -> *.js (~209 files)
  - src/browser/**/*.ts -> *.js (~81 files)
  - src/media-understanding/**/*.ts -> *.js (~37 files)
  - src/tui/**/*.ts -> *.js (~38 files)
  - src/hooks/**/*.ts -> *.js (~33 files)
  - src/cron/**/*.ts -> *.js (~34 files)
  - src/daemon/**/*.ts -> *.js (~30 files)
  - src/media/**/*.ts -> *.js (~19 files)
  - src/acp/**/*.ts -> *.js (~13 files)
  - src/wizard/**/*.ts -> *.js (~10 files)
  - src/security/**/*.ts -> *.js (~10 files)
  - src/markdown/**/*.ts -> *.js (~8 files)
  - src/link-understanding/**/*.ts -> *.js (~7 files)
  - src/process/**/*.ts -> *.js (~9 files)
  - src/pairing/**/*.ts -> *.js (~5 files)
  - src/macos/**/*.ts -> *.js (~4 files)
  - src/node-host/**/*.ts -> *.js (~3 files)
  - src/canvas-host/**/*.ts -> *.js (~3 files)
  - src/compat/**/*.ts -> *.js
  - src/polls.ts, src/logger.ts, src/extensionAPI.ts, src/channel-web.ts
  - src/index.test.ts, src/docker-setup.test.ts, src/globals.test.ts, etc. (root-level tests)
  - test/**/*.ts -> *.js (15 files: setup, helpers, mocks, test files)
  - vitest.config.js, vitest.e2e.config.js, vitest.extensions.config.js, vitest.gateway.config.js, vitest.live.config.js, vitest.unit.config.js
autonomous: true

must_haves:
  truths:
    - "All 571 .ts files in remaining src/ directories are converted to .js"
    - "All 15 .ts files in test/ directory are converted to .js"
    - "All 6 root vitest configs updated with .js include patterns and setupFiles"
    - "Zero .ts files remain anywhere in src/, ui/src/, extensions/, or test/ (success criterion 5)"
    - "auto-reply/ (209 files, largest directory) converts without timeout or corruption"
    - "SECURITY annotations added to security-critical files (security/, daemon/, auth-related modules)"
    - "Type-only files converted to JSDoc @typedef modules (not empty files)"
  artifacts:
    - path: "src/auto-reply/reply/agent-runner.js"
      provides: "Converted agent runner (largest auto-reply module)"
    - path: "src/browser/routes/index.js"
      provides: "Converted browser routes"
    - path: "src/security/index.js"
      provides: "Converted security module"
    - path: "test/setup.js"
      provides: "Converted test setup (referenced by vitest configs)"
    - path: "vitest.config.js"
      provides: "Updated root vitest config with .js patterns"
  key_links:
    - from: "vitest.config.js"
      to: "test/setup.js"
      via: "setupFiles reference"
      pattern: "test/setup\\.js"
    - from: "vitest.e2e.config.js"
      to: "test/setup.js"
      via: "setupFiles reference"
      pattern: "test/setup\\.js"
    - from: "src/auto-reply/**/*.js"
      to: "src/agents/**/*.js"
      via: "import from converted Phase 3 modules"
      pattern: "from.*agents"
---

<objective>
Convert all remaining src/ directories (571 files), the test/ directory (15 files), and update all 6 root vitest configs. Then verify zero .ts files remain across the entire codebase.

Purpose: This is the largest single plan by file count (~586 files, ~107K lines) but follows the exact same esbuild bulk conversion pattern established in Phases 2-4. The 18 remaining src/ directories (auto-reply being the largest at 209 files) plus root-level src/ files, the test/ support/helper/mock files, and vitest config updates complete the source conversion. After this plan, the success criterion "zero .ts files in src/, ui/src/, or extensions/" must be verified.

Output: All remaining .ts files converted, vitest configs updated, zero-ts verification passes.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ui-and-extensions/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert remaining src/ directories and root-level files (571 files)</name>
  <files>
    src/{auto-reply,browser,media-understanding,tui,hooks,cron,daemon,media,acp,wizard,security,markdown,link-understanding,process,pairing,macos,node-host,canvas-host,compat}/**/*.ts -> *.js
    src/polls.ts, src/logger.ts, src/extensionAPI.ts, src/channel-web.ts -> .js
    src/*.test.ts (root-level test files) -> .js
    A conversion script (convert-remaining-src.mjs, deleted after use)
  </files>
  <action>
Create a conversion script `convert-remaining-src.mjs` at project root that:

1. Finds ALL remaining .ts files in src/ recursively (excluding .d.ts, excluding node_modules)
   - This naturally captures only unconverted files since Phases 2-4 already deleted their .ts files
   - Expected: ~571 files across 18 subdirectories + 10 root-level files

2. Process in batches by directory for progress tracking. For each file:
   - esbuild `transformSync` with loader: 'ts', format: 'esm' (NO keepNames)
   - Strip any `__defProp`/`__name` boilerplate
   - Replace `== null` / `!= null` with strict equality (word-boundary regex from Phase 4)
   - Add explanatory comments to empty catch blocks
   - Do NOT rewrite import paths (src/ already uses .js extensions)
   - Check for `declare global` blocks and remove them
   - Write .js alongside .ts, then delete .ts

3. Reports count per directory and total

After bulk conversion, handle special cases:

**Type-only files** (interface/type declarations producing empty output):
- src/auto-reply/commands-registry.types.ts -> JSDoc @typedef module
- src/acp/types.ts -> JSDoc @typedef module
- Any other files that produce empty/near-empty output from esbuild
- Use module-level JSDoc blocks (not standalone @typedef)

**Classes with inheritance** (13 files across remaining src/):
- Verify esbuild correctly handles class syntax
- Convert `private` keyword to underscore-prefixed names (18 files affected)

**SECURITY annotations**:
- src/security/ files: add SECURITY comments to credential/auth-related code
- src/daemon/ files: add SECURITY comments to service management code
- src/auto-reply/command-auth.ts: add SECURITY comment for command authorization
- Any other files with auth/credential/token handling

**auto-reply/ handling** (209 files, ~42K lines -- largest directory):
- The conversion script handles this like any other directory
- The esbuild pipeline is file-by-file, so size does not cause timeouts
- Subdirectories: auto-reply/reply/, auto-reply/reply/exec/, auto-reply/reply/queue/

Run `pnpm check -- src/auto-reply src/browser src/media-understanding src/tui src/hooks src/cron src/daemon src/media src/acp src/wizard src/security src/markdown src/link-understanding src/process src/pairing src/macos src/node-host src/canvas-host --fix` to format.

Delete the conversion script after use.
  </action>
  <verify>
    - `find src -name '*.ts' | wc -l` returns 0
    - `grep -r '__defProp\|__name' src/auto-reply src/browser src/cron src/daemon --include='*.js' -l | wc -l` returns 0
    - `grep -r 'declare global' src/ --include='*.js' | wc -l` returns 0
  </verify>
  <done>All 571 remaining .ts files in src/ converted to .js. Type-only files converted to JSDoc @typedef. Private fields underscore-prefixed. SECURITY annotations added. ESLint auto-fix applied.</done>
</task>

<task type="auto">
  <name>Task 2: Convert test/ directory and update all vitest configs</name>
  <files>
    test/setup.ts -> test/setup.js
    test/test-env.ts -> test/test-env.js
    test/global-setup.ts -> test/global-setup.js
    test/helpers/*.ts -> test/helpers/*.js (6 files)
    test/mocks/*.ts -> test/mocks/*.js (1 file)
    test/*.test.ts, test/*.e2e.test.ts -> .js (5 test files)
    vitest.config.js (update setupFiles + include patterns)
    vitest.e2e.config.js (update setupFiles)
    vitest.extensions.config.js (verify patterns)
    vitest.gateway.config.js (verify patterns)
    vitest.live.config.js (update setupFiles)
    vitest.unit.config.js (update patterns)
  </files>
  <action>
1. **Convert test/ files** (15 files):
   - Apply esbuild transformSync to each .ts file in test/ (same pipeline as Task 1)
   - Files: setup.ts, test-env.ts, global-setup.ts, helpers/envelope-timestamp.ts, helpers/inbound-contract.ts, helpers/normalize-text.ts, helpers/paths.ts, helpers/poll.ts, helpers/temp-home.ts, mocks/baileys.ts, auto-reply.retry.test.ts, gateway.multi.e2e.test.ts, inbound-contract.providers.test.ts, media-understanding.auto.e2e.test.ts, provider-timeout.e2e.test.ts
   - Write .js, delete .ts
   - Fix import paths if any reference .ts (test/ helpers might import from each other)

2. **Update vitest configs** (6 files -- read each, make targeted edits):

   **vitest.config.js**:
   - Update `setupFiles` from `test/setup.ts` to `test/setup.js` (if still referencing .ts)
   - Update include patterns: ensure `test/format-error.test.ts` reference is either removed (file doesn't exist per research) or changed to .js
   - Ensure all include patterns match .test.js (Phase 1 already added .js patterns; remove any remaining .ts-only patterns)

   **vitest.e2e.config.js**:
   - Update `setupFiles` from .ts to .js references
   - Update include patterns to .test.js

   **vitest.extensions.config.js**:
   - Verify include patterns already match .js (likely already updated in Phase 1)
   - Remove any .ts-only patterns if present

   **vitest.gateway.config.js**:
   - Verify include patterns already match .js
   - Remove any .ts-only patterns if present

   **vitest.live.config.js**:
   - Update `setupFiles` from .ts to .js
   - Update include patterns to .test.js

   **vitest.unit.config.js**:
   - Update include patterns from .ts to .js
   - Handle the `test/format-error.test.ts` reference (remove if file doesn't exist, or update to .js)

3. **Final zero-.ts verification sweep**:
   - `find src -name '*.ts' | wc -l` must be 0
   - `find ui/src -name '*.ts' | wc -l` must be 0
   - `find extensions -name '*.ts' -not -path '*/node_modules/*' | wc -l` must be 0
   - `find test -name '*.ts' | wc -l` must be 0
   - Report any remaining .ts files found anywhere in the project scope

Run `pnpm check -- test/ --fix` for the test directory.
  </action>
  <verify>
    - `find test -name '*.ts' | wc -l` returns 0
    - `ls test/setup.js test/test-env.js test/global-setup.js` all exist
    - `grep 'setup\.ts' vitest.config.js vitest.e2e.config.js vitest.live.config.js` returns no matches (all updated to .js)
    - `grep '\.test\.ts' vitest.config.js vitest.unit.config.js vitest.e2e.config.js vitest.live.config.js` returns no matches
    - **CRITICAL**: `find src ui/src extensions test -name '*.ts' -not -path '*/node_modules/*' | wc -l` returns 0
  </verify>
  <done>All 15 test/ files converted to .js. All 6 vitest configs updated with .js patterns and setupFiles. Zero .ts files remain in src/, ui/src/, extensions/, or test/. Phase 5 success criterion 5 verified.</done>
</task>

</tasks>

<verification>
- `find src -name '*.ts' | wc -l` returns 0
- `find ui/src -name '*.ts' -o -name '*.tsx' | wc -l` returns 0
- `find extensions -name '*.ts' -not -path '*/node_modules/*' | wc -l` returns 0
- `find test -name '*.ts' | wc -l` returns 0
- `grep 'setup\.ts' vitest.*.config.js | wc -l` returns 0
- `pnpm check` passes (full project lint)
- `pnpm test 2>&1 | tail -5` runs without config errors (tests may have individual failures fixed in Phase 6)
</verification>

<success_criteria>
- Zero .ts files in src/, ui/src/, extensions/ (excluding node_modules), or test/
- All vitest configs reference .js setupFiles and include .test.js patterns
- Type-only files properly converted to JSDoc @typedef modules
- SECURITY annotations on security-critical modules
- Private fields use underscore-prefix convention
- ESLint passes on all converted files
- pnpm test runs without vitest config errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-and-extensions/05-03-SUMMARY.md`
</output>
