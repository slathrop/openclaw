---
phase: 06-verification-and-parity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/process/lanes.js
  - src/auto-reply/reply/session.js
  - src/auto-reply/reply/commands-compact.js
  - src/auto-reply/reply/session-updates.js
  - src/browser/chrome.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All systematic test failures are resolved (CommandLane circular import, minified variable artifacts)"
    - "The full test suite runs without suite-level failures from import errors"
    - "Coverage thresholds of 70% lines/functions/statements are met or exceeded"
  artifacts:
    - path: "src/process/lanes.js"
      provides: "Fixed CommandLane enum pattern without temporal dead zone"
      contains: "const CommandLane = "
    - path: "src/auto-reply/reply/session.js"
      provides: "Fixed null equality check without minified variable reference"
    - path: "src/auto-reply/reply/commands-compact.js"
      provides: "Fixed null equality checks without minified variable references"
  key_links:
    - from: "test/setup.js"
      to: "src/process/lanes.js"
      via: "module import chain"
      pattern: "CommandLane"
---

<objective>
Fix all systematic test failures from the TypeScript-to-JavaScript conversion and verify the full test suite passes with coverage thresholds met.

Purpose: Address root causes affecting 70%+ of test failures (circular import, minified variable artifacts) before verifying individual features.
Output: Zero systematic test failures, all tests pass, coverage thresholds validated.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-verification-and-parity/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CommandLane circular import and minified variable artifacts</name>
  <files>
    src/process/lanes.js
    src/auto-reply/reply/session.js
    src/auto-reply/reply/commands-compact.js
    src/auto-reply/reply/session-updates.js
    src/browser/chrome.js
  </files>
  <action>
Fix the systematic issues causing test suite failures:

**1. CommandLane circular import (src/process/lanes.js)**

The esbuild-converted IIFE pattern creates a temporal dead zone:
```javascript
const CommandLane = /* @__PURE__ */ ((CommandLane2) => {
  ...
})(CommandLane || {});  // CommandLane accessed before initialization
```

Replace with a simple object literal pattern that works without self-reference:
```javascript
/**
 * Command execution lane identifiers for routing and concurrency control.
 * @readonly
 * @enum {string}
 */
const CommandLane = {
  Main: 'main',
  Cron: 'cron',
  Subagent: 'subagent',
  Nested: 'nested'
};

export { CommandLane };
```

**2. Minified variable artifacts (3 files)**

Search for and fix broken null equality patterns with `e !== undefined` or `r !== undefined`:

- `src/auto-reply/reply/session.js` line 101: `e !== undefined` should be `normalizedChatType !== undefined`
- `src/auto-reply/reply/commands-compact.js` line 88: `e !== undefined` and `r !== undefined` should reference the actual variables being checked
- `src/auto-reply/reply/session-updates.js` line 233: `r !== undefined` should reference the actual variable
- `src/browser/chrome.js` line 200: `e !== undefined` should reference the actual variable (likely `bootstrap.exitCode`)

For each broken pattern:
1. Read the surrounding context to identify the correct variable name
2. Replace the minified variable reference with the correct one
3. Verify the logic makes sense (null check should match the property being tested)
  </action>
  <verify>
Run the specific tests that were failing due to these issues:
```bash
pnpm vitest run src/index.test.js
pnpm vitest run src/auto-reply/reply/abort.test.js
pnpm vitest run src/agents/subagent-announce.format.test.js
```
All should now import successfully without "Cannot access before initialization" or "e is not defined" errors.
  </verify>
  <done>
- src/process/lanes.js uses object literal pattern (no IIFE self-reference)
- All `e !== undefined` and `r !== undefined` artifacts replaced with correct variable names
- Previously failing imports now succeed
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify coverage thresholds</name>
  <files>None (verification only)</files>
  <action>
Run the complete test suite and analyze results:

```bash
pnpm test
```

**If individual test failures remain after systematic fixes:**
1. Categorize remaining failures by error type
2. For mock-related failures: Check for unnamed arrow functions in vi.mock factories that need to be named function declarations
3. For assertion failures: Check if test expectations need updating for JS output differences
4. For import failures: Check for remaining .ts import paths with `grep -rn "from.*\.ts['\"]" src/`

**Coverage verification:**
```bash
pnpm test:coverage
```

Verify thresholds are met:
- Lines: >= 70%
- Functions: >= 70%
- Statements: >= 70%
- Branches: >= 55%

If coverage falls below thresholds, identify which converted files have reduced coverage and add tests or coverage exclusions for legitimately untestable code (following existing vitest.config.js exclusion patterns).
  </action>
  <verify>
```bash
pnpm test 2>&1 | grep -E "Test Files|Tests|passed|failed"
pnpm test:coverage 2>&1 | grep -E "All files|Statements|Branches|Functions|Lines"
```
Test suite exits 0 with all tests passing. Coverage meets configured thresholds.
  </verify>
  <done>
- `pnpm test` exits 0 with no test failures
- Coverage thresholds met: 70% lines/functions/statements, 55% branches
- Any remaining issues documented in summary
  </done>
</task>

</tasks>

<verification>
1. `pnpm test` completes successfully (exit 0)
2. No "Cannot access 'X' before initialization" errors
3. No "e is not defined" or similar minified variable errors
4. Coverage report shows all thresholds met
5. `pnpm check` passes (no lint regressions)
</verification>

<success_criteria>
- All existing tests pass (`pnpm test` exits 0 with no failures)
- Code coverage meets or exceeds 70% thresholds for lines, functions, and statements
- No systematic import/module errors remain from conversion
</success_criteria>

<output>
After completion, create `.planning/phases/06-verification-and-parity/06-01-SUMMARY.md`
</output>
