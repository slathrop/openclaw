---
phase: 09.1-formalize-upstream-sync-process
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/slathrop/.claude/get-shit-done/workflows/sync-upstream.md
autonomous: true

must_haves:
  truths:
    - "/gsd:sync-upstream workflow creates a complete milestone structure from a target commit hash"
    - "Workflow reads SYNC-STATE.md to determine last-synced commit automatically"
    - "Workflow generates REQUIREMENTS.md with SYNC-NNN IDs from git log"
    - "Workflow generates ROADMAP.md with ~20-commit phases"
    - "Workflow updates SYNC-STATE.md, STATE.md, and PROJECT.md"
  artifacts:
    - path: "/Users/slathrop/.claude/get-shit-done/workflows/sync-upstream.md"
      provides: "GSD workflow for automated upstream sync milestone creation"
      contains: "<purpose>"
      min_lines: 100
  key_links:
    - from: "/Users/slathrop/.claude/get-shit-done/workflows/sync-upstream.md"
      to: ".planning/SYNC-STATE.md"
      via: "reads Last synced commit to compute range"
      pattern: "SYNC-STATE"
    - from: "/Users/slathrop/.claude/get-shit-done/workflows/sync-upstream.md"
      to: ".planning/REQUIREMENTS.md"
      via: "generates requirements file from git log"
      pattern: "REQUIREMENTS"
    - from: "/Users/slathrop/.claude/get-shit-done/workflows/sync-upstream.md"
      to: ".planning/ROADMAP.md"
      via: "generates roadmap with phase breakdown"
      pattern: "ROADMAP"
---

<objective>
Create the /gsd:sync-upstream workflow that automates milestone creation from a target upstream commit hash.

Purpose: Each upstream sync cycle currently requires manual commit enumeration, REQUIREMENTS.md authoring, ROADMAP.md structuring, and state tracking. This workflow automates the entire process: given a target commit hash, it computes the range from last-synced, enumerates commits, generates SYNC-NNN requirements, groups into ~20-commit phases, and creates all planning artifacts.

Output: `~/.claude/get-shit-done/workflows/sync-upstream.md` -- a complete GSD workflow file.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/09.1-formalize-upstream-sync-process/09.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /gsd:sync-upstream workflow</name>
  <files>/Users/slathrop/.claude/get-shit-done/workflows/sync-upstream.md</files>
  <action>
Create `~/.claude/get-shit-done/workflows/sync-upstream.md` following the exact XML+markdown format used by all existing GSD workflows (see execute-plan.md, complete-milestone.md, verify-phase.md for format reference).

The workflow accepts one parameter: a target upstream commit hash. It automates the complete sync milestone creation process.

**Workflow structure:**

```
<purpose>
Create an upstream sync milestone from a target commit hash. Reads .planning/SYNC-STATE.md for the last-synced commit, computes the commit range, generates REQUIREMENTS.md and ROADMAP.md, and updates project state files.

Usage: /gsd:sync-upstream TARGET_COMMIT_HASH
Example: /gsd:sync-upstream abc1234

Prerequisites:
- .planning/SYNC-STATE.md exists (created by Phase 9.1)
- No existing REQUIREMENTS.md or ROADMAP.md (run /gsd:complete-milestone first)
- Upstream remote configured and fetchable
</purpose>

<required_reading>
Read these files NOW:
1. .planning/SYNC-STATE.md
2. .planning/PROJECT.md
3. .planning/STATE.md
</required_reading>
```

**Steps to implement (each as a `<step name="...">` block):**

**Step 1: validate_prerequisites**
- Check .planning/SYNC-STATE.md exists; error if missing
- Check REQUIREMENTS.md and ROADMAP.md do NOT exist; error if present (must complete-milestone first)
- Parse last synced commit from SYNC-STATE.md: `grep "Last synced commit:" .planning/SYNC-STATE.md | awk '{print $NF}'`
- Ask user for target commit if not provided as parameter
- Validate target commit exists: `git cat-file -t TARGET 2>/dev/null`

**Step 2: fetch_and_compute_range**
- Run `git fetch upstream` to refresh refs
- Count commits: `git rev-list --count ${LAST_SYNCED}..${TARGET}` (exclusive start -- last synced is already done)
- If count is 0, report "No new commits" and exit
- List commits chronologically: `git log --first-parent --reverse --format="%h %s" ${LAST_SYNCED}..${TARGET}`
- Present summary: "Found N commits from LAST_SYNCED to TARGET"
- IMPORTANT: Use `LAST_SYNCED..TARGET` (exclusive start) because LAST_SYNCED was already ported. Do NOT use `LAST_SYNCED^..TARGET` which would re-include it.

**Step 3: determine_milestone_version**
- Read current milestone from SYNC-STATE.md (e.g., "v2")
- Increment: v2 -> v3, v3 -> v4, etc.
- If MODE is interactive, confirm with user. If yolo, auto-proceed.
- Store MILESTONE_VERSION (e.g., "v3")

**Step 4: group_into_phases**
- Group commits into phases of ~20 commits each
- For each group, analyze commit subjects to find dominant themes
- Name phases by theme (e.g., "Security + Hardening", "xAI + Cron")
- If themes are unclear, use generic names: "Sync Batch 1", "Sync Batch 2"
- Determine starting phase number: read highest phase number from `.planning/milestones/` archives and `.planning/phases/` directories. Continue from there.
- Present phase grouping to user for review (interactive mode) or auto-approve (yolo mode)

**Step 5: generate_requirements**
- Create `.planning/REQUIREMENTS.md` using the established format (see current v2 REQUIREMENTS.md as template)
- Header: milestone name, date, core value, commit range
- For each commit: `- [ ] **SYNC-NNN**: {commit subject} ({short hash})`
- SYNC numbers are sequential starting from 001
- Group by phase with phase headers
- Add Out of Scope section (empty -- user fills in)
- Add Traceability table mapping SYNC-NNN to phases

**Step 6: generate_roadmap**
- Create `.planning/ROADMAP.md` using the established format
- Overview section with phase table (phase number, name, commits, focus)
- Phase details with: Goal, Commits range, Requirements range, Key changes (from commit subjects), Success criteria (standard: "Full test suite passes after each commit" + phase-specific)
- Plans section: `- [ ] TBD (run /gsd:plan-phase N to break down)` for each phase
- Execution Notes section with the standard commit approach

**Step 7: update_sync_state**
- Update `.planning/SYNC-STATE.md`:
  - Set "Last synced commit" to TARGET (the new range endpoint)
  - Set "Last synced date" to today
  - Set "Current milestone" to MILESTONE_VERSION
  - Add row to Sync History table
  - Update current sync range section

**Step 8: update_project_state**
- Update `.planning/STATE.md`:
  - Set current focus to new milestone
  - Set current position to first new phase
  - Reset progress bar
  - Clear accumulated decisions (fresh milestone)
- Update `.planning/PROJECT.md`:
  - Update "Current Milestone" in header
  - Add new scope description to Context section
  - Update Active requirements section

**Step 9: commit_and_report**
- Check COMMIT_PLANNING_DOCS config
- If true: `git add .planning/REQUIREMENTS.md .planning/ROADMAP.md .planning/SYNC-STATE.md .planning/STATE.md .planning/PROJECT.md && git commit -m "docs: create MILESTONE_VERSION upstream sync milestone"`
- Present summary:
  ```
  Milestone MILESTONE_VERSION created:
  - N commits (LAST_SYNCED..TARGET)
  - M phases (Phase X through Phase Y)
  - REQUIREMENTS.md: N requirements (SYNC-001 to SYNC-NNN)
  - ROADMAP.md: M phases with ~20 commits each

  Next: /gsd:plan-phase FIRST_PHASE
  ```

**Step 10: offer_codebase_docs_review**
- Remind user to review .planning/codebase/ downstream divergence sections
- Suggest: "Review codebase docs if upstream has changed significantly since last sync"
- This is informational, not blocking

**Success criteria at bottom:**
```
<success_criteria>
- [ ] SYNC-STATE.md read and last-synced commit parsed
- [ ] Upstream fetched and commit range computed
- [ ] Milestone version determined (incremented from previous)
- [ ] Commits grouped into ~20-commit phases with thematic names
- [ ] REQUIREMENTS.md generated with SYNC-NNN IDs
- [ ] ROADMAP.md generated with phase details
- [ ] SYNC-STATE.md updated with new target
- [ ] STATE.md and PROJECT.md updated for new milestone
- [ ] All changes committed
- [ ] User knows next step (/gsd:plan-phase)
</success_criteria>
```

**Key implementation details:**
- Follow the EXACT same XML structure as other workflows: `<purpose>`, `<required_reading>`, `<process>` with `<step>` blocks, `<success_criteria>`
- Include `<if mode="yolo">` and `<if mode="interactive">` branching where decisions need confirmation
- Include bash code blocks for git commands
- Reference templates where applicable (e.g., `@/Users/slathrop/.claude/get-shit-done/templates/requirements.md`)
- Handle edge cases: no new commits, missing upstream remote, REQUIREMENTS.md already exists

**What NOT to include:**
- No automated thematic grouping algorithm (let the agent analyze commit subjects naturally)
- No complex phase boundary detection (simple ~20-commit blocks, agent adjusts as needed)
- No integration with external APIs
  </action>
  <verify>
Verify the workflow file exists and follows the GSD format:
```bash
test -f ~/.claude/get-shit-done/workflows/sync-upstream.md && grep -c "<step name=" ~/.claude/get-shit-done/workflows/sync-upstream.md && grep "<purpose>" ~/.claude/get-shit-done/workflows/sync-upstream.md
```
Should show the file exists, has multiple steps, and contains the purpose tag.
  </verify>
  <done>The /gsd:sync-upstream workflow file exists at ~/.claude/get-shit-done/workflows/sync-upstream.md with all 10 steps, proper GSD XML structure, and handles the complete milestone creation flow.</done>
</task>

<task type="auto">
  <name>Task 2: Validate workflow structure against existing workflows</name>
  <files>/Users/slathrop/.claude/get-shit-done/workflows/sync-upstream.md</files>
  <action>
After creating the workflow, validate it by comparing structural elements against existing workflows:

1. Verify the file starts with `<purpose>` and ends with `</success_criteria>` (or similar closing tag)
2. Verify all step names are unique
3. Verify bash code blocks use proper git commands:
   - `git rev-list --count` for counting (NOT `git log | wc -l`)
   - `git log --first-parent --reverse --format` for listing
   - `git fetch upstream` before any range operations
4. Verify the workflow references SYNC-STATE.md correctly (reads "Last synced commit" field)
5. Verify the range notation is correct: `LAST_SYNCED..TARGET` (exclusive start, since LAST_SYNCED is already ported)
6. Verify phase numbering logic reads from existing phases/milestones to continue numbering

If any structural issues found, fix them in the workflow file.

Do NOT create any test files or test infrastructure. This is a documentation/workflow file validation only.
  </action>
  <verify>
```bash
# Check structural integrity
grep -c "<step name=" ~/.claude/get-shit-done/workflows/sync-upstream.md
grep "<purpose>" ~/.claude/get-shit-done/workflows/sync-upstream.md | head -1
grep "SYNC-STATE" ~/.claude/get-shit-done/workflows/sync-upstream.md | head -3
grep "rev-list" ~/.claude/get-shit-done/workflows/sync-upstream.md | head -2
grep "LAST_SYNCED\.\." ~/.claude/get-shit-done/workflows/sync-upstream.md | head -2
```
Should show 10 steps, purpose tag, SYNC-STATE references, rev-list command, and correct range notation.
  </verify>
  <done>Workflow passes structural validation: correct XML format, proper git commands, accurate SYNC-STATE.md integration, and correct range notation.</done>
</task>

</tasks>

<verification>
1. `~/.claude/get-shit-done/workflows/sync-upstream.md` exists
2. Workflow has `<purpose>`, `<required_reading>`, `<process>` with `<step>` blocks, `<success_criteria>`
3. Workflow reads SYNC-STATE.md for last-synced commit
4. Workflow generates REQUIREMENTS.md and ROADMAP.md
5. Workflow updates SYNC-STATE.md, STATE.md, PROJECT.md
6. Git commands use correct range notation (exclusive start)
7. Phase numbering continues from existing highest phase number
</verification>

<success_criteria>
- /gsd:sync-upstream workflow file created and structurally valid
- Workflow handles the complete sync milestone creation flow in 10 steps
- All git commands verified correct (range notation, commit counting, chronological listing)
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-formalize-upstream-sync-process/09.1-02-SUMMARY.md`
</output>
