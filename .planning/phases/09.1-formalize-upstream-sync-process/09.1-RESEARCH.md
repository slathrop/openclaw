# Phase 9.1: Formalize Upstream Sync Process - Research

**Researched:** 2026-02-06
**Domain:** GSD workflow infrastructure, git commit range analysis, dual-codebase documentation
**Confidence:** HIGH

## Summary

This phase creates process infrastructure, not application code. It has three deliverables: (1) evolve `.planning/codebase/` to track both upstream TypeScript state and downstream JavaScript divergence, (2) create a `/gsd:sync-upstream` workflow file that generates sync milestones from a target commit hash, and (3) add persistent sync state tracking in `.planning/`.

The research confirmed that all three deliverables are well-understood, bounded problems. The GSD skill system uses markdown files in `~/.claude/get-shit-done/workflows/` with XML-structured `<process>` steps -- no registration is needed; any file placed there becomes available as `/gsd:workflow-name`. The git commands for commit range enumeration (`git rev-list --count`, `git log --format`) are standard and already used in the current v2 sync process. The codebase docs follow established templates in `~/.claude/get-shit-done/templates/codebase/`.

**Primary recommendation:** Break into 3 plans: (1) dual-codebase docs update, (2) sync state file + tracking, (3) /gsd:sync-upstream workflow creation.

## Standard Stack

This phase produces markdown documentation and a GSD workflow file. No libraries are involved.

### Core
| Tool | Purpose | Why Standard |
|------|---------|--------------|
| Git CLI | Commit range enumeration, ancestry path | Already used throughout v2 sync |
| GSD workflow system | Workflow file format | Existing `~/.claude/get-shit-done/workflows/` |
| Markdown | Documentation format | All `.planning/` artifacts are markdown |

### Key Git Commands for Sync Workflow
| Command | Purpose | Verified |
|---------|---------|----------|
| `git rev-list --count START^..END` | Count commits in range (inclusive) | Yes -- returns exactly 104 for current v2 range |
| `git log --first-parent --reverse --format="%h %s" START^..END` | List commits chronologically | Yes -- current REQUIREMENTS.md follows this pattern |
| `git log --oneline --ancestry-path LAST_SYNCED..upstream/main` | Find new upstream commits | Yes -- returns 26 new commits post-v2 range |
| `git fetch upstream` | Refresh upstream refs before range calculation | Standard |

## Architecture Patterns

### GSD Workflow File Structure

All workflows in `~/.claude/get-shit-done/workflows/` follow this pattern (HIGH confidence -- read from 12 existing workflow files):

```xml
<purpose>
One paragraph describing what the workflow does.
</purpose>

<required_reading>
Files to read at start.
</required_reading>

<process>

<step name="step_name">
Step description with bash commands and decision logic.
</step>

<step name="next_step">
...
</step>

</process>

<success_criteria>
Checklist of completion conditions.
</success_criteria>
```

Key patterns observed:
- Steps use `<step name="...">` tags
- Config checking: `cat .planning/config.json 2>/dev/null | grep ...`
- Mode branching: `<if mode="yolo">` and `<if mode="interactive">`
- Bash snippets embedded in markdown code blocks
- File I/O via `cat`, template filling, and Write operations
- No registration needed -- files are auto-discovered by name

### Workflow Naming Convention

Workflows are invoked as `/gsd:workflow-name` where `workflow-name` matches the filename (minus `.md`). The new workflow should be:
- **File:** `~/.claude/get-shit-done/workflows/sync-upstream.md`
- **Invocation:** `/gsd:sync-upstream`

### Sync State File Pattern

The sync state should live in `.planning/` alongside other project metadata. Based on how STATE.md, PROJECT.md, and ROADMAP.md track project state, the sync state file should be:

```
.planning/SYNC-STATE.md
```

Content structure:
```markdown
# Upstream Sync State

**Upstream remote:** upstream (https://github.com/openclaw/openclaw.git)
**Last synced commit:** 6c42d3461
**Last synced date:** 2026-02-06
**Milestone:** v2

## Sync History

| Milestone | Start Commit | End Commit | Commits | Completed |
|-----------|-------------|------------|---------|-----------|
| v2 | a13ff55bd | 6c42d3461 | 104 | In Progress |
```

### Dual-Codebase Documentation Pattern

The current `.planning/codebase/` docs describe the **upstream TypeScript** codebase as of Feb 4, 2026. They need to evolve to reflect:

1. **Downstream JavaScript state** -- the actual codebase being worked on
2. **Upstream-downstream divergence** -- where they differ architecturally
3. **Conversion decisions** -- choices made during TS-to-JS conversion

Recommended approach: Add a `## Downstream Divergence` section to each existing doc rather than creating parallel files. This keeps information co-located and avoids duplication.

Example for STACK.md:
```markdown
## Downstream Divergence

**Analysis Date:** 2026-02-06

### Language
- Upstream: TypeScript 5.9.3
- Downstream: JavaScript (ESM) with JSDoc annotations

### Build Tooling
- Upstream: tsdown 0.20.1
- Downstream: Rolldown (natively processes .js)

### Linting
- Upstream: Oxlint + Oxfmt
- Downstream: ESLint with @stylistic/eslint-plugin (Google Style, no trailing commas)
```

### Recommended Project Structure for New Files

```
.planning/
├── SYNC-STATE.md                    # NEW: persistent sync tracking
├── codebase/
│   ├── ARCHITECTURE.md              # UPDATED: add downstream divergence
│   ├── CONCERNS.md                  # UPDATED: add downstream divergence
│   ├── CONVENTIONS.md               # UPDATED: add downstream divergence
│   ├── INTEGRATIONS.md              # UNCHANGED (same across codebases)
│   ├── STACK.md                     # UPDATED: add downstream divergence
│   ├── STRUCTURE.md                 # UPDATED: add downstream divergence
│   └── TESTING.md                   # UPDATED: add downstream divergence
~/.claude/get-shit-done/
└── workflows/
    └── sync-upstream.md             # NEW: /gsd:sync-upstream workflow
```

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Commit enumeration | Custom git log parsing | `git rev-list --count START^..END` | Handles merge commits, ancestry correctly |
| Commit listing | Manual log scraping | `git log --first-parent --reverse --format` | `--first-parent` matches the v2 approach of counting merge commits as single units |
| Phase grouping | Custom phase size calculator | 20-commit batches (established v2 pattern) | v2 used ~20 commits per phase; proven manageable |
| REQUIREMENTS.md generation | Manual requirement writing | Git log + SYNC-NNN template | v2 REQUIREMENTS.md was generated from git log with SYNC-001 through SYNC-104 pattern |
| Workflow file structure | Custom format | Copy pattern from existing workflows | 12 workflow files establish the exact XML+markdown format |

## Common Pitfalls

### Pitfall 1: Commit Count Mismatch
**What goes wrong:** `git log` with different flags returns different counts (104 vs 130 for the same range)
**Why it happens:** `--first-parent` vs full ancestry, `--ancestry-path` vs default traversal
**How to avoid:** Always use `git rev-list --count START^..END` for counting. Use `git log --first-parent --reverse --format="%h %s" START^..END` for listing. The `--first-parent` flag skips merge commit sub-histories.
**Warning signs:** Count doesn't match expectation; count changes on `git fetch`

### Pitfall 2: Inclusive vs Exclusive Range
**What goes wrong:** `START..END` excludes START; `START^..END` includes START
**Why it happens:** Git's `..` notation is exclusive on the left side
**How to avoid:** Use `START^..END` when you want to include the START commit. The v2 range specification says "INCLUSIVE" for both ends, so the command must use `a13ff55bd^..6c42d3461`.
**Warning signs:** First commit missing from requirements list; count off by one

### Pitfall 3: Stale Upstream Refs
**What goes wrong:** New upstream commits not visible; sync range calculation uses stale data
**Why it happens:** `upstream/main` isn't automatically updated
**How to avoid:** Always run `git fetch upstream` before computing sync range. The workflow should include this as its first step.
**Warning signs:** "Target commit not found" errors

### Pitfall 4: Codebase Docs Drift
**What goes wrong:** Downstream divergence sections become stale as upstream evolves
**Why it happens:** Nobody updates them after initial write
**How to avoid:** The sync-upstream workflow should include a "review codebase docs" step at the end of each milestone. Add a reminder in the workflow template.
**Warning signs:** STACK.md says "TypeScript 5.9.3" but upstream has moved to a newer version

### Pitfall 5: Phase Numbering Continuity
**What goes wrong:** New milestone starts phase numbering at 1 instead of continuing from previous milestone
**Why it happens:** Forgetting that GSD uses continuous phase numbering across milestones
**How to avoid:** The sync-upstream workflow should read the current ROADMAP.md to find the highest phase number and continue from there.
**Warning signs:** Two phases with the same number; roadmap confusion

### Pitfall 6: Workflow File Location
**What goes wrong:** File created in project `.planning/` instead of `~/.claude/get-shit-done/workflows/`
**Why it happens:** Confusing project-level docs with user-level GSD skills
**How to avoid:** GSD workflows live in `~/.claude/get-shit-done/workflows/`. Project-specific docs live in `.planning/`. The sync-upstream workflow is a GSD skill, not a project artifact.
**Warning signs:** `/gsd:sync-upstream` not recognized

## Code Examples

### Example: Sync Range Calculation

```bash
# Source: current v2 sync process (verified)
# Fetch latest upstream
git fetch upstream

# Get last synced commit from SYNC-STATE.md
LAST_SYNCED=$(grep "Last synced commit:" .planning/SYNC-STATE.md | awk '{print $NF}')

# Target commit (provided by user)
TARGET_COMMIT="$1"

# Count commits in range (inclusive)
COMMIT_COUNT=$(git rev-list --count ${LAST_SYNCED}^..${TARGET_COMMIT})

# List commits in chronological order
git log --first-parent --reverse --format="%h %s" ${LAST_SYNCED}^..${TARGET_COMMIT}
```

### Example: REQUIREMENTS.md Generation Pattern

```markdown
# Requirements: v3 Upstream Sync

**Defined:** [date]
**Core Value:** Human-friendly JavaScript synchronized with upstream TypeScript development

## v3 Requirements

Port [N] upstream commits with 1:1 parity and full test verification.

**Commit range (INCLUSIVE):** [last_synced]^..[target]

### Phase [X]: [Name] (commits 1-20)

- [ ] **SYNC-001**: [commit message] ([short_hash])
- [ ] **SYNC-002**: [commit message] ([short_hash])
...
```

### Example: Phase Grouping Logic

```bash
# Source: v2 roadmap pattern (verified)
# Group ~20 commits per phase
TOTAL_COMMITS=104
COMMITS_PER_PHASE=20
PHASE_COUNT=$(( (TOTAL_COMMITS + COMMITS_PER_PHASE - 1) / COMMITS_PER_PHASE ))

# Phase assignment:
# Phase 1: commits 1-20
# Phase 2: commits 21-40
# ...
# Last phase: remaining commits
```

### Example: Workflow Step for Sync Milestone Generation

```xml
<step name="generate_requirements">
Generate REQUIREMENTS.md from commit range:

1. Enumerate commits:
   ```bash
   git log --first-parent --reverse --format="%h %s" ${LAST_SYNCED}^..${TARGET_COMMIT}
   ```

2. Assign SYNC-NNN IDs sequentially

3. Group into phases (~20 commits each):
   - Analyze commit subjects for thematic clustering
   - Name phases by dominant theme (e.g., "Security + Hardening", "xAI + Cron")

4. Write .planning/REQUIREMENTS.md using template

5. Write .planning/ROADMAP.md with phase details
</step>
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Manual milestone creation | Could be automated via workflow | Phase 9.1 | Reduces manual work for each sync cycle |
| Upstream-only codebase docs | Dual-codebase tracking | Phase 9.1 | Better context for planning sync phases |
| No sync state persistence | SYNC-STATE.md tracking | Phase 9.1 | Enables incremental sync operations |
| Manual commit range counting | `git rev-list --count` in workflow | Phase 9.1 | Eliminates counting errors |

## Key Design Decisions for Planning

### 1. Workflow Output: What Should /gsd:sync-upstream Generate?

The workflow should generate these files:
- `.planning/REQUIREMENTS.md` -- SYNC-NNN requirements from commit log
- `.planning/ROADMAP.md` -- Phases with ~20 commits each
- Update `.planning/SYNC-STATE.md` -- Record the new target
- Update `.planning/STATE.md` -- Set new milestone focus
- Update `.planning/PROJECT.md` -- Add new milestone scope

This mirrors the manual process used to create the v2 milestone (verified by reading v2 REQUIREMENTS.md and ROADMAP.md).

### 2. Commit Grouping Strategy

The v2 milestone grouped commits thematically:
- Phase 7: Security + Initial Hardening (21 commits)
- Phase 8: Windows ACL + Telegram Threading (21 commits)
- Phase 9: Threading + Features (21 commits)
- Phase 10: xAI + Cron + Security Scanner (20 commits)
- Phase 11: Agents + Feishu + Gateway Auth (21 commits)

The workflow should analyze commit subjects and group by theme rather than strict 20-commit blocks. However, the initial version can use simple 20-commit blocks and let the user manually adjust phase boundaries.

### 3. Codebase Docs: Selective Update

Not all 7 codebase docs need downstream divergence sections. Based on analysis:

**Need update (divergence exists):**
- STACK.md -- Language, build tooling, linting differ significantly
- CONVENTIONS.md -- JS style rules differ from TS conventions
- STRUCTURE.md -- File extensions changed (.ts to .js)
- TESTING.md -- Test config differs (vitest.config.js vs .ts)
- ARCHITECTURE.md -- Same patterns but implementation differs

**Likely unchanged:**
- INTEGRATIONS.md -- External APIs are the same
- CONCERNS.md -- Could add JS-specific concerns but not divergence per se

### 4. Phase Numbering for Next Sync

Current v2 milestone ends at Phase 11. The next sync milestone should continue from Phase 12. The workflow must read the existing ROADMAP.md to determine the starting phase number.

If an archived roadmap exists (`.planning/milestones/v2-ROADMAP.md`), the workflow should handle the case where ROADMAP.md has been deleted (per complete-milestone workflow) and use the milestone archive to find the last phase number.

## Open Questions

1. **Phase naming strategy for auto-generated milestones**
   - What we know: v2 phases were named thematically by manual analysis of commit subjects
   - What's unclear: Whether the workflow should attempt automated thematic grouping or use generic names
   - Recommendation: Use sequential generic names ("Sync Batch 1", "Sync Batch 2") in the auto-generated output, with a manual review step where the user can rename phases

2. **Milestone versioning**
   - What we know: v1 was JS conversion, v2 is upstream sync
   - What's unclear: Whether future syncs should be v3, v4, etc. or v2.1, v2.2
   - Recommendation: Use v3, v4, etc. for each sync milestone (simple, unambiguous)

3. **Existing ROADMAP.md handling**
   - What we know: complete-milestone workflow deletes ROADMAP.md and REQUIREMENTS.md
   - What's unclear: What if sync-upstream is run mid-milestone (before completing current milestone)
   - Recommendation: Error if ROADMAP.md or REQUIREMENTS.md already exist; require milestone completion first

## Sources

### Primary (HIGH confidence)
- GSD workflow files: `~/.claude/get-shit-done/workflows/*.md` (12 files read)
- GSD templates: `~/.claude/get-shit-done/templates/` (codebase, milestone, requirements, roadmap templates read)
- Project planning files: `.planning/STATE.md`, `.planning/PROJECT.md`, `.planning/ROADMAP.md`, `.planning/REQUIREMENTS.md`
- Git commands: Verified against actual repository (`git rev-list --count` returns 104 for v2 range)
- Existing codebase docs: `.planning/codebase/*.md` (all 7 files examined)

### Secondary (MEDIUM confidence)
- Upstream commit range: Verified 26 new commits exist beyond v2 range end (6c42d3461..upstream/main)

### Tertiary (LOW confidence)
- None. All findings verified against primary sources.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH -- no libraries involved; pure git + markdown
- Architecture: HIGH -- GSD workflow format verified from 12 existing workflows
- Pitfalls: HIGH -- observed from actual v2 sync experience (commit counting, range notation)
- Codebase docs pattern: MEDIUM -- downstream divergence sections are new; pattern extrapolated from existing structure

**Research date:** 2026-02-06
**Valid until:** Indefinite (git commands and GSD workflow format are stable)
