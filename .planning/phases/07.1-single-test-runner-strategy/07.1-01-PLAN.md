---
phase: 07.1-single-test-runner-strategy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/slathrop/.claude/get-shit-done/workflows/execute-phase.md
  - /Users/slathrop/.claude/get-shit-done/references/parallel-testing.md
  - /opt/ws/gh/openclaw-simplified/.gitignore
autonomous: true

must_haves:
  truths:
    - "Execute-phase orchestrator runs a full test suite once between waves (wave-level test gate)"
    - "Wave-level test gate runs pnpm check (lint) alongside pnpm test between waves"
    - "Test failures at wave boundary are attributed to agent commits and reported with actionable detail"
    - "Planners have a reference doc explaining targeted vs full suite testing patterns"
  artifacts:
    - path: "/Users/slathrop/.claude/get-shit-done/workflows/execute-phase.md"
      provides: "Wave-level test gate step between execute_waves iterations"
      contains: "wave_test_gate"
    - path: "/Users/slathrop/.claude/get-shit-done/references/parallel-testing.md"
      provides: "Planner/executor reference for targeted test patterns"
      contains: "vitest run --related"
  key_links:
    - from: "execute-phase.md wave_test_gate step"
      to: "pnpm test"
      via: "bash command after all wave agents complete"
      pattern: "pnpm test"
    - from: "execute-phase.md wave_test_gate step"
      to: "pnpm check"
      via: "bash command for lint gate"
      pattern: "pnpm check"
---

<objective>
Add wave-level test gate to the GSD execute-phase orchestrator and create the parallel testing reference document.

Purpose: The execute-phase orchestrator currently delegates testing to individual agents, who each run `pnpm test` per task. With 5 parallel agents, this creates ~15 full test runs per wave, massive CPU contention (80 vitest workers), and index.lock conflicts. This plan adds a single full test + lint run between waves, replacing the per-agent full suite approach.

Output: Modified execute-phase.md with wave_test_gate step; new parallel-testing.md reference doc; .gitignore entry for test results directory.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-single-test-runner-strategy/07.1-RESEARCH.md
@/Users/slathrop/.claude/get-shit-done/workflows/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wave-level test gate to execute-phase.md</name>
  <files>/Users/slathrop/.claude/get-shit-done/workflows/execute-phase.md</files>
  <action>
Modify the execute-phase.md workflow to add a wave-level test gate step. The new step runs between waves (after all agents in a wave complete, before proceeding to the next wave).

1. Add a new step `wave_test_gate` AFTER the `execute_waves` step (insert it between `execute_waves` and `checkpoint_handling`). The step should:

   a. Run after ALL agents in the current wave have completed successfully
   b. Execute full test suite once: `pnpm test --run`
   c. Execute lint gate once: `pnpm check`
   d. If both pass: proceed to next wave
   e. If tests fail:
      - Parse failure output to identify failing test files
      - Cross-reference failing files with agent commits in the wave (use `git log --oneline` for the wave's commits)
      - Report: "Wave N test gate failed. Failures in: [test files]. Likely caused by: [agent plan IDs based on file overlap]"
      - Ask user: "Remediate (spawn fix agent) or continue to next wave?"
   f. If lint fails:
      - Report lint errors
      - Ask user: "Auto-fix (run pnpm check --fix) or continue?"
   g. Optionally write JSON results for failure analysis: `npx vitest run --reporter=default --reporter=json --outputFile.json=.planning/test-results/wave-N-results.json`

2. In the `execute_waves` step (step 5 "Execute checkpoint plans between waves"), add a reference: "After all agents complete and before proceeding to next wave, run wave_test_gate step."

3. Update the `execute_waves` step's flow description to show the test gate in the sequence:
   - Execute wave agents (parallel)
   - Wait for all agents
   - Report completion
   - Run wave_test_gate
   - Handle failures if any
   - Proceed to next wave

4. In the step's markdown, note that agents within the wave should use `--no-verify` for git commits during parallel waves to avoid pre-commit hook conflicts. The wave-level lint gate replaces per-commit linting.

5. Add a note that for single-agent waves (wave with only 1 plan), the test gate still runs -- consistency is more important than micro-optimization.

Do NOT modify the verify_phase_goal step or the aggregate_results step -- they remain unchanged.
Do NOT add any new dependencies or imports.
  </action>
  <verify>
Read the modified execute-phase.md and confirm:
- A `wave_test_gate` step exists with proper markdown structure
- The step references `pnpm test --run` and `pnpm check`
- The step includes failure attribution logic
- The execute_waves step references the test gate
  </verify>
  <done>
execute-phase.md contains a wave_test_gate step that runs full test suite + lint once per wave, with failure attribution and user-prompted remediation flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create parallel-testing reference doc and update .gitignore</name>
  <files>
/Users/slathrop/.claude/get-shit-done/references/parallel-testing.md
/opt/ws/gh/openclaw-simplified/.gitignore
  </files>
  <action>
1. Create `/Users/slathrop/.claude/get-shit-done/references/parallel-testing.md` with the following content:

   Structure:
   - Title: "Parallel Testing Strategy"
   - Purpose section: Explain the wave-level test gate pattern -- why per-task full suite is replaced by targeted tests + wave-level gate
   - "For Planners" section:
     * When writing `<verify>` elements for plans in parallel waves, use targeted tests instead of `pnpm test`
     * Pattern: `npx vitest run --maxWorkers=1 path/to/specific.test.js` for known test files
     * Pattern: `npx vitest run --related path/to/modified-source.js --maxWorkers=2` for broader coverage
     * Always include `--maxWorkers=1` or `--maxWorkers=2` during parallel waves to limit worker process spawning
     * For solo-agent waves (wave with 1 plan), targeted tests are still preferred -- the wave-level gate handles full suite
     * Example before/after:
       - BEFORE: `<verify>pnpm test passes, pnpm check passes</verify>`
       - AFTER: `<verify>Targeted tests pass: npx vitest run --maxWorkers=1 src/gateway/auth.test.js</verify>`
   - "For Executors" section:
     * During parallel wave execution, do NOT run `pnpm test` (full suite) in task verification
     * Run only the targeted test specified in the plan's `<verify>` element
     * Use `--no-verify` flag when committing during parallel waves (pre-commit hook conflicts)
     * The orchestrator handles full suite testing at wave boundary
     * If you are the ONLY agent in a wave, still use targeted tests -- the wave gate runs full suite regardless
   - "Wave Test Gate" section:
     * After all agents in a wave complete, the execute-phase orchestrator runs:
       1. `pnpm test --run` (full test suite, single run)
       2. `pnpm check` (lint gate)
     * If tests fail: failures are attributed to agent commits and reported
     * If lint fails: auto-fix offered or manual resolution
   - "Test Results" section:
     * Wave test gate optionally writes JSON results to `.planning/test-results/wave-N-results.json`
     * This directory is gitignored
     * Results are useful for failure analysis when multiple agents may have caused different failures
   - "Anti-Patterns" section:
     * Running `pnpm test` in every task's `<verify>` during parallel waves
     * Having agents poll for test results from another agent
     * Sharding tests across agents (vitest --shard is for CI matrix, not local multi-agent)
     * Skipping ALL testing during execution (targeted tests per task still valuable)

2. Update `/opt/ws/gh/openclaw-simplified/.gitignore` -- add `.planning/test-results/` entry. Add it near existing `.planning/` related entries if any, otherwise at the end of the file. Only add this single line; do not modify other entries.
  </action>
  <verify>
- File exists at `/Users/slathrop/.claude/get-shit-done/references/parallel-testing.md`
- File contains sections: "For Planners", "For Executors", "Wave Test Gate", "Anti-Patterns"
- File contains `vitest run --maxWorkers=1` and `vitest run --related` patterns
- `.gitignore` contains `.planning/test-results/` entry
  </verify>
  <done>
parallel-testing.md reference doc exists with actionable guidance for planners and executors. .gitignore updated with test-results exclusion.
  </done>
</task>

</tasks>

<verification>
1. execute-phase.md has a wave_test_gate step that references pnpm test and pnpm check
2. parallel-testing.md exists with planner and executor guidance sections
3. .gitignore has .planning/test-results/ entry
4. No syntax errors in any modified markdown files
</verification>

<success_criteria>
- Execute-phase orchestrator has wave-level test gate integrated into wave execution flow
- Reference doc provides concrete examples planners can copy-paste into verify elements
- All files are well-structured markdown with no broken references
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-single-test-runner-strategy/07.1-01-SUMMARY.md`
</output>
