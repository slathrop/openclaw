---
phase: 03-core-services
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/gateway/*.ts (source only, excluding protocol/)
  - src/gateway/server/*.ts (source only)
  - src/gateway/server-methods/*.ts (source only)
autonomous: true

must_haves:
  truths:
    - "All source files in src/gateway/ (excluding protocol/) are .js with no .ts remaining"
    - "All gateway server and server-methods source files are .js"
    - "Security-sensitive gateway files have SECURITY: annotations"
    - "Gateway private class fields use underscore prefix convention"
  artifacts:
    - path: "src/gateway/*.js"
      provides: "Gateway root modules converted to JavaScript"
    - path: "src/gateway/server/*.js"
      provides: "Gateway server (WebSocket, HTTP) converted to JavaScript"
    - path: "src/gateway/server-methods/*.js"
      provides: "Gateway RPC method handlers converted to JavaScript"
  key_links:
    - from: "src/gateway/auth.js"
      to: "WebSocket message handler"
      via: "per-message auth validation"
      pattern: "SECURITY:"
    - from: "src/gateway/server/ws-connection.js"
      to: "src/gateway/auth.js"
      via: "connection authentication"
      pattern: "SECURITY:"
    - from: "src/gateway/server-http.js"
      to: "src/gateway/origin-check.js"
      via: "CSRF origin validation"
      pattern: "SECURITY:"
    - from: "src/gateway/server-http.js"
      to: "src/gateway/protocol/"
      via: "protocol schema validation on incoming messages"
      pattern: "import.*from.*protocol"
    - from: "src/gateway/server-methods/*.js"
      to: "src/gateway/server/ws-connection.js"
      via: "session management via connection state"
      pattern: "connection\\.(session|getSession|auth)"
    - from: "src/gateway/server/ws-connection.js"
      to: "message dispatcher"
      via: "WebSocket message routing to server-methods handlers"
      pattern: "(dispatch|handle|route).*message"
---

<objective>
Convert gateway source files (root, server, server-methods) from TypeScript to JavaScript using esbuild bulk conversion. This covers ~113 source files (~21.4K lines) -- the gateway core excluding protocol/ (handled by 03-03) and test files (handled by 03-07).

Purpose: The gateway is the WebSocket server that channels and agents connect to. It has 8 security-sensitive files requiring SECURITY: annotations, 25 `private` keyword occurrences needing underscore prefix, 6 classes, and 237 `as` assertions. Source files are split from tests to keep context budget under 50%.
Output: All gateway source files (root, server, server-methods) converted to .js with SECURITY annotations, underscore-prefix private fields, and module-level JSDoc.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-services/03-RESEARCH.md
@.planning/phases/02-foundation-layer/02-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bulk convert gateway root and server source files with esbuild</name>
  <files>
    src/gateway/*.ts (73 root source, excluding protocol/ and *.test.ts)
    src/gateway/server/*.ts (10 source, excluding *.test.ts)
    Total: ~83 source files
  </files>
  <action>
1. Use esbuild bulk conversion on gateway root + server source files (excluding protocol/ and all test files):
   - Write/reuse the esbuild transformSync conversion script from 03-RESEARCH.md
   - Convert all .ts source files (NOT test files, NOT test-helpers) in:
     - src/gateway/*.ts (root-level, 73 files, excluding *.test.ts)
     - src/gateway/server/*.ts (10 files, excluding *.test.ts)
   - Do NOT convert files in src/gateway/protocol/ (handled by 03-03)
   - Do NOT convert *.test.ts or test-helpers*.ts (handled by 03-07)
   - For each: read .ts, transformSync to JS, write .js, delete .ts

2. Post-process: Private keyword to underscore prefix (25 occurrences):
   - esbuild strips `private` keyword automatically
   - Identify the 6 classes in gateway (likely in server/, connection management)
   - Prefix private fields/methods with `_` and update all internal references
   - Follow 02-08 pattern: this.field -> this._field for all private fields

3. Post-process: Fix esbuild artifacts:
   - Replace `== null` / `!= null` with strict equality throughout
   - Remove unused imports left behind after type stripping
   - Fix any empty catch blocks with explanatory comments (no-empty compliance)

4. Post-process: Add SECURITY: annotations to these files in this batch:
   - `auth.js` -- Connection authentication, token validation (document per-message auth enforcement)
   - `device-auth.js` -- Device authentication token management (document token lifecycle)
   - `origin-check.js` -- WebSocket origin validation (document CSRF protection model)
   - `server-http.js` -- HTTP server with TLS and origin checking (document TLS enforcement, origin policy)
   - `server/ws-connection.js` -- WebSocket connection lifecycle, auth enforcement (document connection auth model)
   - `server/ws-connection/message-handler.js` -- Per-message auth validation (document message-level auth)
     (Note: if message-handler.ts is inside server/ subdirectory, adjust path accordingly)
   - `session-utils.js` -- Session key validation and scoping (document session scope enforcement)
   - `server-session-key.js` -- Session key generation and rotation (document key rotation security)

5. Add module-level JSDoc comments to all converted source files

6. Apply QUAL-01 (early returns) and QUAL-02 (arrow functions) to obviously nested conditionals and function declarations

7. Handle `satisfies` assertions (4 in gateway) -- esbuild removes these automatically, no post-processing needed

8. Handle `interface` declarations (3 in gateway) -- convert to JSDoc @typedef

9. Run eslint --fix on all converted source files:
   ```bash
   pnpm eslint --fix src/gateway/*.js src/gateway/server/*.js --ignore-pattern '**/*.test.*'
   ```
  </action>
  <verify>
- `find src/gateway/ -maxdepth 1 -name '*.ts' ! -name '*.test.ts' ! -name 'test-helpers*' | wc -l` returns 0
- `find src/gateway/server/ -name '*.ts' ! -name '*.test.ts' | wc -l` returns 0
- `pnpm eslint src/gateway/*.js src/gateway/server/*.js` reports 0 errors on source files
- `grep -rl 'SECURITY:' src/gateway/*.js src/gateway/server/*.js | wc -l` returns at least 6
  </verify>
  <done>
Gateway root (~73) and server (~10) source files are .js with SECURITY annotations, underscore-prefix private fields, and module-level JSDoc. ESLint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bulk convert gateway server-methods source files</name>
  <files>
    src/gateway/server-methods/*.ts (30 source files, excluding *.test.ts)
  </files>
  <action>
1. Use esbuild bulk conversion on server-methods source files:
   - Convert all .ts source files (NOT test files) in src/gateway/server-methods/ (30 files)
   - For each: read .ts, transformSync to JS, write .js, delete .ts

2. Post-process: Fix esbuild artifacts:
   - Replace `== null` / `!= null` with strict equality
   - Remove unused imports
   - Fix empty catch blocks

3. Add module-level JSDoc comments to all server-methods source files

4. Apply QUAL-01 (early returns) and QUAL-02 (arrow functions) where appropriate

5. Run eslint --fix on server-methods source files:
   ```bash
   pnpm eslint --fix src/gateway/server-methods/*.js --ignore-pattern '**/*.test.*'
   ```

6. Quick smoke check -- verify all source .ts files are gone across all three directories:
   ```bash
   find src/gateway/ -name '*.ts' ! -path '*/protocol/*' ! -name '*.test.ts' ! -name 'test-helpers*' | wc -l
   ```
  </action>
  <verify>
- `find src/gateway/server-methods/ -name '*.ts' ! -name '*.test.ts' | wc -l` returns 0
- `pnpm eslint src/gateway/server-methods/*.js` reports 0 errors
- `find src/gateway/ -name '*.ts' ! -path '*/protocol/*' ! -name '*.test.ts' ! -name 'test-helpers*' | wc -l` returns 0
  </verify>
  <done>
All ~113 gateway source files across root, server, and server-methods are .js with SECURITY annotations on 8 auth files, underscore-prefix private fields, module-level JSDoc, and ESLint passing. Test files remain as .ts for 03-07.
  </done>
</task>

</tasks>

<verification>
- `find src/gateway/ -name '*.ts' ! -path '*/protocol/*' ! -name '*.test.ts' ! -name 'test-helpers*' | wc -l` returns 0
- `pnpm eslint src/gateway/*.js src/gateway/server/*.js src/gateway/server-methods/*.js` 0 errors
- SECURITY annotations on all 8 security-sensitive files
- Private fields use underscore prefix
</verification>

<success_criteria>
1. Zero source .ts files remain in src/gateway/ outside protocol/ (test files may remain)
2. SECURITY: annotations on auth.js, device-auth.js, origin-check.js, server-http.js, ws-connection.js, message-handler.js, session-utils.js, server-session-key.js
3. Gateway classes use underscore-prefix private field convention
4. All module-level JSDoc comments present
5. ESLint reports 0 errors on source files
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-services/03-04-SUMMARY.md`
</output>
