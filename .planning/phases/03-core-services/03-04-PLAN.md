---
phase: 03-core-services
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/gateway/*.ts
  - src/gateway/server/*.ts
  - src/gateway/server-methods/*.ts
autonomous: true

must_haves:
  truths:
    - "All files in src/gateway/ (excluding protocol/) are .js with no .ts remaining"
    - "All gateway server and server-methods files are .js"
    - "Security-sensitive gateway files have SECURITY: annotations"
    - "Gateway private class fields use underscore prefix convention"
    - "All existing gateway tests pass after conversion"
  artifacts:
    - path: "src/gateway/*.js"
      provides: "Gateway root modules converted to JavaScript"
    - path: "src/gateway/server/*.js"
      provides: "Gateway server (WebSocket, HTTP) converted to JavaScript"
    - path: "src/gateway/server-methods/*.js"
      provides: "Gateway RPC method handlers converted to JavaScript"
  key_links:
    - from: "src/gateway/auth.js"
      to: "WebSocket message handler"
      via: "per-message auth validation"
      pattern: "SECURITY:"
    - from: "src/gateway/server/ws-connection.js"
      to: "src/gateway/auth.js"
      via: "connection authentication"
      pattern: "SECURITY:"
    - from: "src/gateway/server-http.js"
      to: "src/gateway/origin-check.js"
      via: "CSRF origin validation"
      pattern: "SECURITY:"
---

<objective>
Convert the gateway root, server, and server-methods directories from TypeScript to JavaScript using esbuild bulk conversion. This covers ~170 files (~36K lines) -- the gateway core excluding protocol/ (handled by 03-03).

Purpose: The gateway is the WebSocket server that channels and agents connect to. It has 8 security-sensitive files requiring SECURITY: annotations, 25 `private` keyword occurrences needing underscore prefix, 6 classes, and 237 `as` assertions. This is the second-largest directory in Phase 3.
Output: All gateway files (root, server, server-methods) converted to .js with SECURITY annotations, underscore-prefix private fields, module-level JSDoc, and all tests passing.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-services/03-RESEARCH.md
@.planning/phases/02-foundation-layer/02-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bulk convert gateway source files with esbuild</name>
  <files>
    src/gateway/*.ts (73 root source, excluding protocol/)
    src/gateway/server/*.ts (10 source)
    src/gateway/server-methods/*.ts (30 source)
    Total: ~113 source files, ~21.4K lines
  </files>
  <action>
1. Use esbuild bulk conversion on gateway source files (excluding protocol/ which is handled by 03-03):
   - Write/reuse the esbuild transformSync conversion script from 03-RESEARCH.md
   - Convert all .ts source files (NOT test files) in:
     - src/gateway/*.ts (root-level, 73 files)
     - src/gateway/server/*.ts (10 files)
     - src/gateway/server-methods/*.ts (30 files)
   - Do NOT convert files in src/gateway/protocol/ (handled by 03-03)
   - For each: read .ts, transformSync to JS, write .js, delete .ts

2. Post-process: Private keyword to underscore prefix (25 occurrences):
   - esbuild strips `private` keyword automatically
   - Identify the 6 classes in gateway (likely in server/, connection management)
   - Prefix private fields/methods with `_` and update all internal references
   - Follow 02-08 pattern: this.field -> this._field for all private fields

3. Post-process: Fix esbuild artifacts:
   - Replace `== null` / `!= null` with strict equality throughout
   - Remove unused imports left behind after type stripping
   - Fix any empty catch blocks with explanatory comments (no-empty compliance)

4. Post-process: Add SECURITY: annotations to these 8 files:
   - `auth.js` -- Connection authentication, token validation (document per-message auth enforcement)
   - `device-auth.js` -- Device authentication token management (document token lifecycle)
   - `origin-check.js` -- WebSocket origin validation (document CSRF protection model)
   - `server-http.js` -- HTTP server with TLS and origin checking (document TLS enforcement, origin policy)
   - `server/ws-connection.js` -- WebSocket connection lifecycle, auth enforcement (document connection auth model)
   - `server/ws-connection/message-handler.js` -- Per-message auth validation (document message-level auth)
     (Note: if message-handler.ts is inside server/ subdirectory, adjust path accordingly)
   - `session-utils.js` -- Session key validation and scoping (document session scope enforcement)
   - `server-session-key.js` -- Session key generation and rotation (document key rotation security)

5. Add module-level JSDoc comments to all source files

6. Apply QUAL-01 (early returns) and QUAL-02 (arrow functions) to obviously nested conditionals and function declarations

7. Handle `satisfies` assertions (4 in gateway) -- esbuild removes these automatically, no post-processing needed

8. Handle `interface` declarations (3 in gateway) -- convert to JSDoc @typedef

9. Run eslint --fix on all converted source files:
   ```bash
   pnpm eslint --fix src/gateway/ --ignore-pattern 'src/gateway/protocol/'
   ```
   (If protocol/ is already .js from 03-03, eslint --fix on all of src/gateway/ is fine)
  </action>
  <verify>
- `find src/gateway/ -name '*.ts' ! -path '*/protocol/*' ! -name '*.test.ts' | wc -l` returns 0 (no source .ts outside protocol/)
- `pnpm eslint src/gateway/ --ignore-pattern '**/*.test.*'` reports 0 errors on source files
- `grep -rl 'SECURITY:' src/gateway/*.js src/gateway/server/*.js | wc -l` returns at least 6
  </verify>
  <done>
All ~113 gateway source files are .js with SECURITY annotations on auth files, underscore-prefix private fields, and module-level JSDoc. ESLint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert gateway test files and verify full test suite</name>
  <files>
    src/gateway/*.test.ts (51 root test files)
    src/gateway/server/*.test.ts (1 test)
    src/gateway/server-methods/*.test.ts (5 tests)
    src/gateway/test-helpers*.ts (5 test helper files)
    Total: ~62 test files
  </files>
  <action>
1. Use esbuild bulk conversion on ALL gateway test files:
   - Convert all *.test.ts files in gateway/ and its subdirectories (excluding protocol/ if already done)
   - Convert test-helpers*.ts files (shared test utilities, not test files per se but need conversion)
   - esbuild transformSync, rename .ts to .js, delete .ts originals

2. Post-process test files:
   - Replace `== null` / `!= null` with strict equality
   - Remove unused type imports
   - Fix any broken test patterns (e.g., multi-line `as` cast patterns -> direct property access, per 02-09 pattern)
   - No need for SECURITY comments or QUAL improvements in tests

3. Run eslint --fix on test files:
   ```bash
   pnpm eslint --fix src/gateway/
   ```

4. Run the full gateway test suite:
   ```bash
   pnpm vitest run src/gateway/ --reporter=verbose
   ```
   - Expect: all unit tests pass
   - E2E tests (*.e2e.test.js) may need gateway running -- verify they pass or are appropriately skipped
   - Live tests (*.live.test.js) are skipped without CLAWDBOT_LIVE_TEST=1

5. Verify zero .ts files remain anywhere in src/gateway/:
   ```bash
   find src/gateway/ -name '*.ts' | wc -l
   ```
   This should return 0 (protocol/ was handled by 03-03, everything else by this plan).
  </action>
  <verify>
- `find src/gateway/ -name '*.ts' | wc -l` returns 0 (including protocol/ from 03-03)
- `pnpm eslint src/gateway/` reports 0 errors
- `pnpm vitest run src/gateway/` passes all runnable tests
  </verify>
  <done>
All gateway test files and test helpers converted to .js. Full gateway test suite passes. Zero .ts files remain anywhere in src/gateway/.
  </done>
</task>

</tasks>

<verification>
- `find src/gateway/ -name '*.ts' | wc -l` returns 0
- `pnpm vitest run src/gateway/` all tests pass
- `pnpm eslint src/gateway/` 0 errors
- SECURITY annotations on all 8 security-sensitive files
- Private fields use underscore prefix
</verification>

<success_criteria>
1. Zero .ts files remain in src/gateway/ (all subdirectories including protocol/)
2. SECURITY: annotations on auth.js, device-auth.js, origin-check.js, server-http.js, ws-connection.js, message-handler.js, session-utils.js, server-session-key.js
3. Gateway classes use underscore-prefix private field convention
4. All module-level JSDoc comments present
5. All gateway tests pass (unit + e2e where applicable)
6. ESLint reports 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-services/03-04-SUMMARY.md`
</output>
