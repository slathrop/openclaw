---
phase: 03-core-services
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/agents/*.ts (root-level source only)
  - src/agents/*.test.ts (root-level tests only)
autonomous: true

must_haves:
  truths:
    - "All root-level source files in src/agents/ are .js with no .ts remaining"
    - "All root-level test files in src/agents/ are .js with no .ts remaining"
    - "Security-sensitive agent files have SECURITY: annotations"
    - "satisfies assertions (concentrated in agents) are removed"
    - "All root-level agent tests pass after conversion"
  artifacts:
    - path: "src/agents/*.js"
      provides: "Agent runtime root modules converted to JavaScript"
  key_links:
    - from: "src/agents/cli-credentials.js"
      to: "credential storage"
      via: "CLI credential management"
      pattern: "SECURITY:"
    - from: "src/agents/model-auth.js"
      to: "API key resolution"
      via: "model authentication"
      pattern: "SECURITY:"
---

<objective>
Convert all root-level source and test files in src/agents/ (291 files, ~48.5K lines) from TypeScript to JavaScript using esbuild bulk conversion.

Purpose: The agents root level contains the core agent runtime (model selection, Pi embedded session management, message handling, tool dispatch). This is the single largest batch of files in the entire project. It has 108 source files (~22.5K lines) and 183 test files (~26K lines) at the root level. The subdirectories (tools/, pi-embedded-runner/, etc.) are handled by 03-06. This plan focuses ONLY on root-level files to keep scope manageable.
Output: All ~291 root-level agent files converted to .js with SECURITY annotations on credential files, satisfies assertions removed, and all root-level tests passing.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-services/03-RESEARCH.md
@.planning/phases/02-foundation-layer/02-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bulk convert agents root-level source files</name>
  <files>
    src/agents/*.ts (108 root-level source files, ~22.5K lines -- NOT subdirectories)
  </files>
  <action>
1. Use esbuild bulk conversion on root-level agents source files ONLY:
   - Convert all .ts files directly in src/agents/ (maxdepth 1, not recursive)
   - Do NOT convert files in subdirectories (tools/, pi-embedded-runner/, etc.) -- those are 03-06
   - esbuild transformSync for each file, write .js, delete .ts

2. Post-process: Handle agents-specific TS patterns:
   - `satisfies` assertions (~99 occurrences, mostly in root files) -- esbuild removes automatically, no action needed
   - `as` assertions (549 total across agents, many in root) -- esbuild removes automatically
   - `import type` (419 total) -- esbuild removes automatically
   - `export type` (185 total) -- esbuild removes; add JSDoc @typedef for important exported types
   - `interface` declarations (9 in agents) -- convert to JSDoc @typedef
   - Generic functions (27 total) -- simplify to non-generic JSDoc (e.g., Promise<*>)
   - `private` keyword (2 in agents root) -- underscore prefix

3. Post-process: Fix esbuild artifacts:
   - Replace `== null` / `!= null` with strict equality
   - Remove unused imports
   - Fix empty catch blocks with explanatory comments
   - Add module-level JSDoc comments to each source file

4. Add SECURITY: annotations to these credential-related files:
   - `cli-credentials.js` -- CLI credential management (document credential storage and retrieval)
   - `model-auth.js` -- Model API key resolution (document API key lookup chain)
   Note: auth-profiles/ files are in 03-06 (subdirectory)

5. Apply QUAL-01 (early returns) and QUAL-02 (arrow functions) to obviously improvable patterns

6. Run eslint --fix on root-level source files:
   ```bash
   pnpm eslint --fix src/agents/*.js
   ```
  </action>
  <verify>
- `find src/agents/ -maxdepth 1 -name '*.ts' ! -name '*.test.ts' | wc -l` returns 0
- `pnpm eslint src/agents/*.js` reports 0 errors (root-level only)
- `grep -l 'SECURITY:' src/agents/cli-credentials.js src/agents/model-auth.js | wc -l` returns 2
  </verify>
  <done>
All 108 root-level agent source files are .js with module-level JSDoc, SECURITY annotations on credential files, and interfaces converted to JSDoc @typedef. ESLint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bulk convert agents root-level test files and verify</name>
  <files>
    src/agents/*.test.ts (183 root-level test files, ~26K lines)
    src/agents/test-helpers/*.ts (2 test helper files)
  </files>
  <action>
1. Use esbuild bulk conversion on ALL root-level test files:
   - Convert all *.test.ts files directly in src/agents/ (maxdepth 1)
   - Also convert src/agents/test-helpers/*.ts (2 shared test utility files)
   - esbuild transformSync, write .js, delete .ts

2. Post-process test files:
   - Replace `== null` / `!= null` with strict equality
   - Remove unused type imports
   - Fix multi-line `as` cast patterns -> direct property access (per 02-09 pattern)
   - No SECURITY comments or QUAL improvements needed in tests

3. Note: Some test files have extremely long names (per research Pitfall 9). Use programmatic rename, not manual.

4. Run eslint --fix:
   ```bash
   pnpm eslint --fix src/agents/*.test.js src/agents/test-helpers/
   ```

5. Run root-level agent tests:
   ```bash
   pnpm vitest run src/agents/ --reporter=verbose --ignore='src/agents/*/'
   ```
   (This runs only root-level tests, not subdirectory tests which are handled by 03-06)

   If vitest doesn't support --ignore for subdirectories, run:
   ```bash
   pnpm vitest run src/agents/*.test.js --reporter=verbose
   ```

6. Verify zero .ts at root level:
   ```bash
   find src/agents/ -maxdepth 1 -name '*.ts' | wc -l
   ```
  </action>
  <verify>
- `find src/agents/ -maxdepth 1 -name '*.ts' | wc -l` returns 0
- `find src/agents/test-helpers/ -name '*.ts' | wc -l` returns 0
- `pnpm eslint src/agents/*.test.js` reports 0 errors
- Root-level agent tests pass
  </verify>
  <done>
All 183 root-level agent test files and 2 test helper files are .js. Root-level agent tests pass. Zero .ts files at agents root level.
  </done>
</task>

</tasks>

<verification>
- `find src/agents/ -maxdepth 1 -name '*.ts' | wc -l` returns 0
- `find src/agents/test-helpers/ -name '*.ts' | wc -l` returns 0
- Root-level agent tests pass
- `pnpm eslint src/agents/*.js src/agents/*.test.js` 0 errors
- SECURITY annotations on cli-credentials.js and model-auth.js
</verification>

<success_criteria>
1. Zero .ts files at src/agents/ root level (maxdepth 1)
2. Zero .ts files in src/agents/test-helpers/
3. SECURITY annotations on cli-credentials.js and model-auth.js
4. Interface declarations converted to JSDoc @typedef
5. All root-level agent tests pass
6. ESLint reports 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-services/03-05-SUMMARY.md`
</output>
