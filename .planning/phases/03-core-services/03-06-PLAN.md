---
phase: 03-core-services
plan: 06
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/agents/auth-profiles/*.ts
  - src/agents/cli-runner/*.ts
  - src/agents/pi-embedded-helpers/*.ts
  - src/agents/pi-embedded-runner/*.ts
  - src/agents/pi-extensions/*.ts
  - src/agents/sandbox/*.ts
  - src/agents/schema/*.ts
  - src/agents/skills/*.ts
  - src/agents/tools/*.ts
autonomous: true

must_haves:
  truths:
    - "All files in agents subdirectories are .js with no .ts remaining"
    - "Security-sensitive auth-profiles files have SECURITY: annotations"
    - "All existing subdirectory tests pass after conversion"
    - "Cross-module imports to Phase 4+ directories preserved with .js extensions"
  artifacts:
    - path: "src/agents/auth-profiles/*.js"
      provides: "Auth credential storage and OAuth modules"
    - path: "src/agents/tools/*.js"
      provides: "Agent tool implementations"
    - path: "src/agents/pi-embedded-runner/*.js"
      provides: "Pi embedded runner modules"
    - path: "src/agents/skills/*.js"
      provides: "Agent skill implementations"
    - path: "src/agents/sandbox/*.js"
      provides: "Agent sandbox modules"
  key_links:
    - from: "src/agents/auth-profiles/store.js"
      to: "credential storage"
      via: "API key and OAuth token storage"
      pattern: "SECURITY:"
    - from: "src/agents/auth-profiles/oauth.js"
      to: "OAuth token exchange"
      via: "token refresh and exchange flows"
      pattern: "SECURITY:"
    - from: "src/agents/tools/*.js"
      to: "src/agents/*.js"
      via: "tool registration and dispatch"
      pattern: "import.*from"
---

<objective>
Convert all agents subdirectory source and test files (~159 files, ~29.7K lines) from TypeScript to JavaScript using esbuild bulk conversion.

Purpose: The agents subdirectories contain tool implementations (38 source + 22 tests), Pi embedded runner (24 source + 6 tests), auth profiles (13 source + 2 tests), sandbox (16 source + 1 test), skills (10 source + 3 tests), and smaller modules (pi-helpers, pi-extensions, cli-runner, schema). Auth-profiles has 4 security-sensitive files needing SECURITY annotations.
Output: All agents subdirectory files converted to .js with SECURITY annotations on auth-profiles, module-level JSDoc, and all subdirectory tests passing.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-services/03-RESEARCH.md
@.planning/phases/02-foundation-layer/02-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bulk convert agents subdirectory source files</name>
  <files>
    src/agents/auth-profiles/*.ts (13 source + 2 tests = 15 files, ~2.2K lines)
    src/agents/cli-runner/*.ts (1 source, ~100 lines)
    src/agents/pi-embedded-helpers/*.ts (9 source, ~1.5K lines)
    src/agents/pi-embedded-runner/*.ts (24 source + 6 tests = 30 files, ~5.5K lines)
    src/agents/pi-extensions/*.ts (8 source + 2 tests = 10 files, ~1.2K lines)
    src/agents/sandbox/*.ts (16 source + 1 test = 17 files, ~1.9K lines)
    src/agents/schema/*.ts (2 source, ~300 lines)
    src/agents/skills/*.ts (10 source + 3 tests = 13 files, ~1.5K lines)
    Total: ~106 files
  </files>
  <action>
1. Use esbuild bulk conversion on ALL agents subdirectories (recursive within each subdir):
   - For each subdirectory (auth-profiles, cli-runner, pi-embedded-helpers, pi-embedded-runner, pi-extensions, sandbox, schema, skills):
     - Run esbuild transformSync on all .ts files
     - Write .js output, delete .ts originals
   - Do NOT touch src/agents/tools/ -- that is Task 2

2. Post-process: SECURITY annotations for auth-profiles (4 security-sensitive files):
   - `auth-profiles/store.js` -- Auth credential storage (document API key storage, encryption at rest if applicable, credential lifecycle)
   - `auth-profiles/oauth.js` -- OAuth token refresh and exchange (document token refresh flow, credential forwarding)
   - `auth-profiles/profiles.js` -- Profile credential access (document credential scoping per profile)
   - `auth-profiles/types.js` -- If this becomes a JSDoc typedef-only file after conversion, keep for documentation. Add SECURITY: note about credential type definitions.

3. Post-process: Fix esbuild artifacts across all subdirectories:
   - Replace `== null` / `!= null` with strict equality
   - Remove unused imports
   - Fix empty catch blocks with explanatory comments
   - Add module-level JSDoc comments to each source file

4. Post-process: Handle TS-specific patterns:
   - `private` keywords (2 in agents, may be in subdirectories) -- underscore prefix
   - `export type` declarations -- JSDoc @typedef for important ones, delete others
   - `satisfies` (some may be in subdirectories) -- esbuild handles automatically

5. Apply QUAL-01/QUAL-02 where obviously beneficial

6. Run eslint --fix on all converted subdirectories (excluding tools/):
   ```bash
   pnpm eslint --fix src/agents/auth-profiles/ src/agents/cli-runner/ src/agents/pi-embedded-helpers/ src/agents/pi-embedded-runner/ src/agents/pi-extensions/ src/agents/sandbox/ src/agents/schema/ src/agents/skills/
   ```
  </action>
  <verify>
- For each subdir: `find src/agents/{auth-profiles,cli-runner,pi-embedded-helpers,pi-embedded-runner,pi-extensions,sandbox,schema,skills} -name '*.ts' | wc -l` returns 0
- `pnpm eslint src/agents/auth-profiles/ src/agents/cli-runner/ src/agents/pi-embedded-helpers/ src/agents/pi-embedded-runner/ src/agents/pi-extensions/ src/agents/sandbox/ src/agents/schema/ src/agents/skills/` reports 0 errors
- `grep -rl 'SECURITY:' src/agents/auth-profiles/*.js | wc -l` returns at least 3
  </verify>
  <done>
All agents subdirectory files (excluding tools/) are .js with SECURITY annotations on auth-profiles, module-level JSDoc, and esbuild artifacts fixed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert agents tools and verify all subdirectory tests</name>
  <files>
    src/agents/tools/*.ts (38 source + 22 tests = 60 files, ~14.4K lines)
  </files>
  <action>
1. Use esbuild bulk conversion on src/agents/tools/:
   - Convert all 60 .ts files (38 source + 22 tests)
   - esbuild transformSync, write .js, delete .ts

2. Post-process tools/ files:
   - Replace `== null` / `!= null` with strict equality
   - Remove unused imports
   - Add module-level JSDoc comments to source files
   - Fix any `export type` declarations (convert to JSDoc @typedef or delete)
   - Apply QUAL-01/QUAL-02 where obviously beneficial

3. Run eslint --fix on tools/:
   ```bash
   pnpm eslint --fix src/agents/tools/
   ```

4. Run ALL agents subdirectory tests to verify everything works together:
   ```bash
   pnpm vitest run src/agents/auth-profiles/ src/agents/pi-embedded-runner/ src/agents/pi-extensions/ src/agents/sandbox/ src/agents/skills/ src/agents/tools/ --reporter=verbose
   ```

5. Verify zero .ts files remain in ALL agents subdirectories:
   ```bash
   find src/agents/auth-profiles/ src/agents/cli-runner/ src/agents/pi-embedded-helpers/ src/agents/pi-embedded-runner/ src/agents/pi-extensions/ src/agents/sandbox/ src/agents/schema/ src/agents/skills/ src/agents/tools/ -name '*.ts' | wc -l
   ```
  </action>
  <verify>
- `find src/agents/*/ -name '*.ts' | wc -l` returns 0 (all subdirectories clean)
- `pnpm eslint src/agents/tools/` reports 0 errors
- All agents subdirectory tests pass
  </verify>
  <done>
All agents subdirectory files (including tools/) are .js. All subdirectory tests pass. Zero .ts files in any agents subdirectory. Combined with 03-05, the entire src/agents/ directory is fully converted.
  </done>
</task>

</tasks>

<verification>
- `find src/agents/*/ -name '*.ts' | wc -l` returns 0
- All agents subdirectory tests pass
- `pnpm eslint src/agents/*/` 0 errors
- SECURITY annotations on auth-profiles store, oauth, profiles files
</verification>

<success_criteria>
1. Zero .ts files in any agents subdirectory
2. SECURITY annotations on auth-profiles/store.js, oauth.js, profiles.js
3. All module-level JSDoc comments present
4. All subdirectory tests pass
5. ESLint reports 0 errors
6. Cross-module imports to Phase 4+ directories preserved unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-services/03-06-SUMMARY.md`
</output>
