---
phase: 02-foundation-layer
plan: 05
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/infra/fetch.ts -> .js
  - src/infra/fetch.test.ts -> .test.js
  - src/infra/archive.ts -> .js
  - src/infra/archive.test.ts -> .test.js
  - src/infra/errors.ts -> .js
  - src/infra/dedupe.ts -> .js
  - src/infra/dedupe.test.ts -> .test.js
  - src/infra/backoff.ts -> .js
  - src/infra/retry.ts -> .js
  - src/infra/retry.test.ts -> .test.js
  - src/infra/retry-policy.ts -> .js
  - src/infra/retry-policy.test.ts -> .test.js
  - src/infra/format-duration.ts -> .js
  - src/infra/fs-safe.ts -> .js
  - src/infra/json-file.ts -> .js
  - src/infra/is-main.ts -> .js
  - src/infra/is-main.test.ts -> .test.js
  - src/infra/machine-name.ts -> .js
  - src/infra/os-summary.ts -> .js
  - src/infra/openclaw-root.ts -> .js
  - src/infra/brew.ts -> .js
  - src/infra/brew.test.ts -> .test.js
  - src/infra/canvas-host-url.ts -> .js
  - src/infra/clipboard.ts -> .js
  - src/infra/control-ui-assets.ts -> .js
  - src/infra/control-ui-assets.test.ts -> .test.js
  - src/infra/git-commit.ts -> .js
  - src/infra/voicewake.ts -> .js
  - src/infra/voicewake.test.ts -> .test.js
  - src/infra/warnings.ts -> .js
  - src/infra/ports.ts -> .js
  - src/infra/ports.test.ts -> .test.js
  - src/infra/ports-format.ts -> .js
  - src/infra/ports-inspect.ts -> .js
  - src/infra/ports-inspect.test.ts -> .test.js
  - src/infra/ports-lsof.ts -> .js
  - src/infra/ports-types.ts -> .js
  - src/infra/binaries.ts -> .js
  - src/infra/binaries.test.ts -> .test.js
  - src/infra/ws.ts -> .js
  - src/infra/wsl.ts -> .js
  - src/infra/node-shell.ts -> .js
  - src/infra/node-shell.test.ts -> .test.js
autonomous: true

must_haves:
  truths:
    - "Core utility modules (retry, backoff, dedupe, errors, fetch) are JavaScript"
    - "File system utilities (fs-safe, json-file, archive) are JavaScript"
    - "Port inspection and process management modules are JavaScript"
    - "Platform utilities (brew, wsl, clipboard, voicewake) are JavaScript"
    - "All tests pass for converted modules"
  artifacts:
    - path: "src/infra/retry.js"
      provides: "Async retry with exponential backoff"
    - path: "src/infra/errors.js"
      provides: "Error formatting and code extraction"
    - path: "src/infra/fetch.js"
      provides: "HTTP fetch wrapper"
    - path: "src/infra/ports.js"
      provides: "Port availability checking"
    - path: "src/infra/fs-safe.js"
      provides: "Safe filesystem operations"
  key_links:
    - from: "src/infra/retry.js"
      to: "src/utils.js"
      via: "sleep import"
      pattern: "import.*sleep.*utils"
    - from: "src/infra/ports.js"
      to: "src/infra/ports-inspect.js"
      via: "port inspection delegation"
      pattern: "import.*ports-inspect"
---

<objective>
Convert miscellaneous infrastructure utility modules in src/infra/ to JavaScript.

Purpose: This covers the remaining root-level src/infra/ files -- a collection of independent utility modules for retry logic, file I/O, port management, platform detection, and other small concerns. Most files are under 150 lines. While there are ~43 files, they are individually simple and follow the same mechanical conversion pattern.

Output: ~43 files converted from .ts to .js with JSDoc annotations and module-level comments.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation-layer/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert core utility and file I/O modules</name>
  <files>
    src/infra/fetch.ts -> .js
    src/infra/fetch.test.ts -> .test.js
    src/infra/archive.ts -> .js
    src/infra/archive.test.ts -> .test.js
    src/infra/errors.ts -> .js
    src/infra/dedupe.ts -> .js
    src/infra/dedupe.test.ts -> .test.js
    src/infra/backoff.ts -> .js
    src/infra/retry.ts -> .js
    src/infra/retry.test.ts -> .test.js
    src/infra/retry-policy.ts -> .js
    src/infra/retry-policy.test.ts -> .test.js
    src/infra/format-duration.ts -> .js
    src/infra/fs-safe.ts -> .js
    src/infra/json-file.ts -> .js
    src/infra/is-main.ts -> .js
    src/infra/is-main.test.ts -> .test.js
    src/infra/machine-name.ts -> .js
    src/infra/os-summary.ts -> .js
    src/infra/openclaw-root.ts -> .js
    src/infra/warnings.ts -> .js
  </files>
  <action>
    Convert each file from TypeScript to JavaScript following 02-RESEARCH.md patterns:

    1. Read .ts, write .js with conversions, delete .ts.

    2. **Module-level comments (QUAL-04):** Add purpose comments to every file. Most are small and self-explanatory -- keep comments concise (1-3 lines).

    3. **Key conversion notes:**
       - **retry.ts** (136 lines): Has a generic `retryAsync<T>` -- remove `<T>`, use `@param {() => Promise<*>} fn` in JSDoc. See research Pattern 5.
       - **errors.ts** (40 lines): Has `(err as { code?: unknown }).code` -- convert to `err?.code`. See research Pattern 4.
       - **fs-safe.ts** (105 lines): Safe file operations. Add SECURITY comment if it handles file permissions.
       - **json-file.ts** (23 lines): Tiny module. Quick conversion.
       - **openclaw-root.ts** (125 lines): Resolves the installation root path.
       - **format-duration.ts**, **backoff.ts**: Small pure utility functions.

    4. Strip type annotations, remove `import type`, remove `as` assertions, add JSDoc. Run `eslint --fix`.
  </action>
  <verify>
    - `npx vitest run src/infra/fetch.test.js src/infra/archive.test.js src/infra/dedupe.test.js src/infra/retry.test.js src/infra/retry-policy.test.js src/infra/is-main.test.js --reporter=verbose` passes
    - `npx eslint src/infra/retry.js src/infra/errors.js src/infra/fetch.js src/infra/fs-safe.js` passes
  </verify>
  <done>21 core utility files converted. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Convert platform, port management, and remaining utility modules</name>
  <files>
    src/infra/brew.ts -> .js
    src/infra/brew.test.ts -> .test.js
    src/infra/canvas-host-url.ts -> .js
    src/infra/clipboard.ts -> .js
    src/infra/control-ui-assets.ts -> .js
    src/infra/control-ui-assets.test.ts -> .test.js
    src/infra/git-commit.ts -> .js
    src/infra/voicewake.ts -> .js
    src/infra/voicewake.test.ts -> .test.js
    src/infra/ports.ts -> .js
    src/infra/ports.test.ts -> .test.js
    src/infra/ports-format.ts -> .js
    src/infra/ports-inspect.ts -> .js
    src/infra/ports-inspect.test.ts -> .test.js
    src/infra/ports-lsof.ts -> .js
    src/infra/ports-types.ts -> .js
    src/infra/binaries.ts -> .js
    src/infra/binaries.test.ts -> .test.js
    src/infra/ws.ts -> .js
    src/infra/wsl.ts -> .js
    src/infra/node-shell.ts -> .js
    src/infra/node-shell.test.ts -> .test.js
  </files>
  <action>
    Convert each file from TypeScript to JavaScript:

    1. Apply standard conversion patterns from 02-RESEARCH.md.

    2. **Module-level comments (QUAL-04):**
       - ports-inspect.ts (296 lines): Explain how port inspection works (lsof/netstat parsing)
       - control-ui-assets.ts (222 lines): Explain UI asset management for the control panel
       - canvas-host-url.ts: Explain canvas/A2UI host URL resolution
       - voicewake.ts: Explain voice wake word detection integration
       - git-commit.ts: Explain automated git commit creation

    3. **ports-types.ts** is type-only (20 lines) -- convert to JSDoc `@typedef` file, similar to provider-usage.types.

    4. **ws.ts** (21 lines) and **wsl.ts** (28 lines) and **node-shell.ts** (9 lines) are tiny. Quick conversions.

    5. Strip type annotations, remove `import type`, remove `as` assertions, add JSDoc. Run `eslint --fix`.
  </action>
  <verify>
    - `npx vitest run src/infra/brew.test.js src/infra/control-ui-assets.test.js src/infra/voicewake.test.js src/infra/ports.test.js src/infra/ports-inspect.test.js src/infra/binaries.test.js src/infra/node-shell.test.js --reporter=verbose` passes
    - `npx eslint src/infra/ports-inspect.js src/infra/control-ui-assets.js src/infra/ports-types.js` passes
  </verify>
  <done>22 platform/utility files converted. Port types are JSDoc typedefs. All tests pass.</done>
</task>

</tasks>

<verification>
1. No .ts files remain for any of the 43 files in this plan
2. All converted files have module-level purpose comments
3. All test files pass
4. ESLint passes on all converted files
</verification>

<success_criteria>
- 43 files converted from .ts to .js
- Type-only files (ports-types) contain JSDoc typedefs
- All tests pass
- ESLint reports no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation-layer/02-05-SUMMARY.md`
</output>
