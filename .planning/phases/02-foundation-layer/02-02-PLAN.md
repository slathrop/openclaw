---
phase: 02-foundation-layer
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/infra/device-auth-store.ts -> .js
  - src/infra/device-identity.ts -> .js
  - src/infra/device-pairing.ts -> .js
  - src/infra/device-pairing.test.ts -> .test.js
  - src/infra/node-pairing.ts -> .js
  - src/infra/exec-approvals.ts -> .js
  - src/infra/exec-approvals.test.ts -> .test.js
  - src/infra/exec-approval-forwarder.ts -> .js
  - src/infra/exec-approval-forwarder.test.ts -> .test.js
  - src/infra/exec-host.ts -> .js
  - src/infra/exec-safety.ts -> .js
  - src/infra/runtime-guard.ts -> .js
  - src/infra/runtime-guard.test.ts -> .test.js
  - src/infra/unhandled-rejections.ts -> .js
  - src/infra/unhandled-rejections.test.ts -> .test.js
  - src/infra/unhandled-rejections.fatal-detection.test.ts -> .test.js
  - src/infra/heartbeat-runner.ts -> .js
  - src/infra/heartbeat-events.ts -> .js
  - src/infra/heartbeat-visibility.ts -> .js
  - src/infra/heartbeat-visibility.test.ts -> .test.js
  - src/infra/heartbeat-wake.ts -> .js
  - src/infra/heartbeat-runner.respects-ackmaxchars-heartbeat-acks.test.ts -> .test.js
  - src/infra/heartbeat-runner.returns-default-unset.test.ts -> .test.js
  - src/infra/heartbeat-runner.scheduler.test.ts -> .test.js
  - src/infra/heartbeat-runner.sender-prefers-delivery-target.test.ts -> .test.js
  - src/infra/system-events.ts -> .js
  - src/infra/system-events.test.ts -> .test.js
  - src/infra/system-presence.ts -> .js
  - src/infra/system-presence.test.ts -> .test.js
  - src/infra/diagnostic-events.ts -> .js
  - src/infra/diagnostic-events.test.ts -> .test.js
  - src/infra/diagnostic-flags.ts -> .js
  - src/infra/diagnostic-flags.test.ts -> .test.js
  - src/infra/transport-ready.ts -> .js
  - src/infra/transport-ready.test.ts -> .test.js
  - src/infra/agent-events.ts -> .js
  - src/infra/agent-events.test.ts -> .test.js
  - src/infra/channel-activity.ts -> .js
  - src/infra/channel-activity.test.ts -> .test.js
  - src/infra/channel-summary.ts -> .js
  - src/infra/channels-status-issues.ts -> .js
autonomous: true

must_haves:
  truths:
    - "Device auth store, identity, and pairing modules are JavaScript with security comments on credential handling"
    - "Exec approval system (exec-approvals, exec-approval-forwarder, exec-host, exec-safety) is JavaScript"
    - "Heartbeat runner and all heartbeat support modules are JavaScript"
    - "System presence, diagnostics, and event modules are JavaScript"
    - "All tests pass for converted modules"
  artifacts:
    - path: "src/infra/device-auth-store.js"
      provides: "Device auth token persistence"
      contains: "SECURITY:"
    - path: "src/infra/exec-approvals.js"
      provides: "Execution approval system"
      contains: "SECURITY:"
    - path: "src/infra/heartbeat-runner.js"
      provides: "Heartbeat scheduling and delivery"
    - path: "src/infra/system-presence.js"
      provides: "System presence detection"
  key_links:
    - from: "src/infra/exec-approval-forwarder.js"
      to: "src/utils/message-channel.js"
      via: "normalizeMessageChannel import"
      pattern: "import.*normalizeMessageChannel.*message-channel"
    - from: "src/infra/heartbeat-runner.js"
      to: "src/infra/heartbeat-events.js"
      via: "event type imports"
      pattern: "import.*heartbeat-events"
---

<objective>
Convert device/auth/security modules and heartbeat/system/diagnostics modules in src/infra/ to JavaScript.

Purpose: This covers security-critical infrastructure (device auth, exec approvals, pairing) that requires QUAL-05 security comments, plus the heartbeat/monitoring subsystem. These are a natural cluster because device identity feeds into system presence and heartbeat delivery targeting.

Output: ~41 files converted from .ts to .js with JSDoc annotations, module comments, and security annotations.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation-layer/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert device/auth/security and exec-approval modules</name>
  <files>
    src/infra/device-auth-store.ts -> .js
    src/infra/device-identity.ts -> .js
    src/infra/device-pairing.ts -> .js
    src/infra/device-pairing.test.ts -> .test.js
    src/infra/node-pairing.ts -> .js
    src/infra/exec-approvals.ts -> .js
    src/infra/exec-approvals.test.ts -> .test.js
    src/infra/exec-approval-forwarder.ts -> .js
    src/infra/exec-approval-forwarder.test.ts -> .test.js
    src/infra/exec-host.ts -> .js
    src/infra/exec-safety.ts -> .js
    src/infra/runtime-guard.ts -> .js
    src/infra/runtime-guard.test.ts -> .test.js
    src/infra/unhandled-rejections.ts -> .js
    src/infra/unhandled-rejections.test.ts -> .test.js
    src/infra/unhandled-rejections.fatal-detection.test.ts -> .test.js
  </files>
  <action>
    Convert each file from TypeScript to JavaScript following the patterns in 02-RESEARCH.md:

    1. Read the .ts file, write the .js version with conversions applied, delete the .ts file.

    2. **Module-level comment (QUAL-04):** Add a top-of-file JSDoc block explaining the module's purpose.

    3. **Security comments (QUAL-05):** These modules handle auth tokens, device identity, exec approvals, and credential storage. Add explicit `SECURITY:` comments on:
       - File permission settings (0o600) in device-auth-store
       - Token validation and scoping in device-identity
       - Approval flow gating in exec-approvals (explain why approval is required before execution)
       - Pairing protocol security in device-pairing and node-pairing
       - Unhandled rejection safety in unhandled-rejections (explain crash-vs-continue decision)
       - Runtime guard safety checks

    4. **Strip type annotations**, remove `import type`, convert `export type` to JSDoc `@typedef`, remove `as` assertions. Add `@param`/`@returns` JSDoc on non-obvious functions.

    5. **Replace TS-only types:** `NodeJS.ProcessEnv` -> `{object}`, `NodeJS.Timeout` -> `{*}`.

    6. **Run `eslint --fix`** on each converted file.

    7. **Import paths stay unchanged.** Imports to modules outside this plan's scope (e.g., `../agents/`, `../channels/`) remain as-is -- they still point to .ts files via .js extension paths, which vitest/rolldown resolve.

    Note: exec-approvals.ts is the largest file (1509 lines). Take care to preserve all approval flow logic. The `as` assertions in this file are likely used for error property access -- convert to optional chaining.
  </action>
  <verify>
    - `find src/infra/ -name 'device-*' -name '*.ts' | wc -l` returns 0
    - `find src/infra/ -name 'exec-*' -name '*.ts' | wc -l` returns 0
    - `npx eslint src/infra/device-auth-store.js src/infra/device-identity.js src/infra/exec-approvals.js src/infra/runtime-guard.js src/infra/unhandled-rejections.js` passes
    - `npx vitest run src/infra/device-pairing.test.js src/infra/exec-approvals.test.js src/infra/exec-approval-forwarder.test.js src/infra/runtime-guard.test.js src/infra/unhandled-rejections.test.js src/infra/unhandled-rejections.fatal-detection.test.js --reporter=verbose` passes
  </verify>
  <done>16 files converted. Security-sensitive modules have SECURITY: comments. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Convert heartbeat/system/diagnostics modules</name>
  <files>
    src/infra/heartbeat-runner.ts -> .js
    src/infra/heartbeat-events.ts -> .js
    src/infra/heartbeat-visibility.ts -> .js
    src/infra/heartbeat-visibility.test.ts -> .test.js
    src/infra/heartbeat-wake.ts -> .js
    src/infra/heartbeat-runner.respects-ackmaxchars-heartbeat-acks.test.ts -> .test.js
    src/infra/heartbeat-runner.returns-default-unset.test.ts -> .test.js
    src/infra/heartbeat-runner.scheduler.test.ts -> .test.js
    src/infra/heartbeat-runner.sender-prefers-delivery-target.test.ts -> .test.js
    src/infra/system-events.ts -> .js
    src/infra/system-events.test.ts -> .test.js
    src/infra/system-presence.ts -> .js
    src/infra/system-presence.test.ts -> .test.js
    src/infra/diagnostic-events.ts -> .js
    src/infra/diagnostic-events.test.ts -> .test.js
    src/infra/diagnostic-flags.ts -> .js
    src/infra/diagnostic-flags.test.ts -> .test.js
    src/infra/transport-ready.ts -> .js
    src/infra/transport-ready.test.ts -> .test.js
    src/infra/agent-events.ts -> .js
    src/infra/agent-events.test.ts -> .test.js
    src/infra/channel-activity.ts -> .js
    src/infra/channel-activity.test.ts -> .test.js
    src/infra/channel-summary.ts -> .js
    src/infra/channels-status-issues.ts -> .js
  </files>
  <action>
    Convert each file applying the same patterns as Task 1.

    Key notes for this batch:
    - **heartbeat-runner.ts** is 1011 lines -- the largest file in this task. It orchestrates heartbeat scheduling and delivery. Add comments explaining the scheduling algorithm and retry logic.
    - **heartbeat-runner has 4 separate test files** with long descriptive names. Convert all 4. They total ~1,868 test lines. The tests themselves have minimal TypeScript -- mostly quote style and occasional type annotations in mock setup.
    - **system-presence.ts** (305 lines) detects whether the gateway is reachable. Add comments explaining the detection heuristics.
    - **channel-summary.ts** and **channels-status-issues.ts** have no test files -- just convert the source.
    - **diagnostic-flags.ts** controls feature flags for diagnostics -- add a comment explaining the flag system.

    Apply QUAL-04 (module comments), QUAL-05 (security/complexity comments where relevant), QUAL-06 (JSDoc on non-obvious functions).
  </action>
  <verify>
    - `npx vitest run src/infra/heartbeat-visibility.test.js src/infra/heartbeat-runner.respects-ackmaxchars-heartbeat-acks.test.js src/infra/heartbeat-runner.returns-default-unset.test.js src/infra/heartbeat-runner.scheduler.test.js src/infra/heartbeat-runner.sender-prefers-delivery-target.test.js src/infra/system-events.test.js src/infra/system-presence.test.js src/infra/diagnostic-events.test.js src/infra/diagnostic-flags.test.js src/infra/transport-ready.test.js src/infra/agent-events.test.js src/infra/channel-activity.test.js --reporter=verbose` passes
    - `npx eslint src/infra/heartbeat-runner.js src/infra/system-presence.js src/infra/diagnostic-events.js src/infra/channel-summary.js` passes
  </verify>
  <done>25 files converted. Heartbeat, system monitoring, and diagnostics modules are JavaScript with module comments and JSDoc. All tests pass.</done>
</task>

</tasks>

<verification>
1. No .ts files remain for any of the 41 files listed in this plan
2. All converted files have top-of-file module purpose comments
3. Security-sensitive modules (device-auth-store, exec-approvals, device-pairing) have SECURITY: comments
4. All test files pass when run with vitest
5. ESLint passes on all converted files
</verification>

<success_criteria>
- 41 files converted from .ts to .js
- Zero .ts files remain for any file in this plan's scope
- Security modules have explicit SECURITY: comments per QUAL-05
- All heartbeat, diagnostic, and system tests pass
- ESLint reports no errors on converted files
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation-layer/02-02-SUMMARY.md`
</output>
