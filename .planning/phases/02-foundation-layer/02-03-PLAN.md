---
phase: 02-foundation-layer
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/infra/update-check.ts -> .js
  - src/infra/update-check.test.ts -> .test.js
  - src/infra/update-runner.ts -> .js
  - src/infra/update-runner.test.ts -> .test.js
  - src/infra/update-startup.ts -> .js
  - src/infra/update-startup.test.ts -> .test.js
  - src/infra/update-channels.ts -> .js
  - src/infra/update-global.ts -> .js
  - src/infra/restart.ts -> .js
  - src/infra/restart.test.ts -> .test.js
  - src/infra/restart-sentinel.ts -> .js
  - src/infra/restart-sentinel.test.ts -> .test.js
  - src/infra/state-migrations.ts -> .js
  - src/infra/state-migrations.fs.ts -> .js
  - src/infra/state-migrations.fs.test.ts -> .test.js
  - src/infra/gateway-lock.ts -> .js
  - src/infra/gateway-lock.test.ts -> .test.js
  - src/infra/bonjour.ts -> .js
  - src/infra/bonjour.test.ts -> .test.js
  - src/infra/bonjour-discovery.ts -> .js
  - src/infra/bonjour-discovery.test.ts -> .test.js
  - src/infra/bonjour-ciao.ts -> .js
  - src/infra/bonjour-errors.ts -> .js
  - src/infra/tailscale.ts -> .js
  - src/infra/tailscale.test.ts -> .test.js
  - src/infra/tailnet.ts -> .js
  - src/infra/tailnet.test.ts -> .test.js
  - src/infra/widearea-dns.ts -> .js
  - src/infra/widearea-dns.test.ts -> .test.js
  - src/infra/ssh-config.ts -> .js
  - src/infra/ssh-config.test.ts -> .test.js
  - src/infra/ssh-tunnel.ts -> .js
  - src/infra/ssh-tunnel.test.ts -> .test.js
autonomous: true

must_haves:
  truths:
    - "Update system (check, runner, startup, channels, global) is JavaScript"
    - "State migration system is JavaScript with comments explaining migration strategy"
    - "Network discovery (bonjour, tailscale, widearea-dns) is JavaScript"
    - "SSH config and tunnel modules are JavaScript with security comments"
    - "All tests pass for converted modules"
  artifacts:
    - path: "src/infra/update-runner.js"
      provides: "Auto-update orchestration"
    - path: "src/infra/state-migrations.js"
      provides: "State file migration logic"
    - path: "src/infra/bonjour-discovery.js"
      provides: "mDNS/Bonjour device discovery"
    - path: "src/infra/tailscale.js"
      provides: "Tailscale network integration"
    - path: "src/infra/ssh-tunnel.js"
      provides: "SSH tunnel management"
      contains: "SECURITY:"
  key_links:
    - from: "src/infra/update-runner.js"
      to: "src/infra/update-check.js"
      via: "update availability check"
      pattern: "import.*update-check"
    - from: "src/infra/bonjour-discovery.js"
      to: "src/infra/bonjour.js"
      via: "bonjour service registration"
      pattern: "import.*bonjour"
---

<objective>
Convert update system, state migration, network discovery, and SSH modules in src/infra/ to JavaScript.

Purpose: These modules handle the update lifecycle (checking, downloading, applying updates), persistent state migrations, and network discovery/tunneling. The update and migration systems are complex enough to warrant dedicated comments explaining their strategies.

Output: ~33 files converted from .ts to .js with JSDoc annotations and module-level comments.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation-layer/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert update system and state migration modules</name>
  <files>
    src/infra/update-check.ts -> .js
    src/infra/update-check.test.ts -> .test.js
    src/infra/update-runner.ts -> .js
    src/infra/update-runner.test.ts -> .test.js
    src/infra/update-startup.ts -> .js
    src/infra/update-startup.test.ts -> .test.js
    src/infra/update-channels.ts -> .js
    src/infra/update-global.ts -> .js
    src/infra/restart.ts -> .js
    src/infra/restart.test.ts -> .test.js
    src/infra/restart-sentinel.ts -> .js
    src/infra/restart-sentinel.test.ts -> .test.js
    src/infra/state-migrations.ts -> .js
    src/infra/state-migrations.fs.ts -> .js
    src/infra/state-migrations.fs.test.ts -> .test.js
    src/infra/gateway-lock.ts -> .js
    src/infra/gateway-lock.test.ts -> .test.js
  </files>
  <action>
    Convert each file from TypeScript to JavaScript following 02-RESEARCH.md patterns:

    1. Read the .ts file, write the .js version with conversions, delete the .ts file.

    2. **Module-level comments (QUAL-04):** Especially important for:
       - update-runner.ts (846 lines): Explain the update orchestration flow (check -> download -> verify -> apply -> restart)
       - state-migrations.ts (905 lines): Explain the migration versioning strategy and how migrations are discovered/applied
       - gateway-lock.ts (260 lines): Explain the lock file mechanism for preventing concurrent gateway instances

    3. **Strip type annotations**, remove `import type`, convert `export type` to `@typedef`, remove `as` assertions.

    4. **JSDoc (QUAL-06):** Add `@param`/`@returns` on non-obvious functions, especially in update-runner and state-migrations where function signatures are complex.

    5. **Run `eslint --fix`** on each converted file.

    6. Import paths stay unchanged.
  </action>
  <verify>
    - `npx vitest run src/infra/update-check.test.js src/infra/update-runner.test.js src/infra/update-startup.test.js src/infra/restart.test.js src/infra/restart-sentinel.test.js src/infra/state-migrations.fs.test.js src/infra/gateway-lock.test.js --reporter=verbose` passes
    - `npx eslint src/infra/update-runner.js src/infra/state-migrations.js src/infra/gateway-lock.js` passes
  </verify>
  <done>17 files converted. Update system and state migrations are JavaScript with module-level comments. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Convert network discovery and SSH modules</name>
  <files>
    src/infra/bonjour.ts -> .js
    src/infra/bonjour.test.ts -> .test.js
    src/infra/bonjour-discovery.ts -> .js
    src/infra/bonjour-discovery.test.ts -> .test.js
    src/infra/bonjour-ciao.ts -> .js
    src/infra/bonjour-errors.ts -> .js
    src/infra/tailscale.ts -> .js
    src/infra/tailscale.test.ts -> .test.js
    src/infra/tailnet.ts -> .js
    src/infra/tailnet.test.ts -> .test.js
    src/infra/widearea-dns.ts -> .js
    src/infra/widearea-dns.test.ts -> .test.js
    src/infra/ssh-config.ts -> .js
    src/infra/ssh-config.test.ts -> .test.js
    src/infra/ssh-tunnel.ts -> .js
    src/infra/ssh-tunnel.test.ts -> .test.js
  </files>
  <action>
    Convert each file from TypeScript to JavaScript:

    1. Apply standard conversion patterns from 02-RESEARCH.md.

    2. **Module-level comments (QUAL-04):**
       - bonjour-discovery.ts (603 lines): Explain mDNS service discovery protocol and how OpenClaw uses it for local device detection
       - tailscale.ts (495 lines): Explain Tailscale integration for secure network access
       - ssh-tunnel.ts: Explain SSH tunnel lifecycle management

    3. **Security comments (QUAL-05):**
       - ssh-config.ts: Add SECURITY comments on SSH key handling and config file parsing
       - ssh-tunnel.ts: Add SECURITY comments on tunnel establishment and port forwarding security
       - tailscale.ts: Note that Tailscale provides encrypted mesh networking

    4. **Strip type annotations**, remove `import type`, convert `export type` to `@typedef`, remove `as` assertions. Add JSDoc on non-obvious functions.

    5. **Run `eslint --fix`** on each converted file.

    Note: bonjour-ciao.ts (11 lines) and bonjour-errors.ts (7 lines) are tiny -- quick conversions.
  </action>
  <verify>
    - `npx vitest run src/infra/bonjour.test.js src/infra/bonjour-discovery.test.js src/infra/tailscale.test.js src/infra/tailnet.test.js src/infra/widearea-dns.test.js src/infra/ssh-config.test.js src/infra/ssh-tunnel.test.js --reporter=verbose` passes
    - `npx eslint src/infra/bonjour-discovery.js src/infra/tailscale.js src/infra/ssh-tunnel.js` passes
  </verify>
  <done>16 files converted. Network discovery and SSH modules are JavaScript with module and security comments. All tests pass.</done>
</task>

</tasks>

<verification>
1. No .ts files remain for any of the 33 files in this plan
2. All converted files have top-of-file module purpose comments
3. SSH modules have SECURITY: comments
4. All test files pass when run with vitest
5. ESLint passes on all converted files
</verification>

<success_criteria>
- 33 files converted from .ts to .js
- Zero .ts files remain for files in this plan's scope
- Update system, state migrations, network discovery, and SSH modules are all JavaScript
- All tests pass
- ESLint reports no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation-layer/02-03-SUMMARY.md`
</output>
