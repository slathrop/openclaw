---
phase: 02-foundation-layer
plan: 10
type: execute
wave: 3
depends_on: ["02-02", "02-03", "02-04", "02-05", "02-06", "02-07", "02-08", "02-09"]
files_modified:
  - src/routing/bindings.ts -> .js
  - src/routing/resolve-route.ts -> .js
  - src/routing/resolve-route.test.ts -> .test.js
  - src/routing/session-key.ts -> .js
  - src/index.ts -> .js
  - src/entry.ts -> .js
  - src/runtime.ts -> .js
  - src/globals.ts -> .js
  - src/version.ts -> .js
  - vitest.config.js (update include patterns)
  - vitest.unit.config.js (update include patterns)
  - vitest.gateway.config.js (update include patterns)
autonomous: true

must_haves:
  truths:
    - "All routing modules are JavaScript"
    - "Entry points (index, entry, runtime, globals, version) are JavaScript"
    - "Vitest include patterns match both .test.ts and .test.js files"
    - "No .ts files remain in src/infra/, src/utils/, src/shared/, src/config/, src/routing/"
    - "The full foundation test suite passes"
  artifacts:
    - path: "src/index.js"
      provides: "CLI entry point"
    - path: "src/entry.js"
      provides: "Application bootstrap"
    - path: "src/runtime.js"
      provides: "Runtime initialization"
    - path: "src/routing/resolve-route.js"
      provides: "Message routing resolution"
    - path: "vitest.config.js"
      provides: "Updated vitest config with .test.js patterns"
  key_links:
    - from: "src/index.js"
      to: "src/entry.js"
      via: "bootstrap import"
      pattern: "import.*entry"
    - from: "src/entry.js"
      to: "src/runtime.js"
      via: "runtime initialization"
      pattern: "import.*runtime"
    - from: "src/routing/resolve-route.js"
      to: "src/config/"
      via: "config imports for routing rules"
      pattern: "import.*config"
    - from: "vitest.config.js"
      to: "src/**/*.test.js"
      via: "test file glob patterns"
      pattern: "include.*test"
---

<objective>
Convert routing modules, entry points, and update Vitest configuration to complete the foundation layer.

Purpose: This is the final plan of Phase 2. It converts the routing layer (which depends on config), the CLI entry points (which bootstrap the entire application), and updates Vitest to discover both .test.ts and .test.js files. After this plan, all foundation layer directories are fully converted.

Output: ~9 source files converted, 3 vitest configs updated, full phase verification.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation-layer/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert routing modules and entry points</name>
  <files>
    src/routing/bindings.ts -> .js
    src/routing/resolve-route.ts -> .js
    src/routing/resolve-route.test.ts -> .test.js
    src/routing/session-key.ts -> .js
    src/index.ts -> .js
    src/entry.ts -> .js
    src/runtime.ts -> .js
    src/globals.ts -> .js
    src/version.ts -> .js
  </files>
  <action>
    **Part A: Convert routing modules**

    1. Convert the 4 routing files (3 source + 1 test):
       - **resolve-route.ts** (the main routing logic): Add module-level comment explaining how messages are routed from channels to agents based on config bindings.
       - **bindings.ts**: Explain channel-to-agent binding resolution.
       - **session-key.ts**: Explain session key generation for routing context.

    2. Routing imports from src/config/ and src/agents/ -- config will be .js by now (Plans 02-07/08/09 complete), agents remain .ts (converts in Phase 3). Both import paths stay as-is with .js extensions.

    **Part B: Convert entry points**

    3. **src/version.ts** (43 lines): Remove the `declare const __OPENCLAW_VERSION__: string | undefined;` line. This is a TypeScript-only declaration for a build-time constant injected by rolldown. In JavaScript, the variable is replaced at build time. The fallback chain (`typeof __OPENCLAW_VERSION__ === "string"` guard) already handles the dev/test case. Add a JSDoc comment explaining the build-time injection:
       ```javascript
       /**
        * Version resolution.
        *
        * At build time, rolldown replaces __OPENCLAW_VERSION__ with the
        * actual version string via the `define` config option. At dev/test
        * time, the fallback reads version from package.json.
        */
       ```

    4. **src/globals.ts** (52 lines): Imports from `./logging/logger.js` and `./logging.js` -- these remain .ts files (not in Phase 2 scope). The import paths stay as-is. Add module-level comment explaining what global state this module initializes.

    5. **src/runtime.ts** (24 lines): Small runtime initialization module. Add purpose comment.

    6. **src/entry.ts** (162 lines): Application bootstrap that wires together config, routing, gateway. Add module-level comment explaining the bootstrap sequence. This file likely has several `import type` statements for types from various modules -- delete all `import type` lines.

    7. **src/index.ts** (93 lines): CLI entry point. Add module-level comment. Note: this is referenced in rolldown.config.js as the entry point. After renaming to .js, update rolldown.config.js entry point from `src/index.ts` to `src/index.js`. Actually, check first -- rolldown handles .ts files natively, so it may need updating or it may resolve both. To be safe, update the rolldown config entry to `.js` since the file will now actually be `.js`.

    8. Apply standard conversion patterns: strip types, remove `import type`, remove `as` assertions, add JSDoc. Run `eslint --fix`.
  </action>
  <verify>
    - `find src/routing/ -name '*.ts' | wc -l` returns 0
    - `ls src/index.ts src/entry.ts src/runtime.ts src/globals.ts src/version.ts 2>/dev/null` shows none exist
    - `npx vitest run src/routing/resolve-route.test.js --reporter=verbose` passes
    - `npx eslint src/routing/ src/index.js src/entry.js src/runtime.js src/globals.js src/version.js` passes
  </verify>
  <done>9 files converted. Routing modules and entry points are JavaScript. Rolldown entry point updated if needed.</done>
</task>

<task type="auto">
  <name>Task 2: Update Vitest configs and run full foundation verification</name>
  <files>
    vitest.config.js
    vitest.unit.config.js
    vitest.gateway.config.js
  </files>
  <action>
    **Part A: Update Vitest include patterns**

    Read each vitest config file and update the `include` patterns to match BOTH `.test.ts` and `.test.js` files. This is needed because Phase 2 converts foundation tests to .js while later phases' tests remain .ts.

    The pattern update:
    - If include has `'src/**/*.test.ts'`, change to `['src/**/*.test.ts', 'src/**/*.test.js']`
    - Or use brace expansion if vitest supports it: `'src/**/*.test.{ts,js}'`
    - Check what vitest supports -- if brace expansion works, prefer it for conciseness.

    Apply the same pattern to vitest.unit.config.js and vitest.gateway.config.js. Check if vitest.e2e.config.js, vitest.extensions.config.js, and vitest.live.config.js also need updating (they may not reference src/ tests).

    **Part B: Run full foundation verification**

    After updating vitest configs, run the full test suite to verify:
    1. `npx vitest run src/infra/ --reporter=verbose` -- all infra tests pass
    2. `npx vitest run src/config/ --reporter=verbose` -- all config tests pass
    3. `npx vitest run src/utils/ src/shared/ src/routing/ --reporter=verbose` -- all other foundation tests pass
    4. `npx vitest run src/utils.test.js --reporter=verbose` -- root utils test passes

    **Part C: Final .ts file count**

    Run a comprehensive check:
    ```
    echo "Remaining .ts files in foundation directories:"
    find src/types/ src/shared/ src/utils/ src/infra/ src/config/ src/routing/ -name '*.ts' 2>/dev/null | wc -l
    echo "Entry points:"
    ls src/index.ts src/entry.ts src/runtime.ts src/globals.ts src/version.ts src/utils.ts 2>/dev/null | wc -l
    ```
    Both should return 0.

    Also verify `pnpm build` still succeeds (rolldown can bundle from the converted .js entry point).
  </action>
  <verify>
    - `find src/types/ src/shared/ src/utils/ src/infra/ src/config/ src/routing/ -name '*.ts' 2>/dev/null | wc -l` returns 0
    - `ls src/index.ts src/entry.ts src/runtime.ts src/globals.ts src/version.ts src/utils.ts 2>/dev/null` shows none exist
    - `pnpm build` succeeds
    - `npx vitest run src/infra/ src/config/ src/utils/ src/shared/ src/routing/ src/utils.test.js` -- all tests pass
  </verify>
  <done>Vitest configs updated. Full foundation test suite passes. Zero .ts files in foundation directories. Build succeeds.</done>
</task>

</tasks>

<verification>
Phase 2 success criteria (from roadmap):
1. All files in src/infra/, src/utils/, src/shared/, src/types/, src/config/, src/routing/ are JavaScript (.js) with no remaining .ts files
2. Entry points (src/index.js, src/entry.js, src/runtime.js) load and bootstrap the CLI successfully
3. Every converted module has a top-level comment explaining its purpose, and non-obvious functions have JSDoc annotations
4. Security-sensitive code (auth tokens, credential handling, TLS) has explicit comments explaining the security concern
5. Vitest configuration resolves and runs tests against .js source files
</verification>

<success_criteria>
- ZERO .ts files in src/types/, src/shared/, src/utils/, src/infra/, src/config/, src/routing/
- ZERO .ts entry point files (index, entry, runtime, globals, version, utils)
- `pnpm build` succeeds
- All foundation tests pass with updated vitest config
- Vitest discovers both .test.ts (unconverted) and .test.js (converted) files
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation-layer/02-10-SUMMARY.md`
</output>
