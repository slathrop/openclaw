---
phase: 02-foundation-layer
plan: 06
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/infra/net/ (all .ts files -> .js)
  - src/infra/outbound/ (all .ts files -> .js)
  - src/infra/tls/ (all .ts files -> .js)
autonomous: true

must_haves:
  truths:
    - "All files in src/infra/net/ are JavaScript with SSRF security comments"
    - "All files in src/infra/outbound/ are JavaScript with security comments on URL validation"
    - "All files in src/infra/tls/ are JavaScript with security comments on certificate handling"
    - "All tests pass for converted modules"
  artifacts:
    - path: "src/infra/net/ssrf.js"
      provides: "SSRF protection and IP validation"
      contains: "SECURITY:"
    - path: "src/infra/net/ssrf.pinning.js"
      provides: "DNS pinning for SSRF prevention"
      contains: "SECURITY:"
    - path: "src/infra/outbound/fetch-guard.js"
      provides: "Guarded fetch with SSRF protection"
      contains: "SECURITY:"
    - path: "src/infra/tls/fingerprint.js"
      provides: "TLS certificate fingerprinting"
      contains: "SECURITY:"
  key_links:
    - from: "src/infra/outbound/fetch-guard.js"
      to: "src/infra/net/ssrf.js"
      via: "SSRF validation before fetch"
      pattern: "import.*ssrf"
---

<objective>
Convert the src/infra/net/, src/infra/outbound/, and src/infra/tls/ subdirectories to JavaScript.

Purpose: These subdirectories contain security-critical networking code -- SSRF protection, outbound request guards, and TLS certificate handling. They are the most security-sensitive modules in the foundation layer and require thorough QUAL-05 security annotations.

Output: ~38 files converted from .ts to .js with comprehensive security comments, JSDoc annotations, and module-level comments.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-foundation-layer/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert src/infra/net/ and src/infra/tls/</name>
  <files>
    src/infra/net/ (2 source + 1 test = 3 files)
    src/infra/tls/ (2 source + 1 test = 3 files)
  </files>
  <action>
    First, list all .ts files in these directories:
    ```
    find src/infra/net/ src/infra/tls/ -name '*.ts' | sort
    ```

    Convert each file from TypeScript to JavaScript:

    1. **src/infra/net/ -- SSRF Protection:**
       This directory implements Server-Side Request Forgery prevention. These are among the most security-critical modules in the codebase.

       **SECURITY comments (QUAL-05) -- ESSENTIAL for this directory:**
       - Explain what SSRF is and why this protection exists
       - Document the IP validation logic (private ranges, loopback, link-local)
       - Document DNS pinning to prevent TOCTOU attacks (hostname resolves to public IP during check, private IP during connection)
       - Note that ALL user-controlled outbound URLs must go through this module
       - Reference the research example in 02-RESEARCH.md "Security-Sensitive Conversion Example (SSRF)"

       Add comprehensive module-level comments explaining the threat model.

    2. **src/infra/tls/ -- Certificate Handling:**
       **SECURITY comments (QUAL-05):**
       - Explain TLS certificate fingerprinting purpose
       - Note any certificate pinning or validation logic
       - Document any security implications of fingerprint comparison

    3. Apply standard conversion: strip types, remove `import type`, convert `export type` to `@typedef`, remove `as` assertions. Run `eslint --fix`.
  </action>
  <verify>
    - `find src/infra/net/ src/infra/tls/ -name '*.ts' | wc -l` returns 0
    - `npx vitest run src/infra/net/ src/infra/tls/ --reporter=verbose` passes
    - `npx eslint src/infra/net/ src/infra/tls/` passes
    - `grep -l 'SECURITY:' src/infra/net/*.js src/infra/tls/*.js` shows all source files have security comments
  </verify>
  <done>6 files converted. SSRF and TLS modules have comprehensive SECURITY comments. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Convert src/infra/outbound/</name>
  <files>
    src/infra/outbound/ (19 source + 12 tests = 31 files)
  </files>
  <action>
    First, list all .ts files in this directory:
    ```
    find src/infra/outbound/ -name '*.ts' | sort
    ```

    Convert each file from TypeScript to JavaScript. The outbound directory handles all outbound HTTP requests with security guards.

    1. **Module-level comments (QUAL-04):** Add purpose comments to every file explaining what type of outbound request it handles.

    2. **Security comments (QUAL-05) -- CRITICAL for this directory:**
       - **fetch-guard**: Explain that this wraps Node's fetch to enforce SSRF protection. Document the guard chain (URL validation -> DNS pinning -> fetch -> response validation).
       - **URL validation modules**: Explain what URL patterns are allowed/blocked and why.
       - **Any auth header handling**: Note that outbound requests may include API keys or bearer tokens. Explain how credentials are attached and what prevents them from leaking to wrong hosts.
       - **Redirect following**: If any module handles redirects, explain the security implications (open redirect, credential forwarding to different hosts).

    3. Apply standard conversion patterns: strip types, remove `import type`, convert `export type` to `@typedef`, remove `as` assertions.

    4. Add `@param`/`@returns` JSDoc on non-obvious functions, especially those dealing with URL parsing, header construction, or response validation.

    5. Run `eslint --fix` on each converted file.

    Note: outbound/ has 19 source files and 12 test files totaling ~6,754 lines. Process systematically -- convert source files first, then their tests. The source files likely import from `../net/ssrf.js` (converted in Task 1 of this plan).
  </action>
  <verify>
    - `find src/infra/outbound/ -name '*.ts' | wc -l` returns 0
    - `npx vitest run src/infra/outbound/ --reporter=verbose` passes
    - `npx eslint src/infra/outbound/` passes
    - `grep -l 'SECURITY:' src/infra/outbound/*.js | wc -l` shows multiple files have security comments
  </verify>
  <done>31 files in src/infra/outbound/ converted. Security-critical fetch guard and URL validation have SECURITY comments. Tests pass.</done>
</task>

</tasks>

<verification>
1. `find src/infra/net/ src/infra/outbound/ src/infra/tls/ -name '*.ts' | wc -l` returns 0
2. All converted files have module-level purpose comments
3. SSRF, fetch-guard, and TLS modules have SECURITY: comments
4. All test files pass
5. ESLint passes on all converted files
</verification>

<success_criteria>
- ~38 files converted from .ts to .js across net/, outbound/, and tls/
- Zero .ts files remain in these directories
- All security-critical modules have explicit SECURITY: comments explaining the security concern
- All tests pass
- ESLint reports no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation-layer/02-06-SUMMARY.md`
</output>
