---
phase: 07-security-initial-hardening
plan: 06
type: execute
wave: 2
depends_on: []
files_modified:
  - src/auto-reply/thinking.js
  - src/discord/allow-list.js
  - src/cron/schedule.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "xhigh thinking level gracefully downgrades when unsupported"
    - "Discord owner hint is restored from allowlists"
    - "Unused cron import is removed"
  artifacts:
    - path: "src/auto-reply/thinking.js"
      provides: "Graceful xhigh downgrade"
      contains: "xhigh|downgrade"
    - path: "src/discord/allow-list.js"
      provides: "Owner hint restoration"
  key_links:
    - from: "src/auto-reply/thinking.js"
      to: "model thinking level"
      via: "level normalization"
      pattern: "xhigh.*high|downgrade"
---

<objective>
Port thinking level downgrade, Discord owner hint, and cron cleanup

Purpose: Improve thinking level handling, fix Discord UI hint, and clean up imports
Output: Three commits matching upstream (SYNC-015, SYNC-016, SYNC-017)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-security-initial-hardening/07-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run tests: `pnpm test`
5. Run lint: `pnpm check`
6. Commit with matching message: `scripts/committer "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-015 - Gracefully downgrade xhigh thinking level</name>
  <files>src/auto-reply/thinking.js</files>
  <action>
Port commit 852466645 (fix: gracefully downgrade xhigh thinking level #9363)

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show 852466645 --stat
   git show 852466645
   ```

2. Understand the change:
   - Some models don't support "xhigh" thinking level
   - The fix adds graceful downgrade to "high" when xhigh is unsupported
   - This prevents errors when using xhigh with incompatible models

3. Apply the equivalent JavaScript changes:
   - Find the thinking level normalization/handling in thinking.js
   - Add logic: if level is "xhigh" and model doesn't support it, use "high"
   - May involve checking model capabilities or just always downgrading

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "fix: gracefully downgrade xhigh thinking level (#9363)" src/auto-reply/thinking.js
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 852466645 ported as SYNC-015, xhigh gracefully downgrades to high when needed</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-016 - Restore Discord owner hint from allowlists</name>
  <files>src/discord/allow-list.js or src/discord/**/*.js</files>
  <action>
Port commit d84eb4646 (fix: restore discord owner hint from allowlists)

1. Read the upstream diff:
   ```bash
   git show d84eb4646 --stat
   git show d84eb4646
   ```

2. Understand the change:
   - Discord UI shows an "owner hint" indicating who the bot owner is
   - This hint was broken/missing and needs to be restored from allowlist data
   - The fix extracts owner info from the allowlist configuration

3. Locate the relevant files:
   - Check Discord module: `ls src/discord/`
   - Look for allow-list.js or owner-related code

4. Apply the equivalent JavaScript changes:
   - Restore the owner hint extraction from allowlist
   - Ensure the hint displays correctly in Discord responses

5. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

6. Commit with matching message:
   ```bash
   scripts/committer "fix: restore discord owner hint from allowlists" <affected files>
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit d84eb4646 ported as SYNC-016, Discord owner hint restored</done>
</task>

<task type="auto">
  <name>Task 3: SYNC-017 - Remove unused cron import</name>
  <files>src/cron/schedule.js or related cron files</files>
  <action>
Port commit 3b40227bc (fix: remove unused cron import)

1. Read the upstream diff:
   ```bash
   git show 3b40227bc --stat
   git show 3b40227bc
   ```

2. Understand the change:
   - A simple cleanup: remove an unused import statement from cron module
   - This is a code hygiene fix

3. Apply the equivalent JavaScript changes:
   - Find the unused import in the cron module
   - Remove it

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "fix: remove unused cron import" <affected file>
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 3b40227bc ported as SYNC-017, unused cron import removed</done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm test` passes
3. `pnpm check` passes
4. Commits match upstream messages:
   - fix: gracefully downgrade xhigh thinking level (#9363)
   - fix: restore discord owner hint from allowlists
   - fix: remove unused cron import
</verification>

<success_criteria>
- 3 commits created matching SYNC-015, SYNC-016, SYNC-017
- Full test suite passes after each commit
- xhigh thinking level gracefully downgrades
- Discord owner hint displays correctly
- Cron module has clean imports
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-initial-hardening/07-06-SUMMARY.md`
</output>
