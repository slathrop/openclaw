---
phase: 07-security-initial-hardening
plan: 07
type: execute
wave: 2
depends_on: []
files_modified:
  - src/cli/browser-cli-extension.js
  - src/cli/browser-cli-extension.test.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Bundled chrome extension path resolves correctly in dev and dist modes"
    - "Extension install tests use unique temp directories"
    - "Extension path resolver satisfies lint rules"
  artifacts:
    - path: "src/cli/browser-cli-extension.js"
      provides: "Correct bundled extension path resolution"
      contains: "bundledExtensionRootDir|extension.*path"
    - path: "src/cli/browser-cli-extension.test.js"
      provides: "Unique temp dir for tests"
  key_links:
    - from: "src/cli/browser-cli-extension.js"
      to: "extension installation"
      via: "path resolution"
      pattern: "hasManifest|resolve"
---

<objective>
Port CLI bundled chrome extension path resolution fixes (4 related commits)

Purpose: Fix extension installation path resolution for bundled extensions in various environments
Output: Four commits matching upstream (SYNC-018, SYNC-019, SYNC-020, SYNC-021)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-security-initial-hardening/07-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run tests: `pnpm test`
5. Run lint: `pnpm check`
6. Commit with matching message: `scripts/committer "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-018 - Resolve bundled chrome extension path</name>
  <files>src/cli/browser-cli-extension.js</files>
  <action>
Port commit 0621d0e9e (fix(cli): resolve bundled chrome extension path)

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show 0621d0e9e --stat
   git show 0621d0e9e
   ```

2. Understand the change:
   - The bundledExtensionRootDir() function needs to find the chrome extension assets
   - In dev mode vs bundled mode, the paths are different
   - The fix adds path resolution logic to find the correct directory

3. Apply the equivalent JavaScript changes:
   - Update bundledExtensionRootDir() in browser-cli-extension.js
   - Add logic to try multiple candidate paths
   - Check for manifest.json existence to validate path

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "fix(cli): resolve bundled chrome extension path" src/cli/browser-cli-extension.js
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 0621d0e9e ported as SYNC-018, bundled extension path resolves correctly</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-019 - Use unique temp dir for extension install test</name>
  <files>src/cli/browser-cli-extension.test.js</files>
  <action>
Port commit 1008c28f5 (test(cli): use unique temp dir for extension install)

1. Read the upstream diff:
   ```bash
   git show 1008c28f5 --stat
   git show 1008c28f5
   ```

2. Understand the change:
   - Extension install tests were sharing a temp directory, causing flakiness
   - The fix uses unique temp directories per test to avoid conflicts

3. Apply the equivalent JavaScript changes:
   - Update the test to create unique temp directories
   - Use os.tmpdir() + unique suffix pattern
   - Clean up temp dirs after tests

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "test(cli): use unique temp dir for extension install" src/cli/browser-cli-extension.test.js
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 1008c28f5 ported as SYNC-019, extension tests use unique temp dirs</done>
</task>

<task type="auto">
  <name>Task 3: SYNC-020 - Support bundled extension path in dist root</name>
  <files>src/cli/browser-cli-extension.js</files>
  <action>
Port commit 44bbe09be (fix(cli): support bundled extension path in dist root)

1. Read the upstream diff:
   ```bash
   git show 44bbe09be --stat
   git show 44bbe09be
   ```

2. Understand the change:
   - This adds another candidate path for bundled extensions
   - When running from dist root, the path structure is different
   - The fix adds this as a fallback path to try

3. Apply the equivalent JavaScript changes:
   - Add another candidate path to bundledExtensionRootDir()
   - Try ../assets/chrome-extension (dist root) in addition to existing paths
   - Maintain the hasManifest() check pattern

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "fix(cli): support bundled extension path in dist root" src/cli/browser-cli-extension.js
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 44bbe09be ported as SYNC-020, dist root path supported</done>
</task>

<task type="auto">
  <name>Task 4: SYNC-021 - Satisfy lint rules in extension path resolver</name>
  <files>src/cli/browser-cli-extension.js</files>
  <action>
Port commit 34e78a705 (style(cli): satisfy lint rules in extension path resolver)

1. Read the upstream diff:
   ```bash
   git show 34e78a705 --stat
   git show 34e78a705
   ```

2. Understand the change:
   - This is a style cleanup to satisfy linting rules
   - Likely formatting, variable naming, or code structure changes
   - No functional changes, just style compliance

3. Apply the equivalent JavaScript changes:
   - Apply any style fixes shown in the diff
   - This may already be compliant in our codebase due to different lint rules

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "style(cli): satisfy lint rules in extension path resolver" src/cli/browser-cli-extension.js
   ```

Note: If our lint rules differ and no changes are needed, create an empty commit or
document that this commit is a no-op due to different lint configuration.
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 34e78a705 ported as SYNC-021, lint rules satisfied</done>
</task>

</tasks>

<verification>
After all 4 tasks complete:
1. `git log -4 --oneline` shows four commits in correct order
2. `pnpm test` passes
3. `pnpm check` passes
4. Commits match upstream messages:
   - fix(cli): resolve bundled chrome extension path
   - test(cli): use unique temp dir for extension install
   - fix(cli): support bundled extension path in dist root
   - style(cli): satisfy lint rules in extension path resolver
5. `openclaw browser extension install` works correctly in dev and dist modes
</verification>

<success_criteria>
- 4 commits created matching SYNC-018, SYNC-019, SYNC-020, SYNC-021
- Full test suite passes after each commit
- Bundled extension path resolves in dev, dist, and dist root modes
- Extension install tests are isolated and reliable
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-initial-hardening/07-07-SUMMARY.md`
</output>
