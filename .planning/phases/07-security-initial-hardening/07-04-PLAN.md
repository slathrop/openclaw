---
phase: 07-security-initial-hardening
plan: 04
type: execute
wave: 2
depends_on: ["07-03"]
files_modified:
  - src/message/**/*.js
  - src/auto-reply/command-auth.js
  - src/cli/auth-choice-options.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Media schema is clarified with correct MEDIA newline handling"
    - "Owner allowlist is enforced for commands"
    - "Auth choice is inferred from API key flags"
  artifacts:
    - path: "src/message/**/*.js"
      provides: "Clarified media schema"
    - path: "src/auto-reply/command-auth.js"
      provides: "Owner allowlist enforcement"
    - path: "src/cli/auth-choice-options.js"
      provides: "API key flag inference"
  key_links:
    - from: "src/cli/auth-choice-options.js"
      to: "authentication flow"
      via: "flag inference"
      pattern: "auth.*choice|infer"
---

<objective>
Port message schema clarification, owner allowlist enforcement, and auth flag inference

Purpose: Improve message handling clarity, security, and CLI usability
Output: Three commits matching upstream (SYNC-008, SYNC-009, SYNC-010)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-security-initial-hardening/07-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run tests: `pnpm test`
5. Run lint: `pnpm check`
6. Commit with matching message: `scripts/committer "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-008 - Clarify media schema + fix MEDIA newline</name>
  <files>src/message/**/*.js or related schema files</files>
  <action>
Port commit a6fd76efe (Message: clarify media schema + fix MEDIA newline)

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show a6fd76efe --stat
   git show a6fd76efe
   ```

2. Understand the change:
   - Media schema documentation/comments are clarified
   - MEDIA newline handling is fixed (likely trailing newline issue)
   - This is a docs/schema change with a small bug fix

3. Locate the relevant files:
   - Check message module: `ls src/message/`
   - Look for media-related schema or type definitions
   - The MEDIA newline fix is likely in message parsing/formatting

4. Apply the equivalent JavaScript changes:
   - Update schema documentation/comments
   - Fix MEDIA newline handling

5. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

6. Commit with matching message:
   ```bash
   scripts/committer "Message: clarify media schema + fix MEDIA newline" <affected files>
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit a6fd76efe ported as SYNC-008, media schema clarified and MEDIA newline fixed</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-009 - Enforce owner allowlist for commands</name>
  <files>src/auto-reply/command-auth.js</files>
  <action>
Port commit 385a7eba3 (fix: enforce owner allowlist for commands)

1. Read the upstream diff:
   ```bash
   git show 385a7eba3 --stat
   git show 385a7eba3
   ```

2. Understand the change:
   - This builds on SYNC-006's owner-only feature
   - Adds stricter enforcement of owner allowlist for commands
   - Likely fixes edge cases where owner check was bypassed

3. Apply the equivalent JavaScript changes:
   - Enhance command-auth.js owner allowlist enforcement
   - Ensure all code paths check owner allowlist correctly

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "fix: enforce owner allowlist for commands" src/auto-reply/command-auth.js
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 385a7eba3 ported as SYNC-009, owner allowlist enforcement is complete</done>
</task>

<task type="auto">
  <name>Task 3: SYNC-010 - Infer --auth-choice from API key flags</name>
  <files>src/cli/auth-choice-options.js or related CLI files</files>
  <action>
Port commit 22927b083 (fix: infer --auth-choice from API key flags #9241)

1. Read the upstream diff:
   ```bash
   git show 22927b083 --stat
   git show 22927b083
   ```

2. Understand the change:
   - When user provides API key flags (like --openai-key), the auth choice should
     be inferred rather than requiring explicit --auth-choice flag
   - This is a CLI UX improvement

3. Locate the relevant files:
   - Check CLI module: `ls src/cli/`
   - Look for auth-choice-options.js or similar
   - The fix adds inference logic for API key flags

4. Apply the equivalent JavaScript changes:
   - Add logic to infer auth choice from presence of API key flags
   - Update option parsing to detect API key flags and set auth choice accordingly

5. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

6. Commit with matching message:
   ```bash
   scripts/committer "fix: infer --auth-choice from API key flags (#9241)" <affected files>
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 22927b083 ported as SYNC-010, auth choice is inferred from API key flags</done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm test` passes
3. `pnpm check` passes
4. Commits match upstream messages:
   - Message: clarify media schema + fix MEDIA newline
   - fix: enforce owner allowlist for commands
   - fix: infer --auth-choice from API key flags (#9241)
</verification>

<success_criteria>
- 3 commits created matching SYNC-008, SYNC-009, SYNC-010
- Full test suite passes after each commit
- Media schema clarified
- Owner allowlist fully enforced
- CLI auth choice inferred from API key flags
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-initial-hardening/07-04-SUMMARY.md`
</output>
