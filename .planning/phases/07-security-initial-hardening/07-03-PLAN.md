---
phase: 07-security-initial-hardening
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/auto-reply/command-auth.js
  - src/auto-reply/commands-registry.js
  - src/telegram/bot-handlers.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Owner-only tools require owner authorization"
    - "Command authorization checks are hardened"
    - "Telegram bot-handlers.js handles types correctly"
  artifacts:
    - path: "src/auto-reply/command-auth.js"
      provides: "Owner-only command authorization"
      contains: "ownerOnly|owner.*only"
    - path: "src/telegram/bot-handlers.js"
      provides: "Type-safe handler registration"
  key_links:
    - from: "src/auto-reply/command-auth.js"
      to: "command execution"
      via: "authorization check"
      pattern: "resolveCommandAuthorization"
---

<objective>
Port security owner-only tools and Telegram bot-handlers cleanup

Purpose: Harden command authorization with owner-only checks and improve bot-handlers code quality
Output: Two commits matching upstream (SYNC-006, SYNC-007)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-security-initial-hardening/07-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run tests: `pnpm test`
5. Run lint: `pnpm check`
6. Commit with matching message: `scripts/committer "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-006 - Owner-only tools + command auth hardening</name>
  <files>src/auto-reply/command-auth.js, src/auto-reply/commands-registry.js, src/auto-reply/commands-registry.data.js</files>
  <action>
Port commit 392bbddf2 (Security: owner-only tools + command auth hardening #9202)

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show 392bbddf2 --stat
   git show 392bbddf2
   ```

2. Review the PR for context:
   ```bash
   gh pr view 9202 --repo openclaw/openclaw
   ```

3. Understand the security fix:
   - Some tools/commands should only be available to owners
   - Command authorization needs additional checks for owner-only commands
   - Look for: `ownerOnly` flag on commands, owner check in authorization

4. Apply the equivalent JavaScript changes:
   - Add ownerOnly property to sensitive commands in registry
   - Enhance resolveCommandAuthorization() to check ownerOnly flag
   - Verify sender is in owner allowlist before allowing owner-only commands

5. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

6. Commit with matching message:
   ```bash
   scripts/committer "Security: owner-only tools + command auth hardening (#9202)" src/auto-reply/command-auth.js src/auto-reply/commands-registry.js src/auto-reply/commands-registry.data.js
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 392bbddf2 ported as SYNC-006, owner-only commands are protected</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-007 - Remove last @ts-nocheck from bot-handlers.ts</name>
  <files>src/telegram/bot-handlers.js</files>
  <action>
Port commit 21f8c3db1 (Telegram: remove last @ts-nocheck from bot-handlers.ts #9206)

1. Read the upstream diff:
   ```bash
   git show 21f8c3db1 --stat
   git show 21f8c3db1
   ```

2. Understand the change: Similar to SYNC-004, the @ts-nocheck directive was removed
   by fixing type issues. In JavaScript, apply the underlying code fixes.
   Look for:
   - Type narrowing or null checks added
   - Property access guards
   - Handler registration type fixes

3. Apply the equivalent JavaScript changes:
   - Apply code fixes that enabled TypeScript to type-check
   - These are typically null checks, type guards, or property access fixes

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "Telegram: remove last @ts-nocheck from bot-handlers.ts (#9206)" src/telegram/bot-handlers.js
   ```

Note: If the upstream diff shows no substantive code changes (only @ts-nocheck removal),
this commit may be a no-op in JavaScript. In that case, create an empty commit or skip
and document why.
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 21f8c3db1 ported as SYNC-007, bot-handlers.js has any necessary type-related fixes</done>
</task>

</tasks>

<verification>
After all 2 tasks complete:
1. `git log -2 --oneline` shows two commits in correct order
2. `pnpm test` passes
3. `pnpm check` passes
4. Commits match upstream messages:
   - Security: owner-only tools + command auth hardening (#9202)
   - Telegram: remove last @ts-nocheck from bot-handlers.ts (#9206)
</verification>

<success_criteria>
- 2 commits created matching SYNC-006, SYNC-007
- Full test suite passes after each commit
- Owner-only commands require owner authorization
- Telegram bot-handlers.js code quality improved
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-initial-hardening/07-03-SUMMARY.md`
</output>
