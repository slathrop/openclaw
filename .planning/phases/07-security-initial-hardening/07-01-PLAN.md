---
phase: 07-security-initial-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/gateway/auth.js
  - src/gateway/net.js
  - src/tui/**/*.js
  - src/auto-reply/reply/stage-sandbox-media.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Gateway rejects URLs containing embedded credentials"
    - "TUI tests run with correct gateway environment"
    - "Sandboxed media handling validates paths before file operations"
  artifacts:
    - path: "src/gateway/auth.js"
      provides: "URL credential validation"
      contains: "credential.*exfiltration|username.*password"
    - path: "src/auto-reply/reply/stage-sandbox-media.js"
      provides: "Path validation before media copy"
      contains: "assertSandboxPath"
  key_links:
    - from: "src/gateway/auth.js"
      to: "URL parsing"
      via: "validation before use"
      pattern: "new URL"
---

<objective>
Port security foundation commits: credential exfiltration prevention, TUI test env, and sandboxed media hardening

Purpose: Establish security baseline by porting critical security fixes first
Output: Three commits matching upstream (SYNC-001, SYNC-002, SYNC-003)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-security-initial-hardening/07-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run tests: `pnpm test`
5. Run lint: `pnpm check`
6. Commit with matching message: `scripts/committer "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-001 - Prevent gateway credential exfiltration via URL override</name>
  <files>src/gateway/auth.js, src/gateway/net.js</files>
  <action>
Port commit a13ff55bd (Security: Prevent gateway credential exfiltration via URL override #9179)

1. Fetch upstream and read the diff:
   ```bash
   git fetch upstream
   git show a13ff55bd --stat
   git show a13ff55bd
   ```

2. Understand the security fix: URLs with embedded credentials (user:pass@host) can be used
   to exfiltrate gateway credentials. The fix adds validation to reject such URLs.

3. Apply the equivalent JavaScript changes:
   - Look for URL handling in gateway auth/net modules
   - Add validation that rejects URLs with username or password components
   - Pattern: `new URL(url)` then check `parsed.username || parsed.password`

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "Security: Prevent gateway credential exfiltration via URL override (#9179)" src/gateway/auth.js src/gateway/net.js
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit a13ff55bd ported as SYNC-001, gateway rejects URLs with embedded credentials</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-002 - Restore TUI gateway env</name>
  <files>src/tui/**/*.js or test files</files>
  <action>
Port commit 5e025c4ba (Tests: restore TUI gateway env)

1. Read the upstream diff:
   ```bash
   git show 5e025c4ba --stat
   git show 5e025c4ba
   ```

2. Understand the change: This restores test environment configuration for TUI tests.
   Likely touches test setup files or environment handling.

3. Apply the equivalent JavaScript changes:
   - Find the corresponding test files in src/tui/ or test directories
   - Apply the environment restoration changes

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "Tests: restore TUI gateway env" <affected files>
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 5e025c4ba ported as SYNC-002, TUI tests have correct gateway environment</done>
</task>

<task type="auto">
  <name>Task 3: SYNC-003 - Harden sandboxed media handling</name>
  <files>src/auto-reply/reply/stage-sandbox-media.js</files>
  <action>
Port commit 4434cae56 (Security: harden sandboxed media handling #9182)

1. Read the upstream diff:
   ```bash
   git show 4434cae56 --stat
   git show 4434cae56
   ```

2. Understand the security fix: Media staging needs path validation to prevent
   directory traversal attacks. Uses assertSandboxPath() before file operations.

3. Apply the equivalent JavaScript changes:
   - Find stage-sandbox-media.js (already exists in codebase)
   - Add assertSandboxPath() calls before copying files into sandbox
   - Import from '../../agents/sandbox-paths.js' if needed

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "Security: harden sandboxed media handling (#9182)" src/auto-reply/reply/stage-sandbox-media.js
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 4434cae56 ported as SYNC-003, sandboxed media validates paths before operations</done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm test` passes with all security tests
3. `pnpm check` passes
4. Commits match upstream messages:
   - Security: Prevent gateway credential exfiltration via URL override (#9179)
   - Tests: restore TUI gateway env
   - Security: harden sandboxed media handling (#9182)
</verification>

<success_criteria>
- 3 commits created matching SYNC-001, SYNC-002, SYNC-003
- Full test suite passes after each commit
- Security validation present in gateway auth and media staging
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-initial-hardening/07-01-SUMMARY.md`
</output>
