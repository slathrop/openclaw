---
phase: 07-security-initial-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/telegram/bot-message.js
  - src/voice/**/*.js
  - src/routing/allow-list.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Telegram bot-message.js handles types correctly (no @ts-nocheck equivalent issues)"
    - "Anonymous voice callers can be allowlisted"
  artifacts:
    - path: "src/telegram/bot-message.js"
      provides: "Type-safe message handling"
    - path: "src/voice/**/*.js or src/routing/allow-list.js"
      provides: "Anonymous caller allowlist support"
  key_links:
    - from: "voice allowlist"
      to: "allowlist matching"
      via: "anonymous caller support"
      pattern: "anonymous|anon"
---

<objective>
Port Telegram bot-message cleanup and voice allowlist fix

Purpose: Improve code quality in Telegram module and enable voice allowlist for anonymous callers
Output: Two commits matching upstream (SYNC-004, SYNC-005)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-security-initial-hardening/07-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run tests: `pnpm test`
5. Run lint: `pnpm check`
6. Commit with matching message: `scripts/committer "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-004 - Remove @ts-nocheck from bot-message.ts</name>
  <files>src/telegram/bot-message.js</files>
  <action>
Port commit 90b4e5435 (Telegram: remove @ts-nocheck from bot-message.ts #9180)

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show 90b4e5435 --stat
   git show 90b4e5435
   ```

2. Understand the change: The @ts-nocheck directive was removed by fixing type issues.
   In JavaScript, there's no @ts-nocheck, but the underlying code fixes still apply.
   Look for:
   - Type narrowing or null checks added
   - Property access guards
   - Logic changes that fixed type errors

3. Apply the equivalent JavaScript changes:
   - The code fixes that enabled TypeScript to type-check should be applied
   - These are typically null checks, type guards, or property access fixes

4. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

5. Commit with matching message:
   ```bash
   scripts/committer "Telegram: remove @ts-nocheck from bot-message.ts (#9180)" src/telegram/bot-message.js
   ```

Note: If the upstream diff shows no substantive code changes (only @ts-nocheck removal),
this commit may be a no-op in JavaScript. In that case, create an empty commit or skip
and document why.
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 90b4e5435 ported as SYNC-004, bot-message.js has any necessary type-related fixes</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-005 - Cover anonymous voice allowlist callers</name>
  <files>src/voice/**/*.js, src/routing/allow-list.js</files>
  <action>
Port commit 0cd47d830 (fix: cover anonymous voice allowlist callers #8104)

1. Read the upstream diff:
   ```bash
   git show 0cd47d830 --stat
   git show 0cd47d830
   ```

2. Understand the change: Voice callers without caller ID (anonymous) need to be
   matchable against allowlists. The fix adds handling for anonymous/withheld caller IDs.

3. Locate the relevant files:
   - Check for voice module: `ls src/voice/` or similar
   - Check routing/allowlist: `src/routing/allow-list.js`
   - The fix likely adds special handling for anonymous caller patterns

4. Apply the equivalent JavaScript changes:
   - Add anonymous caller matching in allowlist logic
   - Handle cases where callerId is undefined, "anonymous", or similar

5. Run tests and lint:
   ```bash
   pnpm test
   pnpm check
   ```

6. Commit with matching message:
   ```bash
   scripts/committer "fix: cover anonymous voice allowlist callers (#8104)" <affected files>
   ```
  </action>
  <verify>`pnpm test` passes, `pnpm check` passes, `git log -1` shows correct message</verify>
  <done>Commit 0cd47d830 ported as SYNC-005, anonymous voice callers can be allowlisted</done>
</task>

</tasks>

<verification>
After all 2 tasks complete:
1. `git log -2 --oneline` shows two commits in correct order
2. `pnpm test` passes
3. `pnpm check` passes
4. Commits match upstream messages:
   - Telegram: remove @ts-nocheck from bot-message.ts (#9180)
   - fix: cover anonymous voice allowlist callers (#8104)
</verification>

<success_criteria>
- 2 commits created matching SYNC-004, SYNC-005
- Full test suite passes after each commit
- Telegram bot-message.js code quality improved
- Voice anonymous callers can be allowlisted
</success_criteria>

<output>
After completion, create `.planning/phases/07-security-initial-hardening/07-02-SUMMARY.md`
</output>
