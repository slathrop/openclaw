---
phase: 04-cli-and-channels
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/signal/**/*.ts
  - src/imessage/**/*.ts
  - src/feishu/**/*.ts
  - src/line/**/*.ts
  - src/web/**/*.ts
  - src/channels/**/*.ts
  - src/test-utils/**/*.ts
autonomous: true

must_haves:
  truths:
    - "All files in src/signal/, src/imessage/, src/feishu/, src/line/, src/web/, src/channels/, src/test-utils/ are .js with no remaining .ts files"
    - "LINE's 29 interface declarations are converted to JSDoc @typedef"
    - "iMessage's 15 private keyword usages are expanded to underscore-prefixed fields"
    - "Feishu's 5 private keyword usages and 1 class are properly handled"
    - "src/channels/plugins/types.*.ts files (4 files, ~790 lines) are JSDoc @typedef modules with runtime re-export preserved"
    - "SECURITY annotations on web auth-store, channels pairing, command-gating, allowlist-match, mention-gating"
    - "All remaining channel tests pass after conversion"
  artifacts:
    - path: "src/signal/**/*.js"
      provides: "Signal channel implementation converted to JavaScript"
    - path: "src/imessage/**/*.js"
      provides: "iMessage channel implementation converted to JavaScript"
    - path: "src/feishu/**/*.js"
      provides: "Feishu channel implementation converted to JavaScript"
    - path: "src/line/**/*.js"
      provides: "LINE channel implementation converted to JavaScript"
    - path: "src/web/**/*.js"
      provides: "Web (WhatsApp Web) channel implementation converted to JavaScript"
    - path: "src/channels/**/*.js"
      provides: "Shared channel modules and plugin system converted to JavaScript"
    - path: "src/channels/plugins/types.core.js"
      provides: "Core channel plugin type definitions as JSDoc @typedef module"
    - path: "src/channels/plugins/types.adapters.js"
      provides: "Channel adapter type definitions as JSDoc @typedef module"
    - path: "src/channels/plugins/types.plugin.js"
      provides: "Plugin type definitions as JSDoc @typedef module"
    - path: "src/channels/plugins/types.js"
      provides: "Type barrel with runtime re-export of CHANNEL_MESSAGE_ACTION_NAMES"
    - path: "src/test-utils/**/*.js"
      provides: "Shared test utilities converted to JavaScript"
  key_links:
    - from: "src/channels/plugins/types.js"
      to: "src/channels/plugins/types.core.js"
      via: "barrel re-export of runtime values + JSDoc type references"
      pattern: "export.*from.*types\\.core"
    - from: "src/channels/dock.js"
      to: "src/telegram/, src/discord/, src/slack/, etc."
      via: "channel registration and dispatch"
      pattern: "import.*from.*(telegram|discord|slack|signal|imessage|feishu|line|web)"
    - from: "src/web/auth-store.js"
      to: "credential storage"
      via: "WhatsApp Web auth persistence"
      pattern: "SECURITY:"
    - from: "src/channels/allowlist-match.js"
      to: "access control"
      via: "allowlist enforcement for channel messages"
      pattern: "SECURITY:"
---

<objective>
Convert all files in src/signal/ (24 files), src/imessage/ (17 files), src/feishu/ (17 files), src/line/ (34 files), src/web/ (78 files), src/channels/ (103 files), and src/test-utils/ (2 files) from TypeScript to JavaScript.

Purpose: This plan completes the channel layer conversion. The shared src/channels/ directory imports from individual channel directories (converted in 04-02), which is why this plan depends on 04-02. The src/channels/plugins/ subdirectory has 4 type-heavy files (~790 lines) requiring manual JSDoc @typedef conversion. LINE has 29 interface declarations (highest concentration in Phase 4). iMessage and Feishu have classes with private fields.
Output: All 275 files converted to .js. All nine channel directories plus shared modules fully converted. All channel tests passing.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cli-and-channels/04-RESEARCH.md
@.planning/phases/04-cli-and-channels/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert src/signal/, src/imessage/, src/feishu/, src/line/, and src/test-utils/</name>
  <files>
    src/signal/**/*.ts (14 source + 10 test = 24 files, ~4K lines)
    src/imessage/**/*.ts (12 source + 5 test = 17 files, ~3K lines)
    src/feishu/**/*.ts (16 source + 1 test = 17 files, ~3K lines)
    src/line/**/*.ts (21 source + 13 test = 34 files, ~9K lines)
    src/test-utils/**/*.ts (2 files, ~100 lines)
    Total: 94 files, ~19K lines
  </files>
  <action>
1. Write a conversion script (convert-channels-batch2.mjs) in the project root and run it:
   - Walk src/signal/, src/imessage/, src/feishu/, src/line/ recursively
   - Convert all .ts files with esbuild transformSync
   - Write .js output, delete .ts originals

2. Convert src/test-utils/ manually (2 files -- too small for bulk script):
   - Strip type annotations by hand, preserving comments
   - These files import from src/channels/ and src/imessage/ -- verify import paths use .js extensions

3. Post-process src/imessage/ classes (15 private keyword usages):
   - IMessageRpcClient class: Convert private fields to underscore-prefixed
     * `private readonly cliPath` -> `_cliPath`
     * `private readonly dbPath` -> `_dbPath`
     * `private readonly pending` -> `_pending`
     * `private closedResolve` -> `_closedResolve`
     * `private child` -> `_child`
     * `private nextId` -> `_nextId`
     * etc. (15 total private keywords across ~2 classes)
   - Add field declarations at class level
   - Add constructor assignments
   - Update ALL references in class body

4. Post-process src/feishu/ class (5 private keyword usages, 1 class):
   - Same pattern: underscore prefix, field declarations, constructor assignments, reference updates

5. Post-process src/line/ (29 interface declarations -- highest concentration):
   - src/line/types.ts has 10+ interfaces: Convert ALL to JSDoc @typedef blocks
   - src/line/bot.ts has 2 interfaces: Convert to JSDoc @typedef
   - Remaining interfaces scattered across other LINE files: Find and convert each
   - This is the most interface-heavy directory in Phase 4; take care to convert all 29

6. Post-process esbuild artifacts across all directories:
   - Replace `== null` / `!= null` with strict equality
   - Remove unused type imports
   - Add explanatory comments to empty catch blocks

7. Add module-level JSDoc comments to source files

8. Run eslint --fix:
   ```bash
   pnpm eslint --fix 'src/signal/**/*.js' 'src/imessage/**/*.js' 'src/feishu/**/*.js' 'src/line/**/*.js' 'src/test-utils/**/*.js'
   ```

9. Commit this batch before moving to Task 2
  </action>
  <verify>
- `find src/signal/ src/imessage/ src/feishu/ src/line/ src/test-utils/ -name '*.ts' | wc -l` returns 0
- `pnpm eslint 'src/signal/**/*.js' 'src/imessage/**/*.js' 'src/feishu/**/*.js' 'src/line/**/*.js'` reports 0 errors
- LINE types.js contains 10+ JSDoc @typedef blocks
- iMessage class has underscore-prefixed private fields
  </verify>
  <done>
All 94 files across signal, imessage, feishu, line, and test-utils are .js. LINE's 29 interfaces are JSDoc @typedef. iMessage and Feishu classes have proper field declarations. ESLint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert src/web/ (78 files) and src/channels/ (103 files) with type-heavy plugin files</name>
  <files>
    src/web/**/*.ts (43 source + 35 test = 78 files, ~13K lines)
    src/channels/**/*.ts (79 source + 24 test = 103 files, ~11K lines)
    Total: 181 files, ~24K lines

    Special attention -- type-heavy plugin files:
      src/channels/plugins/types.core.ts (331 lines, all types)
      src/channels/plugins/types.adapters.ts (312 lines, all types)
      src/channels/plugins/types.plugin.ts (84 lines, all types)
      src/channels/plugins/types.ts (63 lines, barrel with 1 runtime re-export)
    Security-critical files:
      src/web/auth-store.ts -- WhatsApp Web auth persistence
      src/channels/plugins/pairing.ts -- Channel pairing (identity verification)
      src/channels/command-gating.ts -- Command access control
      src/channels/allowlist-match.ts -- Allowlist enforcement
      src/channels/mention-gating.ts -- Mention-based access gating
  </files>
  <action>
1. FIRST: Manually convert src/channels/plugins/types.*.ts files (4 files, ~790 lines):
   These are almost entirely type definitions. Do NOT use esbuild (output will be empty/malformed).

   a. src/channels/plugins/types.core.js (~331 lines):
      - Read the original .ts file
      - Convert all exported type aliases and type objects to JSDoc @typedef blocks
      - Preserve any runtime code (constants, enums)
      - Delete the .ts file

   b. src/channels/plugins/types.adapters.js (~312 lines):
      - Same treatment: all type exports become JSDoc @typedef
      - Delete the .ts file

   c. src/channels/plugins/types.plugin.js (~84 lines):
      - Same treatment
      - Delete the .ts file

   d. src/channels/plugins/types.js (~63 lines, barrel):
      - This file has `export type { ... } from "..."` re-exports AND one runtime re-export: `export { CHANNEL_MESSAGE_ACTION_NAMES } from "./types.core.js"`
      - After conversion: Keep the runtime re-export. For type re-exports, add JSDoc @see references
      - Verify CHANNEL_MESSAGE_ACTION_NAMES is an actual runtime value in types.core.js (not a type)
      - Delete the .ts file

2. Write a conversion script (convert-channels-batch3.mjs) for the remaining files:
   - Walk src/web/ and src/channels/ recursively
   - SKIP files already converted in step 1 (types.core.js, types.adapters.js, types.plugin.js, types.js in plugins/)
   - Convert all remaining .ts files with esbuild transformSync
   - Write .js output, delete .ts originals

3. Post-process esbuild artifacts:
   - Replace `== null` / `!= null` with strict equality
   - Remove unused type imports
   - 6 `satisfies` in web, 1 in channels: esbuild handles automatically
   - Add explanatory comments to empty catch blocks

4. Add SECURITY: annotations to security-critical files:
   - src/web/auth-store.js -- Document WhatsApp Web credential persistence
   - src/channels/plugins/pairing.js -- Document channel pairing identity verification
   - src/channels/command-gating.js -- Document command access control logic
   - src/channels/allowlist-match.js -- Document allowlist enforcement
   - src/channels/mention-gating.js -- Document mention-based access gating

5. Apply QUAL-03 (lodash): Scan src/channels/ for opportunities:
   - Channel dock/registry often groups or keys channels -- good candidates for groupBy/keyBy
   - Plugin loading may have pick/omit patterns

6. Add module-level JSDoc comments to source files

7. Run eslint --fix:
   ```bash
   pnpm eslint --fix 'src/web/**/*.js' 'src/channels/**/*.js'
   ```

8. Run ALL remaining channel test suites:
   ```bash
   pnpm vitest run src/signal/ src/imessage/ src/feishu/ src/line/ src/web/ src/channels/ --reporter=verbose
   ```

9. Verify zero .ts files in ALL Phase 4 channel directories:
   ```bash
   find src/signal/ src/imessage/ src/feishu/ src/line/ src/web/ src/channels/ src/test-utils/ -name '*.ts' | wc -l
   ```

10. If any tests fail, diagnose and fix:
    - Most likely: type-only imports from channels/plugins/types.js failing at runtime
    - Check: CHANNEL_MESSAGE_ACTION_NAMES runtime re-export preserved
    - Check: imports from other channel dirs (telegram, discord, slack) resolve to .js
    - Check: test-utils imports resolve correctly
  </action>
  <verify>
- `find src/web/ src/channels/ -name '*.ts' | wc -l` returns 0
- `find src/signal/ src/imessage/ src/feishu/ src/line/ src/web/ src/channels/ src/test-utils/ -name '*.ts' | wc -l` returns 0
- `pnpm eslint 'src/web/**/*.js' 'src/channels/**/*.js'` reports 0 errors
- `pnpm vitest run src/signal/ src/imessage/ src/feishu/ src/line/ src/web/ src/channels/` all tests pass
- src/channels/plugins/types.core.js contains JSDoc @typedef blocks (not empty)
- src/channels/plugins/types.js exports CHANNEL_MESSAGE_ACTION_NAMES at runtime
- `grep -rl 'SECURITY:' src/web/ src/channels/ | wc -l` returns 5+
  </verify>
  <done>
All 181 files across web and channels are .js. The 4 type-heavy plugin files are proper JSDoc @typedef modules with runtime re-export preserved. All 275 files from this plan are converted. All remaining channel tests pass. SECURITY annotations on 5 auth/security files. ESLint reports 0 errors.
  </done>
</task>

</tasks>

<verification>
- `find src/signal/ src/imessage/ src/feishu/ src/line/ src/web/ src/channels/ src/test-utils/ -name '*.ts' | wc -l` returns 0
- `pnpm vitest run src/signal/ src/imessage/ src/feishu/ src/line/ src/web/ src/channels/` all tests pass
- `pnpm eslint 'src/signal/**/*.js' 'src/imessage/**/*.js' 'src/feishu/**/*.js' 'src/line/**/*.js' 'src/web/**/*.js' 'src/channels/**/*.js'` 0 errors
- Channel plugin type files are JSDoc @typedef modules (not empty)
- CHANNEL_MESSAGE_ACTION_NAMES runtime re-export preserved in types.js barrel
- LINE has 29 JSDoc @typedef blocks across its files
- iMessage and Feishu classes have underscore-prefixed private fields
- SECURITY annotations on web auth-store, channels pairing, command-gating, allowlist-match, mention-gating
</verification>

<success_criteria>
1. Zero .ts files remain in signal, imessage, feishu, line, web, channels, test-utils
2. All channel tests pass (signal, imessage, feishu, line, web, channels)
3. Channel plugin type files are proper JSDoc @typedef modules
4. CHANNEL_MESSAGE_ACTION_NAMES runtime re-export preserved
5. LINE's 29 interfaces converted to JSDoc @typedef
6. iMessage and Feishu classes have proper private field handling
7. SECURITY annotations on 5 auth/security files
8. ESLint reports 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-and-channels/04-03-SUMMARY.md`
</output>
