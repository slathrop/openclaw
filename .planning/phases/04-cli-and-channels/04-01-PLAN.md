---
phase: 04-cli-and-channels
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/**/*.ts
  - src/commands/**/*.ts
autonomous: true

must_haves:
  truths:
    - "All files in src/cli/ are .js with no remaining .ts files"
    - "All files in src/commands/ are .js with no remaining .ts files"
    - "Type-only files (daemon-cli/types.ts, nodes-cli/types.ts, agent/types.ts, onboard-types.ts, status.types.ts, models/list.types.ts) are JSDoc @typedef modules"
    - "SECURITY annotations on all auth/credential command files"
    - "Running openclaw --help from converted source displays all commands correctly"
    - "All CLI and commands tests pass after conversion"
  artifacts:
    - path: "src/cli/**/*.js"
      provides: "CLI infrastructure converted to JavaScript"
    - path: "src/commands/**/*.js"
      provides: "Command implementations converted to JavaScript"
    - path: "src/cli/daemon-cli/types.js"
      provides: "Daemon CLI type definitions as JSDoc @typedef module"
    - path: "src/cli/nodes-cli/types.js"
      provides: "Nodes CLI type definitions as JSDoc @typedef module"
    - path: "src/commands/agent/types.js"
      provides: "Agent command type definitions as JSDoc @typedef module"
  key_links:
    - from: "src/cli/program/build-program.js"
      to: "src/commands/*.js"
      via: "Commander.js command registration"
      pattern: "import.*from.*commands"
    - from: "src/commands/auth-choice*.js"
      to: "credential storage"
      via: "auth provider selection and credential management"
      pattern: "SECURITY:"
    - from: "src/commands/*.test.js"
      to: "src/commands/*.js"
      via: "test imports of converted source"
      pattern: "import.*from.*\\./"
---

<objective>
Convert all files in src/cli/ (170 files, ~27K lines) and src/commands/ (227 files, ~40K lines) from TypeScript to JavaScript using esbuild bulk conversion.

Purpose: The CLI layer is the user-facing entry point. src/cli/ contains Commander.js program setup, command registration, and CLI infrastructure. src/commands/ contains all command implementations (auth, channels, models, onboarding, status, etc.). These are independent of the channel directories and can convert in parallel with 04-02.
Output: All 397 files converted to .js with SECURITY annotations on 30+ auth files, type-only files as JSDoc @typedef modules, and all tests passing.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cli-and-channels/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert src/cli/ (170 files)</name>
  <files>
    src/cli/**/*.ts (138 source + 32 test files)
    Key subdirectories:
      program/ (18 files), program/message/ (10), gateway-cli/ (7),
      daemon-cli/ (8), nodes-cli/ (12), cron-cli/ (5),
      browser-cli-actions-input/ (6), node-cli/ (2), root-level (~70+)
    Type-only files:
      src/cli/daemon-cli/types.ts (27 lines)
      src/cli/nodes-cli/types.ts (96 lines)
  </files>
  <action>
1. Write a conversion script (convert-cli.mjs) in the project root and run it:
   - Walk src/cli/ recursively, converting all .ts files (excluding .d.ts) with esbuild transformSync
   - Write .js output, delete .ts originals
   - Fix import path extensions (.ts -> .js) in converted files

2. Post-process type-only files manually:
   - src/cli/daemon-cli/types.js: Convert to JSDoc @typedef module (the esbuild output will be empty or near-empty since it was all type exports). Create a proper JSDoc file with @typedef blocks for each exported type
   - src/cli/nodes-cli/types.js: Same treatment -- convert all exported types/interfaces to JSDoc @typedef blocks
   - The single interface in src/cli/ (from research: 1 interface) should be found and converted to JSDoc @typedef

3. Post-process esbuild artifacts across all converted files:
   - Replace `== null` / `!= null` with strict equality (=== null || === undefined / !== null && !== undefined)
   - IMPORTANT: The regex must NOT match `!== null` or `=== null` -- use word boundary or exact pattern `== null` and `!= null` only
   - Remove unused imports left behind after type stripping
   - Add explanatory comments to empty catch blocks

4. Add module-level JSDoc comments to source files (not tests)

5. Run eslint --fix on all converted files:
   ```bash
   pnpm eslint --fix 'src/cli/**/*.js'
   ```

6. Commit this batch before moving to Task 2
  </action>
  <verify>
- `find src/cli/ -name '*.ts' | wc -l` returns 0
- `pnpm eslint 'src/cli/**/*.js'` reports 0 errors
- Type-only files contain JSDoc @typedef (not empty)
  </verify>
  <done>
All 170 files in src/cli/ are .js. Type-only files are proper JSDoc @typedef modules. ESLint passes with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert src/commands/ (227 files)</name>
  <files>
    src/commands/**/*.ts (170 source + 57 test files)
    Key subdirectories:
      agent/ (5), channels/ (8), models/ (14), onboarding/ (5),
      onboard-non-interactive/ (8), status-all/ (7), gateway-status/ (2),
      root-level (~120+), tests (~57)
    Type-only files:
      src/commands/agent/types.ts (77 lines)
      src/commands/onboard-types.ts (90+ lines)
      src/commands/status.types.ts (50+ lines)
      src/commands/models/list.types.ts (25+ lines)
      src/commands/onboarding/types.ts (1-line re-export barrel)
    Security-critical files (~30 files):
      auth-choice*.ts (16 files), auth-token.ts, configure.gateway-auth.ts,
      doctor-auth.ts, doctor-security.ts, oauth-flow.ts, oauth-env.ts,
      chutes-oauth.ts, onboard-auth*.ts (7 files)
  </files>
  <action>
1. Write a conversion script (convert-commands.mjs) in the project root and run it:
   - Walk src/commands/ recursively, converting all .ts files with esbuild transformSync
   - Write .js output, delete .ts originals
   - Fix import path extensions (.ts -> .js) in converted files

2. Post-process type-only files manually:
   - src/commands/agent/types.js: Convert all type exports to JSDoc @typedef blocks
   - src/commands/onboard-types.js: Convert type exports to JSDoc @typedef blocks
   - src/commands/status.types.js: Convert type exports to JSDoc @typedef blocks
   - src/commands/models/list.types.js: Convert type exports to JSDoc @typedef blocks
   - src/commands/onboarding/types.js: This is a one-line re-export barrel (`export * from "../../channels/plugins/onboarding-types.js"`). After type stripping, verify it remains a valid runtime re-export. If the original was `export type *`, it will be empty -- in that case, convert to a JSDoc @see reference module

3. Post-process esbuild artifacts:
   - Replace `== null` / `!= null` with strict equality (same careful regex as Task 1)
   - Remove unused imports after type stripping
   - Add explanatory comments to empty catch blocks
   - Remove `satisfies` remnants if any survive esbuild (15 occurrences in commands per research)

4. Add SECURITY: annotations to all auth/credential files:
   - auth-choice*.js (16 files) -- Document auth provider selection and credential application flow
   - auth-token.js -- Document token management
   - configure.gateway-auth.js -- Document gateway auth config
   - doctor-auth.js, doctor-security.js -- Document auth/security diagnostics
   - oauth-flow.js, oauth-env.js -- Document OAuth token flows
   - chutes-oauth.js -- Document Chutes OAuth flow
   - onboard-auth*.js (7 files) -- Document onboarding credential setup
   Each file: Add `// SECURITY: <brief description of what this file handles>` near the top

5. Apply QUAL-03 (lodash): Scan converted command files for opportunities to introduce lodash-es:
   - Look for verbose `reduce` building objects -> `groupBy`, `keyBy`
   - Look for manual `Object.keys().filter()` -> `pickBy`/`omitBy`
   - Look for manual `Object.fromEntries(Object.entries(...).filter())` -> `pick`/`omit`
   - Be conservative: only replace where lodash meaningfully improves readability
   - Add `import { groupBy } from 'lodash-es'` (or whichever utility) at the top of affected files

6. Add module-level JSDoc comments to source files

7. Run eslint --fix:
   ```bash
   pnpm eslint --fix 'src/commands/**/*.js'
   ```

8. Commit this batch
  </action>
  <verify>
- `find src/commands/ -name '*.ts' | wc -l` returns 0
- `pnpm eslint 'src/commands/**/*.js'` reports 0 errors
- `grep -rl 'SECURITY:' src/commands/ | wc -l` returns 20+ (auth/credential files annotated)
- Type-only files contain JSDoc @typedef blocks
  </verify>
  <done>
All 227 files in src/commands/ are .js. 30+ auth/credential files have SECURITY annotations. Type-only files are JSDoc @typedef modules. Lodash introduced where it improves readability. ESLint passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify CLI and commands test suites pass</name>
  <files>
    (no new files -- verification and fixes only)
  </files>
  <action>
1. Run the CLI test suite:
   ```bash
   pnpm vitest run src/cli/ --reporter=verbose
   ```

2. Run the commands test suite:
   ```bash
   pnpm vitest run src/commands/ --reporter=verbose
   ```

3. If any tests fail, diagnose and fix:
   - Common issue: import paths still reference .ts extensions in test files
   - Common issue: type-only imports left behind causing "is not defined" runtime errors
   - Common issue: test mocks reference old private field names
   - Common issue: `as` cast patterns in tests need conversion to direct property access
   - Common issue: eslint-disable comments stripped by esbuild need restoration

4. Verify zero .ts files remain:
   ```bash
   find src/cli/ -name '*.ts' | wc -l
   find src/commands/ -name '*.ts' | wc -l
   ```
   Both should return 0.

5. Spot-check that openclaw --help works from converted source:
   ```bash
   pnpm openclaw --help
   ```
   This should display all commands correctly.

6. Final ESLint check on everything:
   ```bash
   pnpm eslint 'src/cli/**/*.js' 'src/commands/**/*.js'
   ```
  </action>
  <verify>
- `pnpm vitest run src/cli/` passes all tests
- `pnpm vitest run src/commands/` passes all tests
- `find src/cli/ -name '*.ts' | wc -l` returns 0
- `find src/commands/ -name '*.ts' | wc -l` returns 0
- `pnpm openclaw --help` displays commands correctly
- `pnpm eslint 'src/cli/**/*.js' 'src/commands/**/*.js'` reports 0 errors
  </verify>
  <done>
All CLI and commands tests pass. Zero .ts files remain in src/cli/ and src/commands/. The openclaw CLI works correctly from converted source. ESLint reports 0 errors.
  </done>
</task>

</tasks>

<verification>
- `find src/cli/ src/commands/ -name '*.ts' | wc -l` returns 0
- `pnpm vitest run src/cli/` all tests pass
- `pnpm vitest run src/commands/` all tests pass
- `pnpm openclaw --help` displays all commands
- `pnpm eslint 'src/cli/**/*.js' 'src/commands/**/*.js'` 0 errors
- SECURITY annotations on 30+ auth/credential files
- Type-only files are JSDoc @typedef modules
- Lodash-es introduced where it improves readability
</verification>

<success_criteria>
1. Zero .ts files remain in src/cli/ and src/commands/
2. All CLI and commands tests pass
3. openclaw --help displays all commands correctly
4. SECURITY annotations on all auth/credential files
5. Type-only files are proper JSDoc @typedef modules
6. Lodash-es used where it meaningfully improves readability
7. ESLint reports 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-and-channels/04-01-SUMMARY.md`
</output>
