---
phase: 04-cli-and-channels
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/telegram/**/*.ts
  - src/discord/**/*.ts
  - src/whatsapp/**/*.ts
  - src/slack/**/*.ts
autonomous: true

must_haves:
  truths:
    - "All files in src/telegram/ are .js with no remaining .ts files"
    - "All files in src/discord/ are .js with no remaining .ts files"
    - "All files in src/whatsapp/ are .js with no remaining .ts files"
    - "All files in src/slack/ are .js with no remaining .ts files"
    - "Discord's 13 Carbon-extending classes have explicit field declarations and underscore-prefixed private fields"
    - "Discord's private constructor parameters are expanded to field declarations + constructor assignments"
    - "Telegram's 4 interface declarations are converted to JSDoc @typedef"
    - "SECURITY annotations on Slack auth and channel security files"
    - "All telegram, discord, whatsapp, and slack tests pass after conversion"
  artifacts:
    - path: "src/telegram/**/*.js"
      provides: "Telegram channel implementation converted to JavaScript"
    - path: "src/discord/**/*.js"
      provides: "Discord channel implementation converted to JavaScript"
    - path: "src/whatsapp/**/*.js"
      provides: "WhatsApp channel implementation converted to JavaScript"
    - path: "src/slack/**/*.js"
      provides: "Slack channel implementation converted to JavaScript"
  key_links:
    - from: "src/discord/monitor/listeners.js"
      to: "@buape/carbon MessageCreateListener"
      via: "class extends with private constructor params expanded"
      pattern: "class.*extends.*Listener"
    - from: "src/slack/monitor/auth.js"
      to: "Slack authentication"
      via: "OAuth token management"
      pattern: "SECURITY:"
    - from: "src/telegram/**/*.test.js"
      to: "src/telegram/**/*.js"
      via: "test imports of converted source"
      pattern: "import.*from.*\\./"
---

<objective>
Convert all files in src/telegram/ (87 files, ~20K lines), src/discord/ (66 files, ~13K lines), src/whatsapp/ (2 files, ~152 lines), and src/slack/ (65 files, ~9K lines) from TypeScript to JavaScript.

Purpose: These are the four largest channel implementations. Telegram has the most files and the highest concentration of `as` assertions (514). Discord has 13 classes extending @buape/carbon with private constructor parameters requiring special handling. WhatsApp is trivially small (2 files). Slack is straightforward with one auth-critical file.
Output: All 220 files converted to .js with Discord class fields properly expanded, interfaces as JSDoc @typedef, SECURITY annotations on auth files, and all tests passing.
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cli-and-channels/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert src/telegram/ (87 files), src/whatsapp/ (2 files), and src/slack/ (65 files)</name>
  <files>
    src/telegram/**/*.ts (40 source + 47 test = 87 files, ~20K lines)
    src/whatsapp/**/*.ts (1 source + 1 test = 2 files, ~152 lines)
    src/slack/**/*.ts (43 source + 22 test = 65 files, ~9K lines)
    Total: 154 files, ~29K lines
  </files>
  <action>
1. Convert src/whatsapp/ manually (2 files -- too small for esbuild script):
   - Strip type annotations by hand, preserving all comments
   - These 2 files are trivial (~152 lines total)

2. Write a conversion script (convert-channels-batch1.mjs) in the project root and run it for src/telegram/ and src/slack/:
   - Walk each directory recursively, converting all .ts files with esbuild transformSync
   - Write .js output, delete .ts originals
   - Fix import path extensions (.ts -> .js) in converted files

3. Post-process src/telegram/ specific patterns:
   - 4 interface declarations: Find and convert to JSDoc @typedef blocks
   - 514 `as` assertions: esbuild handles automatically
   - 1 `private` keyword: Find the class, add underscore prefix to private field, update references
   - Replace `== null` / `!= null` with strict equality
   - Remove unused type imports

4. Post-process src/slack/ specific patterns:
   - 5 `satisfies` assertions: esbuild handles automatically
   - Replace `== null` / `!= null` with strict equality
   - Remove unused type imports
   - Add SECURITY: annotation to src/slack/monitor/auth.js (Slack OAuth authentication)

5. Add module-level JSDoc comments to all source files (not tests)

6. Apply QUAL-03 (lodash): Scan for opportunities in telegram and slack:
   - These channel dirs often group messages by type or key by ID -- good candidates for groupBy/keyBy

7. Run eslint --fix:
   ```bash
   pnpm eslint --fix 'src/telegram/**/*.js' 'src/whatsapp/**/*.js' 'src/slack/**/*.js'
   ```

8. Commit this batch before moving to Task 2
  </action>
  <verify>
- `find src/telegram/ src/whatsapp/ src/slack/ -name '*.ts' | wc -l` returns 0
- `pnpm eslint 'src/telegram/**/*.js' 'src/whatsapp/**/*.js' 'src/slack/**/*.js'` reports 0 errors
- Telegram interface declarations are JSDoc @typedef blocks
- Slack auth file has SECURITY annotation
  </verify>
  <done>
All 154 files across telegram, whatsapp, and slack are .js. Telegram interfaces are JSDoc @typedef. Slack auth file has SECURITY annotation. ESLint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert src/discord/ (66 files) with special class handling</name>
  <files>
    src/discord/**/*.ts (44 source + 22 test = 66 files, ~13K lines)
    Special attention files:
      src/discord/monitor/listeners.ts (4 classes with private constructor params)
      src/discord/monitor/exec-approvals.ts (2 classes with private constructor params)
      src/discord/monitor/native-command.ts (2 classes)
      src/discord/commands/*.ts (5+ classes extending Carbon Command/Button)
  </files>
  <action>
1. Write a conversion script (convert-discord.mjs) and run it:
   - Walk src/discord/ recursively, converting all .ts files with esbuild transformSync
   - Write .js output, delete .ts originals

2. CRITICAL: Post-process Discord classes with private constructor parameters:
   esbuild strips `private` keyword but does NOT expand constructor parameter shorthand.
   For each class that had `private` constructor parameters:

   a. src/discord/monitor/listeners.js (4 classes):
      - Add class field declarations with underscore prefix (e.g., `_handler;`)
      - Add constructor assignments (e.g., `this._handler = handler;`)
      - Update ALL references in class body: `this.handler` -> `this._handler`

   b. src/discord/monitor/exec-approvals.js (2 classes):
      - Same pattern: add field declarations, constructor assignments, update references

   c. src/discord/monitor/native-command.js (2 classes):
      - Same pattern

   d. Any other classes in src/discord/commands/ that have private fields:
      - Same pattern

3. Post-process all 13 Carbon-extending classes:
   - Verify class field declarations are present (esbuild strips type annotations from `label: string` leaving `label;` which is correct)
   - Verify `style = ButtonStyle.Secondary` style initializers are preserved (esbuild keeps these)
   - Verify super() calls are preserved in constructors

4. Post-process esbuild artifacts across all files:
   - Replace `== null` / `!= null` with strict equality
   - Remove unused type imports
   - 7 `satisfies` assertions: esbuild handles automatically
   - 178 `as` assertions: esbuild handles automatically
   - Add explanatory comments to empty catch blocks

5. Add module-level JSDoc comments to source files

6. Run eslint --fix:
   ```bash
   pnpm eslint --fix 'src/discord/**/*.js'
   ```

7. Run all four channel test suites to verify:
   ```bash
   pnpm vitest run src/telegram/ src/discord/ src/whatsapp/ src/slack/ --reporter=verbose
   ```

8. Verify zero .ts files in all four directories:
   ```bash
   find src/telegram/ src/discord/ src/whatsapp/ src/slack/ -name '*.ts' | wc -l
   ```

9. If any tests fail, diagnose and fix:
   - Most likely: Discord private field references not updated (this.handler vs this._handler)
   - Check: constructor parameter expansion (field declaration + assignment missing)
   - Check: Carbon class field declarations stripped incorrectly
   - Check: import paths still referencing .ts
  </action>
  <verify>
- `find src/discord/ -name '*.ts' | wc -l` returns 0
- `find src/telegram/ src/discord/ src/whatsapp/ src/slack/ -name '*.ts' | wc -l` returns 0
- `pnpm eslint 'src/discord/**/*.js'` reports 0 errors
- `pnpm vitest run src/telegram/ src/discord/ src/whatsapp/ src/slack/` all tests pass
- Discord listener classes have `_handler` and `_logger` field declarations
  </verify>
  <done>
All 66 Discord files are .js with 13 Carbon-extending classes properly handled. Private constructor parameters expanded to field declarations + assignments. All 220 files across all four channels converted. All channel tests pass. ESLint reports 0 errors.
  </done>
</task>

</tasks>

<verification>
- `find src/telegram/ src/discord/ src/whatsapp/ src/slack/ -name '*.ts' | wc -l` returns 0
- `pnpm vitest run src/telegram/ src/discord/ src/whatsapp/ src/slack/` all tests pass
- `pnpm eslint 'src/telegram/**/*.js' 'src/discord/**/*.js' 'src/whatsapp/**/*.js' 'src/slack/**/*.js'` 0 errors
- Discord classes have proper field declarations and underscore-prefixed private fields
- Telegram interfaces are JSDoc @typedef
- Slack auth has SECURITY annotation
</verification>

<success_criteria>
1. Zero .ts files remain in src/telegram/, src/discord/, src/whatsapp/, src/slack/
2. All channel tests pass (telegram, discord, whatsapp, slack)
3. Discord's 13 Carbon-extending classes compile and function correctly
4. Discord's private constructor parameters properly expanded
5. Telegram interfaces converted to JSDoc @typedef
6. SECURITY annotation on Slack auth file
7. ESLint reports 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-and-channels/04-02-SUMMARY.md`
</output>
