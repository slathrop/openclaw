---
phase: 08-windows-acl-telegram-threading
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/discord/monitor/*.test.js
  - package.json
  - CHANGELOG.md
  - src/discord/monitor/allow-list.js
  - src/discord/monitor/message-handler.process.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Discord allowlist tests register the Discord plugin"
    - "Package version is bumped to 2026.2.4"
    - "Discord owner allowFrom matches resolve correctly"
  artifacts:
    - path: "src/discord/monitor/allow-list.js"
      provides: "Fixed owner allowFrom matching"
      contains: "allowFrom|owner.*match"
    - path: "package.json"
      provides: "Version 2026.2.4"
      contains: "2026.2.4"
  key_links:
    - from: "src/discord/monitor/allow-list.js"
      to: "owner allowFrom config"
      via: "matching logic"
      pattern: "resolveDiscordAllowListMatch|normalizeDiscordAllowList"
---

<objective>
Port Discord allowlist fixes and version bump (SYNC-025 to SYNC-027)

Purpose: Fix Discord owner matching and register Discord plugin in allowlist tests
Output: Three commits matching upstream (SYNC-025, SYNC-026, SYNC-027)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-windows-acl-telegram-threading/08-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run targeted tests: `pnpm vitest run <relevant-test-file>`
5. Commit with --no-verify (wave-level test gate handles full suite): `scripts/committer --no-verify "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-025 - Register Discord plugin in allowlist test</name>
  <files>src/discord/monitor/*.test.js (or similar test file)</files>
  <action>
Port commit bdb90ea4e (test: register discord plugin in allowlist test)

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show bdb90ea4e --stat
   git show bdb90ea4e
   ```

2. Understand the change:
   - The allowlist test needs the Discord channel plugin to be registered for the test fixture
   - Without this, the test may fail with "channel not registered" or "plugin not found"
   - The fix adds a mock or registration call in the test setup

3. Apply the equivalent JavaScript changes:
   - Find the Discord allowlist/monitor test file
   - Add the plugin registration in test setup (beforeAll/beforeEach)
   - Translate TypeScript to JavaScript if needed

4. Run targeted tests:
   ```bash
   pnpm vitest run src/discord/monitor
   ```

5. Commit with matching message:
   ```bash
   scripts/committer --no-verify "test: register discord plugin in allowlist test" <test file>
   ```
  </action>
  <verify>`pnpm vitest run src/discord/monitor` passes, `git log -1` shows correct message</verify>
  <done>Commit bdb90ea4e ported as SYNC-025, Discord plugin registered in allowlist test</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-026 - Bump version to 2026.2.4</name>
  <files>package.json, CHANGELOG.md (or other version-bumped files)</files>
  <action>
Port commit 5031b283a (chore: bump version to 2026.2.4)

1. Read the upstream diff:
   ```bash
   git show 5031b283a --stat
   git show 5031b283a
   ```

2. Understand the change:
   - This is a version bump from 2026.2.3 to 2026.2.4
   - Will update package.json version field
   - May also touch CHANGELOG.md or other version-tracking files

3. Apply the equivalent changes:
   - Update version in package.json from "2026.2.3" to "2026.2.4"
   - Apply any CHANGELOG.md updates shown in the diff
   - Check for other version-bumped files (appcast.xml, etc.)

4. Commit with matching message:
   ```bash
   scripts/committer --no-verify "chore: bump version to 2026.2.4" package.json CHANGELOG.md
   ```

Note: SYNC-039 later resets the appcast to 2026.2.3 (this is intentional -- version was bumped prematurely and appcast was reverted, but package.json stays at 2026.2.4).
  </action>
  <verify>`git log -1` shows correct message, package.json shows version 2026.2.4</verify>
  <done>Commit 5031b283a ported as SYNC-026, version bumped to 2026.2.4</done>
</task>

<task type="auto">
  <name>Task 3: SYNC-027 - Resolve Discord owner allowFrom matches</name>
  <files>src/discord/monitor/allow-list.js, src/discord/monitor/message-handler.process.js, or src/discord/monitor/native-command.js</files>
  <action>
Port commit a4d1af1b1 (fix: resolve discord owner allowFrom matches)

1. Read the upstream diff:
   ```bash
   git show a4d1af1b1 --stat
   git show a4d1af1b1
   ```

2. Understand the change:
   - Fixes how Discord owner allowFrom matches are resolved
   - Current code: `resolveDiscordAllowListMatch()` or `normalizeDiscordAllowList()` in allow-list.js
   - The bug is in how owner-specified allowFrom entries are matched against incoming Discord users
   - May involve slug matching, Discord ID matching, or tag-based matching

3. Apply the equivalent JavaScript changes:
   - Follow the upstream diff precisely
   - The fix likely adjusts candidate building or matching logic in the allowlist resolver
   - Ensure both the normalized form and raw form are checked

4. Run targeted tests:
   ```bash
   pnpm vitest run src/discord/monitor
   ```

5. Commit with matching message:
   ```bash
   scripts/committer --no-verify "fix: resolve discord owner allowFrom matches" <affected files>
   ```
  </action>
  <verify>`pnpm vitest run src/discord/monitor` passes, `git log -1` shows correct message</verify>
  <done>Commit a4d1af1b1 ported as SYNC-027, Discord owner allowFrom matching works correctly</done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm vitest run src/discord/monitor` passes
3. Commits match upstream messages:
   - test: register discord plugin in allowlist test
   - chore: bump version to 2026.2.4
   - fix: resolve discord owner allowFrom matches
4. package.json version is "2026.2.4"
</verification>

<success_criteria>
- 3 commits created matching SYNC-025, SYNC-026, SYNC-027
- Discord allowlist tests pass with registered plugin
- Version bumped to 2026.2.4
- Owner allowFrom matching works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/08-windows-acl-telegram-threading/08-02-SUMMARY.md`
</output>
