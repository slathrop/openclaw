---
phase: 08-windows-acl-telegram-threading
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/telegram/bot-message-context.js
  - src/telegram/bot-message-context.dm-threads.test.js
  - src/channels/session.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Telegram DM topic threadId is preserved in deliveryContext"
    - "DM session recording includes threadId in updateLastRoute"
    - "Test coverage confirms threadId preservation"
  artifacts:
    - path: "src/telegram/bot-message-context.js"
      provides: "threadId in DM updateLastRoute"
      contains: "threadId.*dmThreadId|threadId.*threadSpec"
    - path: "src/telegram/bot-message-context.dm-threads.test.js"
      provides: "DM threadId delivery context test"
      contains: "threadId|deliveryContext"
  key_links:
    - from: "src/telegram/bot-message-context.js"
      to: "src/channels/session.js"
      via: "recordInboundSession with updateLastRoute containing threadId"
      pattern: "updateLastRoute.*threadId"
---

<objective>
Port Telegram DM topic threadId preservation (SYNC-028 to SYNC-030)

Purpose: Fix the bug where DM topic threadId is lost during session recording, causing replies to go to the wrong topic
Output: Three commits matching upstream (SYNC-028, SYNC-029, SYNC-030)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-windows-acl-telegram-threading/08-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run targeted tests: `pnpm vitest run <relevant-test-file>`
5. Commit with --no-verify (wave-level test gate handles full suite): `scripts/committer --no-verify "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-028 - Preserve DM topic threadId in deliveryContext</name>
  <files>src/telegram/bot-message-context.js, possibly src/channels/session.js</files>
  <action>
Port commit 8860d2ed7 (fix(telegram): preserve DM topic threadId in deliveryContext)

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show 8860d2ed7 --stat
   git show 8860d2ed7
   ```

2. Understand the bug (from research):
   - In `bot-message-context.js` around line 536-541, the `updateLastRoute` for DMs does NOT pass `threadId`
   - Current code:
     ```javascript
     updateLastRoute: !isGroup ? {
       sessionKey: route.mainSessionKey,
       channel: 'telegram',
       to: String(chatId),
       accountId: route.accountId
       // threadId is MISSING
     } : void 0,
     ```
   - Fix: Add `threadId: dmThreadId` (or `threadSpec.id`) to the updateLastRoute object
   - The threadId needs to flow through `recordInboundSession()` into the delivery context

3. Apply the equivalent JavaScript changes:
   - Add the missing threadId field to the updateLastRoute object for DM sessions
   - The variable name will be visible in the upstream diff (likely `dmThreadId` or `threadSpec.id`)
   - May also touch `normalizeDeliveryContext()` in `src/utils/delivery-context.js` if upstream does

4. Run targeted tests:
   ```bash
   pnpm vitest run src/telegram/
   ```

5. Commit with matching message:
   ```bash
   scripts/committer --no-verify "fix(telegram): preserve DM topic threadId in deliveryContext" <affected files>
   ```
  </action>
  <verify>`pnpm vitest run src/telegram/` passes, `git log -1` shows correct message</verify>
  <done>Commit 8860d2ed7 ported as SYNC-028, DM topic threadId preserved in deliveryContext</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-029 - Add DM topic threadId deliveryContext test</name>
  <files>src/telegram/bot-message-context.dm-threads.test.js (or similar test file)</files>
  <action>
Port commit c0b267a03 (test(telegram): add DM topic threadId deliveryContext test)

1. Read the upstream diff:
   ```bash
   git show c0b267a03 --stat
   git show c0b267a03
   ```

2. Understand the change:
   - Creates or extends a test file to verify the SYNC-028 fix
   - Tests that when a DM message arrives with a topic threadId, the threadId is preserved
   - Test likely: creates a mock Telegram message with message_thread_id, runs it through context builder, asserts threadId in deliveryContext

3. Apply the equivalent JavaScript changes:
   - Create or extend the test file (translate TypeScript to JavaScript)
   - Strip type annotations, keep test logic
   - Use vitest patterns (describe, it, expect, vi)
   - Mock the Telegram message object with message_thread_id field

4. Run the new/updated tests:
   ```bash
   pnpm vitest run src/telegram/
   ```

5. Commit with matching message:
   ```bash
   scripts/committer --no-verify "test(telegram): add DM topic threadId deliveryContext test" <test file>
   ```
  </action>
  <verify>`pnpm vitest run src/telegram/` passes, `git log -1` shows correct message</verify>
  <done>Commit c0b267a03 ported as SYNC-029, DM threadId delivery context test passes</done>
</task>

<task type="auto">
  <name>Task 3: SYNC-030 - Preserve telegram DM topic threadId (PR merge)</name>
  <files>Depends on upstream diff -- may be empty</files>
  <action>
Port commit f2c5c847b (fix: preserve telegram DM topic threadId (#9039))

1. Read the upstream diff:
   ```bash
   git show f2c5c847b --stat
   git show f2c5c847b
   ```

2. Determine if this is a merge/squash commit:
   - PR #9039 title matches the combined work of SYNC-028 + SYNC-029
   - If the diff is empty relative to what SYNC-028/029 already applied, this is a merge commit
   - If it contains additional changes beyond 028+029, apply them

3. Handle based on findings:
   - **If empty/merge commit:** Create an empty tracking commit per Phase 7 pattern:
     ```bash
     git commit --allow-empty --no-verify -m "fix: preserve telegram DM topic threadId (#9039)"
     ```
   - **If has additional changes:** Apply the additional changes, then commit normally:
     ```bash
     scripts/committer --no-verify "fix: preserve telegram DM topic threadId (#9039)" <affected files>
     ```

4. Verify commit exists:
   ```bash
   git log -1 --oneline
   ```
  </action>
  <verify>`git log -1` shows correct message</verify>
  <done>Commit f2c5c847b ported as SYNC-030, either as additional changes or empty tracking commit</done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm vitest run src/telegram/` passes
3. Commits match upstream messages:
   - fix(telegram): preserve DM topic threadId in deliveryContext
   - test(telegram): add DM topic threadId deliveryContext test
   - fix: preserve telegram DM topic threadId (#9039)
4. In bot-message-context.js, the DM updateLastRoute object includes threadId
</verification>

<success_criteria>
- 3 commits created matching SYNC-028, SYNC-029, SYNC-030
- Telegram DM threadId is preserved in delivery context
- Test coverage confirms the fix
- No regressions in Telegram handling
</success_criteria>

<output>
After completion, create `.planning/phases/08-windows-acl-telegram-threading/08-03-SUMMARY.md`
</output>
