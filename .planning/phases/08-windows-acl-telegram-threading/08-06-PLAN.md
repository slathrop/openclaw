---
phase: 08-windows-acl-telegram-threading
plan: 06
type: execute
wave: 3
depends_on: ["08-03", "08-04"]
files_modified:
  - src/telegram/bot-handlers.js
  - src/telegram/bot-message-context.js
  - src/telegram/send.js
  - docs/onboarding/**
  - docs/docs.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Telegram forum topic binding receives parentPeer"
    - "Forum topic threadId is auto-injected into outgoing messages"
    - "CLI onboarding docs are streamlined"
  artifacts:
    - path: "src/telegram/bot-handlers.js"
      provides: "parentPeer for forum topic binding"
      contains: "parentPeer|forumTopic"
    - path: "src/telegram/send.js"
      provides: "Auto-injected forum topic threadId"
      contains: "message_thread_id|threadId"
  key_links:
    - from: "src/telegram/bot-handlers.js"
      to: "src/telegram/bot-message-context.js"
      via: "parentPeer passed for forum topic binding"
      pattern: "parentPeer"
    - from: "src/telegram/send.js"
      to: "outgoing message"
      via: "message_thread_id injection from delivery context"
      pattern: "message_thread_id|threadId"
---

<objective>
Port Telegram forum topic threading and final onboarding docs (SYNC-040 to SYNC-042)

Purpose: Complete Telegram threading support with forum topic binding and auto-injection, plus final docs cleanup
Output: Three commits matching upstream (SYNC-040, SYNC-041, SYNC-042)
</objective>

<execution_context>
@/Users/slathrop/.claude/get-shit-done/workflows/execute-plan.md
@/Users/slathrop/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-windows-acl-telegram-threading/08-RESEARCH.md
</context>

<upstream_workflow>
For each commit in this plan:
1. Fetch and show upstream diff: `git fetch upstream && git show <hash> --stat && git show <hash>`
2. Understand the change (read PR if needed: `gh pr view <number> --repo openclaw/openclaw`)
3. Apply equivalent JavaScript change to local files
4. Run targeted tests: `pnpm vitest run <relevant-test-file>`
5. Commit with --no-verify (wave-level test gate handles full suite): `scripts/committer --no-verify "<message>" <files...>`
</upstream_workflow>

<tasks>

<task type="auto">
  <name>Task 1: SYNC-040 - Pass parentPeer for forum topic binding</name>
  <files>src/telegram/bot-handlers.js, src/telegram/bot-message-context.js</files>
  <action>
Port commit ddedb56c0 (fix(telegram): pass parentPeer for forum topic binding (#9789))

1. Read the upstream diff:
   ```bash
   git fetch upstream
   git show ddedb56c0 --stat
   git show ddedb56c0
   ```

2. Understand the change:
   - Forum topics in Telegram supergroups need to pass parent chat peer info for topic-bound agents
   - The `parentPeer` concept exists in Discord (`src/discord/monitor/message-handler.preflight.js`)
   - This adds the equivalent to Telegram: passing parentPeer when binding to a forum topic
   - The change likely modifies how bot-handlers.js or bot-message-context.js handles forum topic messages

3. Apply the equivalent JavaScript changes:
   - Follow the upstream diff precisely
   - Translate TypeScript to JavaScript (strip types, keep logic)
   - The parentPeer typically contains the chat/group ID that owns the forum topic
   - Ensure the parentPeer flows through to agent binding or session key resolution

4. Run targeted tests:
   ```bash
   pnpm vitest run src/telegram/
   ```

5. Commit with matching message:
   ```bash
   scripts/committer --no-verify "fix(telegram): pass parentPeer for forum topic binding (#9789)" <affected files>
   ```
  </action>
  <verify>`pnpm vitest run src/telegram/` passes, `git log -1` shows correct message</verify>
  <done>Commit ddedb56c0 ported as SYNC-040, forum topic binding receives parentPeer</done>
</task>

<task type="auto">
  <name>Task 2: SYNC-041 - Streamline CLI onboarding docs</name>
  <files>docs/onboarding/** or docs/cli/**</files>
  <action>
Port commit 9e0030b75 (docs(onboarding): streamline CLI onboarding docs (#9830))

1. Read the upstream diff:
   ```bash
   git show 9e0030b75 --stat
   git show 9e0030b75
   ```

2. Apply the documentation changes:
   - This streamlines the CLI-related onboarding documentation
   - May modify existing pages or restructure content
   - Update docs.json navigation if pages are added/removed/renamed
   - Docs content must be generic (per CLAUDE.md)
   - Internal links: root-relative, no .md/.mdx extension

3. Commit:
   ```bash
   scripts/committer --no-verify "docs(onboarding): streamline CLI onboarding docs (#9830)" <affected files>
   ```
  </action>
  <verify>`git log -1` shows correct message</verify>
  <done>Commit 9e0030b75 ported as SYNC-041, CLI onboarding docs streamlined</done>
</task>

<task type="auto">
  <name>Task 3: SYNC-042 - Auto-inject Telegram forum topic threadId</name>
  <files>src/telegram/send.js, src/telegram/bot-message-context.js, or src/telegram/bot-handlers.js</files>
  <action>
Port commit eef247b7a (fix: auto-inject Telegram forum topic threadId)

1. Read the upstream diff:
   ```bash
   git show eef247b7a --stat
   git show eef247b7a
   ```

2. Understand the change:
   - When a message arrives from a Telegram forum topic, replies must include the `message_thread_id`
   - This commit auto-injects the threadId so replies go to the correct forum topic
   - The change likely modifies the send path or message dispatch to populate `message_thread_id` from the delivery context
   - This builds on SYNC-028 (DM threadId preservation) and SYNC-040 (forum parentPeer)

3. Apply the equivalent JavaScript changes:
   - Follow the upstream diff precisely
   - The fix likely adds logic in the send/delivery path:
     - Check if delivery context has a threadId
     - If so, include `message_thread_id` in the Telegram API call
   - May modify `src/telegram/send.js` to read threadId from context

4. Run targeted tests:
   ```bash
   pnpm vitest run src/telegram/
   ```

5. Commit with matching message:
   ```bash
   scripts/committer --no-verify "fix: auto-inject Telegram forum topic threadId" <affected files>
   ```
  </action>
  <verify>`pnpm vitest run src/telegram/` passes, `git log -1` shows correct message</verify>
  <done>Commit eef247b7a ported as SYNC-042, forum topic threadId auto-injected into outgoing messages</done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. `git log -3 --oneline` shows three commits in correct order
2. `pnpm vitest run src/telegram/` passes
3. Commits match upstream messages:
   - fix(telegram): pass parentPeer for forum topic binding (#9789)
   - docs(onboarding): streamline CLI onboarding docs (#9830)
   - fix: auto-inject Telegram forum topic threadId
4. Forum topic threadId flows from incoming message through to outgoing reply
</verification>

<success_criteria>
- 3 commits created matching SYNC-040, SYNC-041, SYNC-042
- Forum topic binding has parentPeer context
- Forum topic threadId is auto-injected into replies
- Onboarding docs are streamlined
- No regressions in Telegram handling
</success_criteria>

<output>
After completion, create `.planning/phases/08-windows-acl-telegram-threading/08-06-SUMMARY.md`
</output>
