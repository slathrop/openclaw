 
import fs from 'node:fs';
import path from 'node:path';
import {
  DEFAULT_OPENCLAW_BROWSER_COLOR,
  DEFAULT_OPENCLAW_BROWSER_PROFILE_NAME
} from './constants.js';
function decoratedMarkerPath(userDataDir) {
  return path.join(userDataDir, '.openclaw-profile-decorated');
}
function safeReadJson(filePath) {
  try {
    if (!fs.existsSync(filePath)) {
      return null;
    }
    const raw = fs.readFileSync(filePath, 'utf-8');
    const parsed = JSON.parse(raw);
    if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
      return null;
    }
    return parsed;
  } catch {
    return null;
  }
}
function safeWriteJson(filePath, data) {
  fs.mkdirSync(path.dirname(filePath), { recursive: true });
  fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
}
function setDeep(obj, keys, value) {
  let node = obj;
  for (const key of keys.slice(0, -1)) {
    const next = node[key];
    if (typeof next !== 'object' || next === null || Array.isArray(next)) {
      node[key] = {};
    }
    node = node[key];
  }
  node[keys[keys.length - 1] ?? ''] = value;
}
function parseHexRgbToSignedArgbInt(hex) {
  const cleaned = hex.trim().replace(/^#/, '');
  if (!/^[0-9a-fA-F]{6}$/.test(cleaned)) {
    return null;
  }
  const rgb = Number.parseInt(cleaned, 16);
  const argbUnsigned = 255 << 24 | rgb;
  return argbUnsigned > 2147483647 ? argbUnsigned - 4294967296 : argbUnsigned;
}
function isProfileDecorated(userDataDir, desiredName, desiredColorHex) {
  const desiredColorInt = parseHexRgbToSignedArgbInt(desiredColorHex);
  const localStatePath = path.join(userDataDir, 'Local State');
  const preferencesPath = path.join(userDataDir, 'Default', 'Preferences');
  const localState = safeReadJson(localStatePath);
  const profile = localState?.profile;
  const infoCache = typeof profile === 'object' && profile !== null && !Array.isArray(profile) ? profile.info_cache : null;
  const info = typeof infoCache === 'object' && infoCache !== null && !Array.isArray(infoCache) && typeof infoCache.Default === 'object' && infoCache.Default !== null && !Array.isArray(infoCache.Default) ? infoCache.Default : null;
  const prefs = safeReadJson(preferencesPath);
  const browserTheme = (() => {
    const browser = prefs?.browser;
    const theme = typeof browser === 'object' && browser !== null && !Array.isArray(browser) ? browser.theme : null;
    return typeof theme === 'object' && theme !== null && !Array.isArray(theme) ? theme : null;
  })();
  const autogeneratedTheme = (() => {
    const autogenerated = prefs?.autogenerated;
    const theme = typeof autogenerated === 'object' && autogenerated !== null && !Array.isArray(autogenerated) ? autogenerated.theme : null;
    return typeof theme === 'object' && theme !== null && !Array.isArray(theme) ? theme : null;
  })();
  const nameOk = typeof info?.name === 'string' ? info.name === desiredName : true;
  if (desiredColorInt === null || desiredColorInt === undefined) {
    return nameOk;
  }
  const localSeedOk = typeof info?.profile_color_seed === 'number' ? info.profile_color_seed === desiredColorInt : false;
  const prefOk = typeof browserTheme?.user_color2 === 'number' && browserTheme.user_color2 === desiredColorInt || typeof autogeneratedTheme?.color === 'number' && autogeneratedTheme.color === desiredColorInt;
  return nameOk && localSeedOk && prefOk;
}
function decorateOpenClawProfile(userDataDir, opts) {
  const desiredName = opts?.name ?? DEFAULT_OPENCLAW_BROWSER_PROFILE_NAME;
  const desiredColor = (opts?.color ?? DEFAULT_OPENCLAW_BROWSER_COLOR).toUpperCase();
  const desiredColorInt = parseHexRgbToSignedArgbInt(desiredColor);
  const localStatePath = path.join(userDataDir, 'Local State');
  const preferencesPath = path.join(userDataDir, 'Default', 'Preferences');
  const localState = safeReadJson(localStatePath) ?? {};
  setDeep(localState, ['profile', 'info_cache', 'Default', 'name'], desiredName);
  setDeep(localState, ['profile', 'info_cache', 'Default', 'shortcut_name'], desiredName);
  setDeep(localState, ['profile', 'info_cache', 'Default', 'user_name'], desiredName);
  setDeep(localState, ['profile', 'info_cache', 'Default', 'profile_color'], desiredColor);
  setDeep(localState, ['profile', 'info_cache', 'Default', 'user_color'], desiredColor);
  if (desiredColorInt !== null && desiredColorInt !== undefined) {
    setDeep(
      localState,
      ['profile', 'info_cache', 'Default', 'profile_color_seed'],
      desiredColorInt
    );
    setDeep(
      localState,
      ['profile', 'info_cache', 'Default', 'profile_highlight_color'],
      desiredColorInt
    );
    setDeep(
      localState,
      ['profile', 'info_cache', 'Default', 'default_avatar_fill_color'],
      desiredColorInt
    );
    setDeep(
      localState,
      ['profile', 'info_cache', 'Default', 'default_avatar_stroke_color'],
      desiredColorInt
    );
  }
  safeWriteJson(localStatePath, localState);
  const prefs = safeReadJson(preferencesPath) ?? {};
  setDeep(prefs, ['profile', 'name'], desiredName);
  setDeep(prefs, ['profile', 'profile_color'], desiredColor);
  setDeep(prefs, ['profile', 'user_color'], desiredColor);
  if (desiredColorInt !== null && desiredColorInt !== undefined) {
    setDeep(prefs, ['autogenerated', 'theme', 'color'], desiredColorInt);
    setDeep(prefs, ['browser', 'theme', 'user_color2'], desiredColorInt);
  }
  safeWriteJson(preferencesPath, prefs);
  try {
    fs.writeFileSync(decoratedMarkerPath(userDataDir), `${Date.now()}
`, 'utf-8');
  } catch {
    // Intentionally ignored
  }
}
function ensureProfileCleanExit(userDataDir) {
  const preferencesPath = path.join(userDataDir, 'Default', 'Preferences');
  const prefs = safeReadJson(preferencesPath) ?? {};
  setDeep(prefs, ['exit_type'], 'Normal');
  setDeep(prefs, ['exited_cleanly'], true);
  safeWriteJson(preferencesPath, prefs);
}
export {
  decorateOpenClawProfile,
  ensureProfileCleanExit,
  isProfileDecorated
};
